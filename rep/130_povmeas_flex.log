-------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA/rep/130_povmeas_flex.log
  log type:  text
 opened on:  17 May 2013, 14:58:14

. clear

. set more off

. #delimit ;
delimiter now ;
. **************************************************************************
> * 130_povmeas_flex.do           (start)
> *
> * Purpose:
> * Initial poverty measures calculation for flexible basket. (Before any iteration)
> **************************************************************************;
. *CA modified to add work\hhdata.dta for bootstrap;
. /*
> This file uses:
>         in\foodshr96.dta
>         work\povline_f_flex.dta
>         work\consump_nom.dta
>         work\hhdata.dta
>         work/temp_index_reg_tpi.dta
> 
> This file creates:
>         work\foodshr96.dta
>         work\povmeas.dta
>         work\povlines.dta
>         work/cons_real.dta
> */
> 
> 
> 
> **************************************************************************;
. * Bring in data file with nominal consumption per capita, and deflate it
> * by temporal price index.
> **************************************************************************;
. use "$path/work/hhdata.dta", clear;

.         keep hhid strata reg_tpi spdomain news rural survmon survquar;

.         tab reg_tpi, miss;

    reg_tpi |      Freq.     Percent        Cum.
------------+-----------------------------------
    central |      1,986       29.31       29.31
    eastern |      1,406       20.75       50.07
   northern |      1,956       28.87       78.94
    western |      1,427       21.06      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         tab survquar, miss;

 Sequential |
     Survey |
    Quarter |
    May-Jun |
      09=1) |      Freq.     Percent        Cum.
------------+-----------------------------------
 May-Jul 09 |      1,749       25.82       25.82
Sept-Oct 09 |      1,731       25.55       51.37
Nov09-Jan10 |      1,458       21.52       72.89
 Feb-Apr 10 |      1,837       27.11      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         keep hhid spdomain reg_tpi survquar;

.         sort hhid;

.         tempfile spdomainreg_tpi;

. save `spdomainreg_tpi', replace;
(note: file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000001.tmp not found)
file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000001.tmp saved

. use "$path/work/conpc.dta", clear;

. *use "$path/work/consump_nom.dta", clear;
. *CA modified to merge in work\hhdata.dta for bootstrap;
.     sort hhid;

.     merge hhid using "$path\work\hhdata.dta";

.     tab _m;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.     drop _m;

.         keep hhid hhweight hhsize cons_pc_nom ;

.         sort hhid;

.         merge hhid using `spdomainreg_tpi';
(label REG_TPI already defined)
(label spdomain_original already defined)
(label lsurvquar already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

.         sort reg_tpi survquar;

.         merge reg_tpi survquar using "$path/work/temp_index_reg_tpi.dta";
variables reg_tpi survquar do not uniquely identify observations in the master data
(label lsurvquar already defined)
(label REG_TPI already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

.         sort hhid;

.         merge hhid using "$path/work/conpc.dta";

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

.         gen food_pc_tpi  = food_pc_nom /tpi_trim;

.         lab var food_pc_tpi "Temp-adjusted per capita food consumption/day";

.                 gen cons_pc_tpi = food_pc_tpi + nf_pc_nom;

.         lab var cons_pc_tpi "Temp adjusted total consumption/day";

.         gen one=1;

. * TPI deflated per capita consumption ;
.         tempfile contpi;

. save `contpi', replace;
(note: file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000002.tmp not found)
file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000002.tmp saved

. **************************************************************************
> * Calculate non-food expenditure for HH around the food poverty line
> *
> * Develop a discrete triangular weighted distribution. This gives a
> * weight of  1 to HH at +/- 18-20% from food poverty line, and
> * weight of  2 to HH at +/- 16-18% from food poverty line, and ...
> * weight of 10 to HH at +/-  0- 2% from food poverty line.
> * This weight is called triwt below.
> **************************************************************************;
. use `contpi';

.         sort spdomain;

.         merge spdomain using "$path/work/povline_food_flex.dta";
variable spdomain does not uniquely identify observations in the master data
(label spdomain_original already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

. gen     triwt = 0 ;

. replace triwt = 11 - round(50*abs(cons_pc_tpi/povline_f_flex-1)+0.5)
>                 if abs(cons_pc_tpi/povline_f_flex-1)<=0.2;
(332 real changes made)

.                                         * Nearness to poverty line and population weights
>  ;
.         gen tripopwt=triwt*hhweight*hhsize;

.         preserve;

.                 collapse (mean) nf_pc_nom [aw=tripopwt] ,
>                         by(spdomain);

.                                         rename nf_pc_nom povline_na_flex;

.                 lab var povline_na_flex "Nonfood poverty line. Flexible bundle";

.                                 tempfile znf;

.                 sort spdomain;

.                 save `znf', replace;
(note: file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000004.tmp not found)
file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000004.tmp saved

.                 tab spdomain;

     spdomain |      Freq.     Percent        Cum.
--------------+-----------------------------------
Central rural |          1       20.00       20.00
Central urban |          1       20.00       40.00
      Eastern |          1       20.00       60.00
     Northern |          1       20.00       80.00
      Western |          1       20.00      100.00
--------------+-----------------------------------
        Total |          5      100.00

.         restore;

.         sort spdomain;

.         merge spdomain using `znf';
variable spdomain does not uniquely identify observations in the master data
(label spdomain_original already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

. **************************************************************************;
. * Poverty line is the sum of the food and non-food poverty lines
> **************************************************************************;
.         gen povline_flex=povline_f_flex + povline_na_flex;

.         lab var povline_flex "Poverty line. Flexible bundle";

.         sort spdomain;

. save "$path\work\povlines.dta", replace;
file C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA\work\povlines.dta saved

. **************************************************************************;
. * Create spatial price index, based on the total poverty line, with
> * adjustment so that mean (and total) nominal consumption equals
> * mean (and total) spatially deflated consumption.
> *
> * Choose arbitrary strata to be the base at first: we just use the first stratum.
> **************************************************************************;
. use `contpi';

.         sort spdomain;

.         merge spdomain using "$path\work\povlines.dta";
variable spdomain does not uniquely identify observations in the master data
variable spdomain does not uniquely identify observations in
    C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA\work\povlines.dta
(label REG_TPI already defined)
(label spdomain_original already defined)
(label lsurvquar already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

.         * Real consumption pc, temporally deflated ;
.         gen cr= cons_pc_tpi ;

.         * Poverty line;
.         gen linpob=povline_flex;

.         *qui sum linpob if spdomain==1, meanonly;
.         sum linpob if spdomain==3, meanonly;

.         global spi_base=r(mean);

.         * Spatial price index ;
.         gen spi=linpob/$spi_base;

.         * Real consumption pc, temporally and spatially deflated ;
.         gen cr2=cr/spi;

.         qui sum cr [aw=hhweight*hhsize];

.         global sumcr=r(sum);

.         qui sum cr2 [aw=hhweight*hhsize];

.         global sumcr2=r(sum);

.         replace spi=spi*$sumcr2/$sumcr;
(6775 real changes made)

.         gen linpobr=linpob/spi;

.         replace cr2=cr/spi;
(6775 real changes made)

.         sum cr cr2 linpob linpobr [aw=hhweight*hhsize];

    Variable |     Obs      Weight        Mean   Std. Dev.       Min        Max
-------------+-----------------------------------------------------------------
          cr |    6775   200636622    9416.597   395671.8   82.64046   8.12e+07
         cr2 |    6775   200636622    9416.597   305912.3   84.59628   6.26e+07
      linpob |    6775   200636622    972.5242   203.3228   768.5243    1507.71
     linpobr |    6775   200636622     1162.09   .0000451    1162.09   1162.091

.         lab var cr      "Temporally-adjusted cons pc";

.         lab var cr2     "Spatially & temporally adjusted cons pc";

.         lab var linpob  "Poverty line";

.         lab var linpobr "Real poverty line";

.         lab var spi     "Spatial price index";

. **************************************************************************
> * calculate poverty measures with the flexible food bundle
> **************************************************************************;
.         gen h = 100     if cr <=(linpob);
(5940 missing values generated)

.         replace  h = 0 if cr > (linpob);
(5940 real changes made)

.                         gen             pg      = ((linpob - cr )/linpob) *100;

.         replace         pg      = 0             if h==0;
(5940 real changes made)

.         gen             spg     = ((( linpob - cr )/ linpob )^2)*100;

.         replace         spg     = 0             if h==0;
(5940 real changes made)

.         gen h_flex=h;

.         gen pg_flex=pg;

.         gen spg_flex=spg;

.         lab var h_flex   "Poverty headcount. Flex bundle";

.         lab var pg_flex  "Poverty gap. Flex bundle";

.         lab var spg_flex "Squared poverty gap. Flex bundle";

.         sort hhid;

.         merge hhid using "$path\work\hhdata.dta";
(label lsurvquar already defined)
(label spdomain_original already defined)
(label REG_TPI already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop if _merge~=3;
(0 observations deleted)

.         drop _merge;

.         gen popwt=hhsize*hhweight;

.                 * Stata 10.1 syntax ;
.         svyset , clear;

.         svyset [pweight=popwt] , str(strata) psu(psu);

      pweight: popwt
          VCE: linearized
  Single unit: missing
     Strata 1: strata
         SU 1: psu
        FPC 1: <zero>

.         svy: mean h_flex pg_flex spg_flex;
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10       Number of obs    =       6775
Number of PSUs   =     711       Population size  =  200636622
                                 Design df        =        701

--------------------------------------------------------------
             |             Linearized
             |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
      h_flex |   10.64383   .7183087      9.233536    12.05412
     pg_flex |   2.847239   .2301319      2.395409     3.29907
    spg_flex |   1.160688   .1236742      .9178722    1.403505
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(rural);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10       Number of obs    =       6775
Number of PSUs   =     711       Population size  =  200636622
                                 Design df        =        701

        Urban: rural = Urban
        Rural: rural = Rural

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
       Urban |   3.415127   1.014682      1.422946    5.407308
       Rural |   11.74798   .7975071      10.18219    13.31377
-------------+------------------------------------------------
pg_flex      |
       Urban |   .7949736   .2336944      .3361487    1.253798
       Rural |   3.160712    .260382       2.64949    3.671934
-------------+------------------------------------------------
spg_flex     |
       Urban |    .247158   .0745631      .1007643    .3935518
       Rural |   1.300225   .1414875      1.022435    1.578015
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(news);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10       Number of obs    =       6775
Number of PSUs   =     711       Population size  =  200636622
                                 Design df        =        701

            1: news = 1
            2: news = 2
            3: news = 3
            4: news = 4

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
           1 |    5.85527   1.056141      3.781691    7.928848
           2 |   7.564058   1.320862      4.970739    10.15738
           3 |   20.05523   1.819486      16.48294    23.62753
           4 |   11.88273    1.47859      8.979738    14.78573
-------------+------------------------------------------------
pg_flex      |
           1 |   1.242779   .2633442      .7257408    1.759817
           2 |   1.383358   .2140039      .9631926    1.803523
           3 |   7.022313   .8624984      5.328923    8.715703
           4 |    2.99275   .5015668      2.007997    3.977503
-------------+------------------------------------------------
spg_flex     |
           1 |   .3899434   .0994254      .1947361    .5851507
           2 |   .3536218   .0579814      .2397838    .4674599
           3 |   3.405928    .490854      2.442208    4.369648
           4 |   1.170894   .2908952      .5997633    1.742024
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(reg_tpi);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10       Number of obs    =       6775
Number of PSUs   =     711       Population size  =  200636622
                                 Design df        =        701

      central: reg_tpi = central
      eastern: reg_tpi = eastern
     northern: reg_tpi = northern
      western: reg_tpi = western

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
     central |    5.85527   1.056141      3.781691    7.928848
     eastern |   7.564058   1.320862      4.970739    10.15738
    northern |   20.05523   1.819486      16.48294    23.62753
     western |   11.88273    1.47859      8.979738    14.78573
-------------+------------------------------------------------
pg_flex      |
     central |   1.242779   .2633442      .7257408    1.759817
     eastern |   1.383358   .2140039      .9631926    1.803523
    northern |   7.022313   .8624984      5.328923    8.715703
     western |    2.99275   .5015668      2.007997    3.977503
-------------+------------------------------------------------
spg_flex     |
     central |   .3899434   .0994254      .1947361    .5851507
     eastern |   .3536218   .0579814      .2397838    .4674599
    northern |   3.405928    .490854      2.442208    4.369648
     western |   1.170894   .2908952      .5997633    1.742024
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(strata);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10       Number of obs    =       6775
Number of PSUs   =     711       Population size  =  200636622
                                 Design df        =        701

      KAMPALA: strata = KAMPALA
    _subpop_2: strata = CENTRAL 1
    _subpop_3: strata = CENTRAL 2
    _subpop_4: strata = EAST CENTRAL
      EASTERN: strata = EASTERN
    _subpop_6: strata = MID-NOTHERN
    _subpop_7: strata = NORTH-EAST
    _subpop_8: strata = WEST-NILE
    _subpop_9: strata = MID-WESTERN
   _subpop_10: strata = SOUTH-WESTERN

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
     KAMPALA |   4.874973   2.339743        .28123    9.468715
   _subpop_2 |   4.815216    1.42435      2.018713    7.611719
   _subpop_3 |   7.336596   1.868566      3.667939    11.00525
   _subpop_4 |   5.450948   1.171204       3.15146    7.750436
     EASTERN |    9.28854   2.149875      5.067575     13.5095
   _subpop_6 |    11.3821   2.080189      7.297956    15.46625
   _subpop_7 |   69.04124   6.131256      57.00341    81.07906
   _subpop_8 |   9.436877   1.618277      6.259627    12.61413
   _subpop_9 |   15.13404   2.510779       10.2045    20.06359
  _subpop_10 |   8.436528    1.29171      5.900445    10.97261
-------------+------------------------------------------------
pg_flex      |
     KAMPALA |   1.156125   .5364251      .1029326    2.209317
   _subpop_2 |   1.054924   .4136337      .2428149    1.867033
   _subpop_3 |   1.472113   .4259365      .6358493    2.308377
   _subpop_4 |   1.078487   .2343785      .6183188    1.538655
     EASTERN |   1.632159   .3314862      .9813346    2.282984
   _subpop_6 |   3.762759   .8867794      2.021697     5.50382
   _subpop_7 |   28.09699   3.531683      21.16305    35.03094
   _subpop_8 |   1.754495   .4095893      .9503265    2.558664
   _subpop_9 |   4.321979   .8772222      2.599681    6.044276
  _subpop_10 |   1.583842   .3230622      .9495568    2.218128
-------------+------------------------------------------------
spg_flex     |
     KAMPALA |   .3262199    .149928      .0318582    .6205817
   _subpop_2 |   .3440746   .1768297     -.0031046    .6912538
   _subpop_3 |   .4639362   .1493101      .1707877    .7570848
   _subpop_4 |    .318168   .0858767      .1495616    .4867744
     EASTERN |   .3825553   .0781365      .2291458    .5359648
   _subpop_6 |   1.667829   .4831084      .7193161    2.616342
   _subpop_7 |   14.74936   2.180789       10.4677    19.03102
   _subpop_8 |   .5462792   .1756408      .2014342    .8911242
   _subpop_9 |   1.823119   .5209048      .8003987    2.845839
  _subpop_10 |   .4795711   .1404659      .2037869    .7553553
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(spdomain);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10       Number of obs    =       6775
Number of PSUs   =     711       Population size  =  200636622
                                 Design df        =        701

    _subpop_1: spdomain = Central rural
    _subpop_2: spdomain = Central urban
      Eastern: spdomain = Eastern
     Northern: spdomain = Northern
      Western: spdomain = Western

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
   _subpop_1 |   6.798742   1.382219      4.084957    9.512527
   _subpop_2 |   3.920949   1.470722      1.033401    6.808497
     Eastern |   7.564058   1.320862      4.970739    10.15738
    Northern |   20.05523   1.819486      16.48294    23.62753
     Western |   11.88273    1.47859      8.979738    14.78573
-------------+------------------------------------------------
pg_flex      |
   _subpop_1 |   1.361359   .3492406      .6756756    2.047041
   _subpop_2 |   .9996648   .3584817      .2958383    1.703491
     Eastern |   1.383358   .2140039      .9631926    1.803523
    Northern |   7.022313   .8624984      5.328923    8.715703
     Western |    2.99275   .5015668      2.007997    3.977503
-------------+------------------------------------------------
spg_flex     |
   _subpop_1 |     .43199    .137666      .1617029    .7022771
   _subpop_2 |   .3037389   .1081926      .0913186    .5161592
     Eastern |   .3536218   .0579814      .2397838    .4674599
    Northern |   3.405928    .490854      2.442208    4.369648
     Western |   1.170894   .2908952      .5997633    1.742024
--------------------------------------------------------------

.         compress;
survquar was float now byte
spdomain was float now byte
reg_tpi was float now byte
one was float now byte
triwt was float now byte
h was float now byte
h_flex was float now byte
rmult was float now int
poor09 was float now byte
survmon was float now byte
rural was float now byte
news was float now byte
bswt was float now byte
hhsize was double now byte

.         sort hhid;

. save "$path/work/cons_real.dta" , replace;
file C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA/work/cons_real.dta saved

.         collapse  (mean) h_flex pg_flex spg_flex [aw=hhweight*hhsize], by(strata);

. save "$path\work\povmeas.dta", replace;
file C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA\work\povmeas.dta saved

. **************************************************************************
> * 130_povmeas_flex.do           (end)
> **************************************************************************;
. log close;
      name:  <unnamed>
       log:  C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA/rep/130_povmeas_flex.log
  log type:  text
 closed on:  17 May 2013, 14:58:14
-------------------------------------------------------------------------------------------
