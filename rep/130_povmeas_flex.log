-------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA/rep/130_povmeas_flex.log
  log type:  text
 opened on:   6 May 2013, 13:53:22

. clear

. set more off

. #delimit ;
delimiter now ;
. **************************************************************************
> * 130_povmeas_flex.do           (start)
> *
> * Purpose:
> * Initial poverty measures calculation for flexible basket. (Before any iteration)
> **************************************************************************;
. *CA modified to add work\hhdata.dta for bootstrap;
. /*
> This file uses:
>         in\foodshr96.dta
>         work\povline_f_flex.dta
>         work\consump_nom.dta
>         work\hhdata.dta
>         work/temp_index_reg_tpi.dta
> 
> This file creates:
>         work\foodshr96.dta
>         work\povmeas.dta
>         work\povlines.dta
>         work/cons_real.dta
> */
> 
> 
> 
> **************************************************************************;
. * Bring in data file with nominal consumption per capita, and deflate it
> * by temporal price index.
> **************************************************************************;
. use "$path/work/hhdata.dta", clear;

.         keep hhid strata reg_tpi spdomain news rural survmon survquar;

.         tab reg_tpi, miss;

    reg_tpi |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |      5,555       81.99       81.99
          2 |      1,220       18.01      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         tab survquar, miss;

 Sequential |
     Survey |
    Quarter |
    May-Jun |
      09=1) |      Freq.     Percent        Cum.
------------+-----------------------------------
 May-Jul 09 |      1,749       25.82       25.82
Sept-Oct 09 |      1,731       25.55       51.37
Nov09-Jan10 |      1,458       21.52       72.89
 Feb-Apr 10 |      1,837       27.11      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         keep hhid spdomain reg_tpi survquar;

.         sort hhid;

.         tempfile spdomainreg_tpi;

. save `spdomainreg_tpi', replace;
(note: file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0h000001.tmp not found)
file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0h000001.tmp saved

. use "$path/work/conpc.dta", clear;

. *use "$path/work/consump_nom.dta", clear;
. *CA modified to merge in work\hhdata.dta for bootstrap;
.     sort hhid;

.     merge hhid using "$path\work\hhdata.dta";

.     tab _m;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.     drop _m;

.         keep hhid hhweight hhsize cons_pc_nom ;

.         sort hhid;

.         merge hhid using `spdomainreg_tpi';
(label spdomain_original already defined)
(label lsurvquar already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

.         sort reg_tpi survquar;

.         merge reg_tpi survquar using "$path/work/temp_index_reg_tpi.dta";
variables reg_tpi survquar do not uniquely identify observations in the master data
(label lsurvquar already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

.         sort hhid;

.         merge hhid using "$path/work/conpc.dta";

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

.         gen food_pc_tpi  = food_pc_nom /tpi_trim;

.         lab var food_pc_tpi "Temp-adjusted per capita food consumption/day";

.                 gen cons_pc_tpi = food_pc_tpi + nf_pc_nom;

.         lab var cons_pc_tpi "Temp adjusted total consumption/day";

.         gen one=1;

. * TPI deflated per capita consumption ;
.         tempfile contpi;

. save `contpi', replace;
(note: file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0h000002.tmp not found)
file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0h000002.tmp saved

. **************************************************************************
> * Calculate non-food expenditure for HH around the food poverty line
> *
> * Develop a discrete triangular weighted distribution. This gives a
> * weight of  1 to HH at +/- 18-20% from food poverty line, and
> * weight of  2 to HH at +/- 16-18% from food poverty line, and ...
> * weight of 10 to HH at +/-  0- 2% from food poverty line.
> * This weight is called triwt below.
> **************************************************************************;
. use `contpi';

.         sort spdomain;

.         merge spdomain using "$path/work/povline_food_flex.dta";
variable spdomain does not uniquely identify observations in the master data
(label spdomain_original already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

. gen     triwt = 0 ;

. replace triwt = 11 - round(50*abs(cons_pc_tpi/povline_f_flex-1)+0.5)
>                 if abs(cons_pc_tpi/povline_f_flex-1)<=0.2;
(317 real changes made)

.                                         * Nearness to poverty line and population weights
>  ;
.         gen tripopwt=triwt*hhweight*hhsize;

.         preserve;

.                 collapse (mean) nf_pc_nom [aw=tripopwt] ,
>                         by(spdomain);

.                                         rename nf_pc_nom povline_na_flex;

.                 lab var povline_na_flex "Nonfood poverty line. Flexible bundle";

.                                 tempfile znf;

.                 sort spdomain;

.                 save `znf', replace;
(note: file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0h000004.tmp not found)
file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0h000004.tmp saved

.                 tab spdomain;

     spdomain |      Freq.     Percent        Cum.
--------------+-----------------------------------
Central rural |          1       20.00       20.00
Central urban |          1       20.00       40.00
      Eastern |          1       20.00       60.00
     Northern |          1       20.00       80.00
      Western |          1       20.00      100.00
--------------+-----------------------------------
        Total |          5      100.00

.         restore;

.         sort spdomain;

.         merge spdomain using `znf';
variable spdomain does not uniquely identify observations in the master data
(label spdomain_original already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

. **************************************************************************;
. * Poverty line is the sum of the food and non-food poverty lines
> **************************************************************************;
.         gen povline_flex=povline_f_flex + povline_na_flex;

.         lab var povline_flex "Poverty line. Flexible bundle";

.         sort spdomain;

. save "$path\work\povlines.dta", replace;
file C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA\work\povlines.dta saved

. **************************************************************************;
. * Create spatial price index, based on the total poverty line, with
> * adjustment so that mean (and total) nominal consumption equals
> * mean (and total) spatially deflated consumption.
> *
> * Choose arbitrary strata to be the base at first: we just use the first stratum.
> **************************************************************************;
. use `contpi';

.         sort spdomain;

.         merge spdomain using "$path\work\povlines.dta";
variable spdomain does not uniquely identify observations in the master data
variable spdomain does not uniquely identify observations in
    C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA\work\povlines.dta
(label spdomain_original already defined)
(label lsurvquar already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

.         * Real consumption pc, temporally deflated ;
.         gen cr= cons_pc_tpi ;

.         * Poverty line;
.         gen linpob=povline_flex;

.         *qui sum linpob if spdomain==1, meanonly;
.         sum linpob if spdomain==3, meanonly;

.         global spi_base=r(mean);

.         * Spatial price index ;
.         gen spi=linpob/$spi_base;

.         * Real consumption pc, temporally and spatially deflated ;
.         gen cr2=cr/spi;

.         qui sum cr [aw=hhweight*hhsize];

.         global sumcr=r(sum);

.         qui sum cr2 [aw=hhweight*hhsize];

.         global sumcr2=r(sum);

.         replace spi=spi*$sumcr2/$sumcr;
(6775 real changes made)

.         gen linpobr=linpob/spi;

.         replace cr2=cr/spi;
(6775 real changes made)

.         sum cr cr2 linpob linpobr [aw=hhweight*hhsize];

    Variable |     Obs      Weight        Mean   Std. Dev.       Min        Max
-------------+-----------------------------------------------------------------
          cr |    6775   200636622    9371.093     395668   79.72159   8.12e+07
         cr2 |    6775   200636622    9371.093     365289   77.60468   7.49e+07
      linpob |    6775   200636622    921.6452   113.0929   761.5579   1090.216
     linpobr |    6775   200636622    1005.847   .0000305   1005.847   1005.847

.         lab var cr      "Temporally-adjusted cons pc";

.         lab var cr2     "Spatially & temporally adjusted cons pc";

.         lab var linpob  "Poverty line";

.         lab var linpobr "Real poverty line";

.         lab var spi     "Spatial price index";

. **************************************************************************
> * calculate poverty measures with the flexible food bundle
> **************************************************************************;
.         gen h = 100     if cr <=(linpob);
(5975 missing values generated)

.         replace  h = 0 if cr > (linpob);
(5975 real changes made)

.                         gen             pg      = ((linpob - cr )/linpob) *100;

.         replace         pg      = 0             if h==0;
(5975 real changes made)

.         gen             spg     = ((( linpob - cr )/ linpob )^2)*100;

.         replace         spg     = 0             if h==0;
(5975 real changes made)

.         gen h_flex=h;

.         gen pg_flex=pg;

.         gen spg_flex=spg;

.         lab var h_flex   "Poverty headcount. Flex bundle";

.         lab var pg_flex  "Poverty gap. Flex bundle";

.         lab var spg_flex "Squared poverty gap. Flex bundle";

.         sort hhid;

.         merge hhid using "$path\work\hhdata.dta";
(label lsurvquar already defined)
(label spdomain_original already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop if _merge~=3;
(0 observations deleted)

.         drop _merge;

.         gen popwt=hhsize*hhweight;

.                 * Stata 10.1 syntax ;
.         svyset , clear;

.         svyset [pweight=popwt] , str(strata) psu(psu);

      pweight: popwt
          VCE: linearized
  Single unit: missing
     Strata 1: strata
         SU 1: psu
        FPC 1: <zero>

.         svy: mean h_flex pg_flex spg_flex;
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10       Number of obs    =       6775
Number of PSUs   =     711       Population size  =  200636622
                                 Design df        =        701

--------------------------------------------------------------
             |             Linearized
             |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
      h_flex |   10.17521   .7028314      8.795308    11.55512
     pg_flex |   2.706894   .2228696      2.269322    3.144466
    spg_flex |   1.095398   .1200751      .8596477    1.331148
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(rural);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10       Number of obs    =       6775
Number of PSUs   =     711       Population size  =  200636622
                                 Design df        =        701

        Urban: rural = Urban
        Rural: rural = Rural

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
       Urban |   4.021768   1.206682      1.652626    6.390911
       Rural |   11.11512   .7778461      9.587934    12.64231
-------------+------------------------------------------------
pg_flex      |
       Urban |   .8161022   .2476209      .3299348     1.30227
       Rural |   2.995703   .2521938      2.500557    3.490848
-------------+------------------------------------------------
spg_flex     |
       Urban |   .2204604    .070983      .0810958    .3598251
       Rural |    1.22904   .1374535      .9591697     1.49891
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(news);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10       Number of obs    =       6775
Number of PSUs   =     711       Population size  =  200636622
                                 Design df        =        701

            1: news = 1
            2: news = 2
            3: news = 3
            4: news = 4

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
           1 |    5.63089    1.05313      3.563223    7.698557
           2 |   7.293532   1.288217      4.764305    9.822758
           3 |   19.72936    1.76053      16.27282     23.1859
           4 |   10.76172   1.461113      7.893042    13.63041
-------------+------------------------------------------------
pg_flex      |
           1 |    1.15483   .2549589      .6542553    1.655404
           2 |   1.315702   .1985937      .9257922    1.705612
           3 |   6.895253   .8468851      5.232518    8.557988
           4 |   2.685102      .4735      1.755454     3.61475
-------------+------------------------------------------------
spg_flex     |
           1 |   .3451009     .09904      .1506504    .5395515
           2 |   .3381457   .0552177      .2297338    .4465575
           3 |   3.304925   .4807934      2.360957    4.248893
           4 |   1.045301   .2758282      .5037529     1.58685
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(reg_tpi);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10       Number of obs    =       6775
Number of PSUs   =     711       Population size  =  200636622
                                 Design df        =        701

            1: reg_tpi = 1
            2: reg_tpi = 2

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
           1 |   11.11512   .7778461      9.587934    12.64231
           2 |   4.021768   1.206682      1.652626    6.390911
-------------+------------------------------------------------
pg_flex      |
           1 |   2.995703   .2521938      2.500557    3.490848
           2 |   .8161022   .2476209      .3299348     1.30227
-------------+------------------------------------------------
spg_flex     |
           1 |    1.22904   .1374535      .9591697     1.49891
           2 |   .2204604    .070983      .0810958    .3598251
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(strata);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10       Number of obs    =       6775
Number of PSUs   =     711       Population size  =  200636622
                                 Design df        =        701

      KAMPALA: strata = KAMPALA
    _subpop_2: strata = CENTRAL 1
    _subpop_3: strata = CENTRAL 2
    _subpop_4: strata = EAST CENTRAL
      EASTERN: strata = EASTERN
    _subpop_6: strata = MID-NOTHERN
    _subpop_7: strata = NORTH-EAST
    _subpop_8: strata = WEST-NILE
    _subpop_9: strata = MID-WESTERN
   _subpop_10: strata = SOUTH-WESTERN

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
     KAMPALA |   3.989593    2.38974     -.7023125    8.681498
   _subpop_2 |   4.571793   1.414053      1.795507    7.348078
   _subpop_3 |   7.411211   1.868854      3.741991    11.08043
   _subpop_4 |   5.398209   1.171782      3.097587    7.698831
     EASTERN |    8.84028   2.088303      4.740203    12.94036
   _subpop_6 |   10.95511   1.986172      7.055549    14.85467
   _subpop_7 |   67.13084   6.112161       55.1305    79.13117
   _subpop_8 |   10.02044    1.68785      6.706596    13.33429
   _subpop_9 |   14.77021   2.505799      9.850437    19.68998
  _subpop_10 |   6.512956   1.147582      4.259846    8.766067
-------------+------------------------------------------------
pg_flex      |
     KAMPALA |   .7244982   .4195737     -.0992733     1.54827
   _subpop_2 |   1.016563   .4210806      .1898326    1.843293
   _subpop_3 |   1.478599   .4168029      .6602675    2.296931
   _subpop_4 |   1.017157   .2248286      .5757391    1.458575
     EASTERN |    1.55934   .3042369      .9620156    2.156665
   _subpop_6 |   3.568287   .8665268      1.866988    5.269585
   _subpop_7 |   27.64351   3.472548      20.82567    34.46135
   _subpop_8 |   1.883858   .4195762      1.060082    2.707635
   _subpop_9 |   4.045896   .8273611      2.421494    5.670299
  _subpop_10 |   1.242736   .2984751      .6567239    1.828748
-------------+------------------------------------------------
spg_flex     |
     KAMPALA |   .1360915   .0761466     -.0134113    .2855943
   _subpop_2 |   .3325931   .1882884     -.0370836    .7022698
   _subpop_3 |    .446297   .1441454      .1632884    .7293055
   _subpop_4 |   .3037133   .0845491      .1377134    .4697131
     EASTERN |   .3662455   .0724607      .2239796    .5085115
   _subpop_6 |   1.541033   .4691451      .6199346     2.46213
   _subpop_7 |   14.45787   2.138596      10.25905    18.65669
   _subpop_8 |   .5748251   .1771487      .2270194    .9226307
   _subpop_9 |   1.670945   .4941851      .7006849    2.641205
  _subpop_10 |   .3821537     .13021      .1265053    .6378021
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(spdomain);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10       Number of obs    =       6775
Number of PSUs   =     711       Population size  =  200636622
                                 Design df        =        701

    _subpop_1: spdomain = Central rural
    _subpop_2: spdomain = Central urban
      Eastern: spdomain = Eastern
     Northern: spdomain = Northern
      Western: spdomain = Western

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
   _subpop_1 |   6.828463    1.38225      4.114618    9.542309
   _subpop_2 |   3.175608   1.450995      .3267912    6.024426
     Eastern |   7.293532   1.288217      4.764305    9.822758
    Northern |   19.72936    1.76053      16.27282     23.1859
     Western |   10.76172   1.461113      7.893042    13.63041
-------------+------------------------------------------------
pg_flex      |
   _subpop_1 |   1.427114   .3533332       .733396    2.120832
   _subpop_2 |   .5965885   .2645772      .0771299    1.116047
     Eastern |   1.315702   .1985937      .9257922    1.705612
    Northern |   6.895253   .8468851      5.232518    8.557988
     Western |   2.685102      .4735      1.755454     3.61475
-------------+------------------------------------------------
spg_flex     |
   _subpop_1 |   .4499643   .1435022      .1682188    .7317099
   _subpop_2 |   .1301085   .0545708      .0229667    .2372502
     Eastern |   .3381457   .0552177      .2297338    .4465575
    Northern |   3.304925   .4807934      2.360957    4.248893
     Western |   1.045301   .2758282      .5037529     1.58685
--------------------------------------------------------------

.         compress;
survquar was float now byte
reg_tpi was float now byte
spdomain was float now byte
one was float now byte
triwt was float now byte
h was float now byte
h_flex was float now byte
rmult was float now int
poor09 was float now byte
survmon was float now byte
rural was float now byte
news was float now byte
bswt was float now byte
hhsize was double now byte

.         sort hhid;

. save "$path/work/cons_real.dta" , replace;
file C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA/work/cons_real.dta saved

.         collapse  (mean) h_flex pg_flex spg_flex [aw=hhweight*hhsize], by(strata);

. save "$path\work\povmeas.dta", replace;
file C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA\work\povmeas.dta saved

. **************************************************************************
> * 130_povmeas_flex.do           (end)
> **************************************************************************;
. log close;
      name:  <unnamed>
       log:  C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA/rep/130_povmeas_flex.log
  log type:  text
 closed on:   6 May 2013, 13:53:25
-------------------------------------------------------------------------------------------
