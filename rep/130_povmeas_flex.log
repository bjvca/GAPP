-------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA/rep/130_povmeas_flex.log
  log type:  text
 opened on:  17 May 2013, 09:52:49

. clear

. set more off

. #delimit ;
delimiter now ;
. **************************************************************************
> * 130_povmeas_flex.do           (start)
> *
> * Purpose:
> * Initial poverty measures calculation for flexible basket. (Before any iteration)
> **************************************************************************;
. *CA modified to add work\hhdata.dta for bootstrap;
. /*
> This file uses:
>         in\foodshr96.dta
>         work\povline_f_flex.dta
>         work\consump_nom.dta
>         work\hhdata.dta
>         work/temp_index_reg_tpi.dta
> 
> This file creates:
>         work\foodshr96.dta
>         work\povmeas.dta
>         work\povlines.dta
>         work/cons_real.dta
> */
> 
> 
> 
> **************************************************************************;
. * Bring in data file with nominal consumption per capita, and deflate it
> * by temporal price index.
> **************************************************************************;
. use "$path/work/hhdata.dta", clear;

.         keep hhid strata reg_tpi spdomain news rural survmon survquar;

.         tab reg_tpi, miss;

    reg_tpi |      Freq.     Percent        Cum.
------------+-----------------------------------
    central |      1,986       29.31       29.31
    eastern |      1,406       20.75       50.07
   northern |      1,956       28.87       78.94
    western |      1,427       21.06      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         tab survquar, miss;

 Sequential |
     Survey |
    Quarter |
    May-Jun |
      09=1) |      Freq.     Percent        Cum.
------------+-----------------------------------
 May-Jul 09 |      1,749       25.82       25.82
Sept-Oct 09 |      1,731       25.55       51.37
Nov09-Jan10 |      1,458       21.52       72.89
 Feb-Apr 10 |      1,837       27.11      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         keep hhid spdomain reg_tpi survquar;

.         sort hhid;

.         tempfile spdomainreg_tpi;

. save `spdomainreg_tpi', replace;
(note: file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000001.tmp not found)
file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000001.tmp saved

. use "$path/work/conpc.dta", clear;

. *use "$path/work/consump_nom.dta", clear;
. *CA modified to merge in work\hhdata.dta for bootstrap;
.     sort hhid;

.     merge hhid using "$path\work\hhdata.dta";

.     tab _m;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.     drop _m;

.         keep hhid hhweight hhsize cons_pc_nom ;

.         sort hhid;

.         merge hhid using `spdomainreg_tpi';
(label REG_TPI already defined)
(label spdomain_original already defined)
(label lsurvquar already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

.         sort reg_tpi survquar;

.         merge reg_tpi survquar using "$path/work/temp_index_reg_tpi.dta";
variables reg_tpi survquar do not uniquely identify observations in the master data
(label lsurvquar already defined)
(label REG_TPI already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

.         sort hhid;

.         merge hhid using "$path/work/conpc.dta";

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

.         gen food_pc_tpi  = food_pc_nom /tpi_trim;

.         lab var food_pc_tpi "Temp-adjusted per capita food consumption/day";

.                 gen cons_pc_tpi = food_pc_tpi + nf_pc_nom;

.         lab var cons_pc_tpi "Temp adjusted total consumption/day";

.         gen one=1;

. * TPI deflated per capita consumption ;
.         tempfile contpi;

. save `contpi', replace;
(note: file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000002.tmp not found)
file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000002.tmp saved

. **************************************************************************
> * Calculate non-food expenditure for HH around the food poverty line
> *
> * Develop a discrete triangular weighted distribution. This gives a
> * weight of  1 to HH at +/- 18-20% from food poverty line, and
> * weight of  2 to HH at +/- 16-18% from food poverty line, and ...
> * weight of 10 to HH at +/-  0- 2% from food poverty line.
> * This weight is called triwt below.
> **************************************************************************;
. use `contpi';

.         sort spdomain;

.         merge spdomain using "$path/work/povline_food_flex.dta";
variable spdomain does not uniquely identify observations in the master data
(label spdomain_original already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

. gen     triwt = 0 ;

. replace triwt = 11 - round(50*abs(cons_pc_tpi/povline_f_flex-1)+0.5)
>                 if abs(cons_pc_tpi/povline_f_flex-1)<=0.2;
(321 real changes made)

.                                         * Nearness to poverty line and population weights
>  ;
.         gen tripopwt=triwt*hhweight*hhsize;

.         preserve;

.                 collapse (mean) nf_pc_nom [aw=tripopwt] ,
>                         by(spdomain);

.                                         rename nf_pc_nom povline_na_flex;

.                 lab var povline_na_flex "Nonfood poverty line. Flexible bundle";

.                                 tempfile znf;

.                 sort spdomain;

.                 save `znf', replace;
(note: file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000004.tmp not found)
file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000004.tmp saved

.                 tab spdomain;

     spdomain |      Freq.     Percent        Cum.
--------------+-----------------------------------
Central rural |          1       20.00       20.00
Central urban |          1       20.00       40.00
      Eastern |          1       20.00       60.00
     Northern |          1       20.00       80.00
      Western |          1       20.00      100.00
--------------+-----------------------------------
        Total |          5      100.00

.         restore;

.         sort spdomain;

.         merge spdomain using `znf';
variable spdomain does not uniquely identify observations in the master data
(label spdomain_original already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

. **************************************************************************;
. * Poverty line is the sum of the food and non-food poverty lines
> **************************************************************************;
.         gen povline_flex=povline_f_flex + povline_na_flex;

.         lab var povline_flex "Poverty line. Flexible bundle";

.         sort spdomain;

. save "$path\work\povlines.dta", replace;
file C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA\work\povlines.dta saved

. **************************************************************************;
. * Create spatial price index, based on the total poverty line, with
> * adjustment so that mean (and total) nominal consumption equals
> * mean (and total) spatially deflated consumption.
> *
> * Choose arbitrary strata to be the base at first: we just use the first stratum.
> **************************************************************************;
. use `contpi';

.         sort spdomain;

.         merge spdomain using "$path\work\povlines.dta";
variable spdomain does not uniquely identify observations in the master data
variable spdomain does not uniquely identify observations in
    C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA\work\povlines.dta
(label REG_TPI already defined)
(label spdomain_original already defined)
(label lsurvquar already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

.         * Real consumption pc, temporally deflated ;
.         gen cr= cons_pc_tpi ;

.         * Poverty line;
.         gen linpob=povline_flex;

.         *qui sum linpob if spdomain==1, meanonly;
.         sum linpob if spdomain==3, meanonly;

.         global spi_base=r(mean);

.         * Spatial price index ;
.         gen spi=linpob/$spi_base;

.         * Real consumption pc, temporally and spatially deflated ;
.         gen cr2=cr/spi;

.         qui sum cr [aw=hhweight*hhsize];

.         global sumcr=r(sum);

.         qui sum cr2 [aw=hhweight*hhsize];

.         global sumcr2=r(sum);

.         replace spi=spi*$sumcr2/$sumcr;
(6775 real changes made)

.         gen linpobr=linpob/spi;

.         replace cr2=cr/spi;
(6775 real changes made)

.         sum cr cr2 linpob linpobr [aw=hhweight*hhsize];

    Variable |     Obs      Weight        Mean   Std. Dev.       Min        Max
-------------+-----------------------------------------------------------------
          cr |    6775   200636622    9416.597   395671.8   82.64046   8.12e+07
         cr2 |    6775   200636622    9416.597   306967.6   84.18735   6.28e+07
      linpob |    6775   200636622    960.1737   200.4131   758.2903   1481.339
     linpobr |    6775   200636622    1145.778   .0000451   1145.777   1145.778

.         lab var cr      "Temporally-adjusted cons pc";

.         lab var cr2     "Spatially & temporally adjusted cons pc";

.         lab var linpob  "Poverty line";

.         lab var linpobr "Real poverty line";

.         lab var spi     "Spatial price index";

. **************************************************************************
> * calculate poverty measures with the flexible food bundle
> **************************************************************************;
.         gen h = 100     if cr <=(linpob);
(5955 missing values generated)

.         replace  h = 0 if cr > (linpob);
(5955 real changes made)

.                         gen             pg      = ((linpob - cr )/linpob) *100;

.         replace         pg      = 0             if h==0;
(5955 real changes made)

.         gen             spg     = ((( linpob - cr )/ linpob )^2)*100;

.         replace         spg     = 0             if h==0;
(5955 real changes made)

.         gen h_flex=h;

.         gen pg_flex=pg;

.         gen spg_flex=spg;

.         lab var h_flex   "Poverty headcount. Flex bundle";

.         lab var pg_flex  "Poverty gap. Flex bundle";

.         lab var spg_flex "Squared poverty gap. Flex bundle";

.         sort hhid;

.         merge hhid using "$path\work\hhdata.dta";
(label lsurvquar already defined)
(label spdomain_original already defined)
(label REG_TPI already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop if _merge~=3;
(0 observations deleted)

.         drop _merge;

.         gen popwt=hhsize*hhweight;

.                 * Stata 10.1 syntax ;
.         svyset , clear;

.         svyset [pweight=popwt] , str(strata) psu(psu);

      pweight: popwt
          VCE: linearized
  Single unit: missing
     Strata 1: strata
         SU 1: psu
        FPC 1: <zero>

.         svy: mean h_flex pg_flex spg_flex;
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10       Number of obs    =       6775
Number of PSUs   =     711       Population size  =  200636622
                                 Design df        =        701

--------------------------------------------------------------
             |             Linearized
             |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
      h_flex |   10.42968   .7119093      9.031951    11.82741
     pg_flex |   2.750531   .2257856      2.307234    3.193828
    spg_flex |   1.119029   .1214004      .8806774    1.357381
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(rural);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10       Number of obs    =       6775
Number of PSUs   =     711       Population size  =  200636622
                                 Design df        =        701

        Urban: rural = Urban
        Rural: rural = Rural

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
       Urban |   3.415127   1.014682      1.422946    5.407308
       Rural |   11.50112   .7905976      9.948893    13.05334
-------------+------------------------------------------------
pg_flex      |
       Urban |   .7526381   .2220265      .3167215    1.188555
       Rural |   3.055698   .2557257      2.553618    3.557778
-------------+------------------------------------------------
spg_flex     |
       Urban |   .2294405   .0699235      .0921559     .366725
       Rural |   1.254909   .1389486       .982104    1.527715
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(news);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10       Number of obs    =       6775
Number of PSUs   =     711       Population size  =  200636622
                                 Design df        =        701

            1: news = 1
            2: news = 2
            3: news = 3
            4: news = 4

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
           1 |    5.70916    1.05167      3.644359    7.773961
           2 |   7.564058   1.320862      4.970739    10.15738
           3 |   19.57422    1.77695      16.08544    23.06301
           4 |   11.52681   1.469106      8.642435    14.41118
-------------+------------------------------------------------
pg_flex      |
           1 |   1.190919   .2562877      .6877357    1.694103
           2 |   1.288145   .1995211      .8964142    1.679875
           3 |   6.850458   .8519829      5.177714    8.523202
           4 |   2.911518   .4946526       1.94034    3.882696
-------------+------------------------------------------------
spg_flex     |
           1 |   .3699599   .0961232      .1812361    .5586837
           2 |   .3231182    .054356      .2163981    .4298383
           3 |   3.309993   .4812525      2.365124    4.254862
           4 |   1.137488   .2875278       .572969    1.702007
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(reg_tpi);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10       Number of obs    =       6775
Number of PSUs   =     711       Population size  =  200636622
                                 Design df        =        701

      central: reg_tpi = central
      eastern: reg_tpi = eastern
     northern: reg_tpi = northern
      western: reg_tpi = western

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
     central |    5.70916    1.05167      3.644359    7.773961
     eastern |   7.564058   1.320862      4.970739    10.15738
    northern |   19.57422    1.77695      16.08544    23.06301
     western |   11.52681   1.469106      8.642435    14.41118
-------------+------------------------------------------------
pg_flex      |
     central |   1.190919   .2562877      .6877357    1.694103
     eastern |   1.288145   .1995211      .8964142    1.679875
    northern |   6.850458   .8519829      5.177714    8.523202
     western |   2.911518   .4946526       1.94034    3.882696
-------------+------------------------------------------------
spg_flex     |
     central |   .3699599   .0961232      .1812361    .5586837
     eastern |   .3231182    .054356      .2163981    .4298383
    northern |   3.309993   .4812525      2.365124    4.254862
     western |   1.137488   .2875278       .572969    1.702007
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(strata);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10       Number of obs    =       6775
Number of PSUs   =     711       Population size  =  200636622
                                 Design df        =        701

      KAMPALA: strata = KAMPALA
    _subpop_2: strata = CENTRAL 1
    _subpop_3: strata = CENTRAL 2
    _subpop_4: strata = EAST CENTRAL
      EASTERN: strata = EASTERN
    _subpop_6: strata = MID-NOTHERN
    _subpop_7: strata = NORTH-EAST
    _subpop_8: strata = WEST-NILE
    _subpop_9: strata = MID-WESTERN
   _subpop_10: strata = SOUTH-WESTERN

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
     KAMPALA |   4.874973   2.339743        .28123    9.468715
   _subpop_2 |   4.790162   1.423751      1.994836    7.585489
   _subpop_3 |   7.004536   1.856453      3.359662    10.64941
   _subpop_4 |   5.450948   1.171204       3.15146    7.750436
     EASTERN |    9.28854   2.149875      5.067575     13.5095
   _subpop_6 |   10.98032   2.045831      6.963628    14.99701
   _subpop_7 |   67.39871   6.147208      55.32957    79.46786
   _subpop_8 |   9.395116   1.618714      6.217008    12.57322
   _subpop_9 |   14.90944   2.500695      9.999689    19.81919
  _subpop_10 |   7.941413   1.250905      5.485444    10.39738
-------------+------------------------------------------------
pg_flex      |
     KAMPALA |    1.08992   .5067121       .095065    2.084775
   _subpop_2 |   1.013974   .4058058      .2172337    1.810714
   _subpop_3 |   1.415128   .4150918      .6001555      2.2301
   _subpop_4 |   1.011129   .2235726      .5721771    1.450082
     EASTERN |   1.514213   .3069562      .9115496    2.116877
   _subpop_6 |   3.663975   .8739137      1.948173    5.379777
   _subpop_7 |   27.55661   3.499263      20.68631     34.4269
   _subpop_8 |   1.650925   .4013769      .8628804     2.43897
   _subpop_9 |   4.222382   .8653908      2.523313     5.92145
  _subpop_10 |   1.522076   .3174569      .8987963    2.145357
-------------+------------------------------------------------
spg_flex     |
     KAMPALA |   .2975867   .1379834      .0266765    .5684969
   _subpop_2 |   .3285483   .1722542     -.0096477    .6667442
   _subpop_3 |   .4430376   .1440657      .1601855    .7258896
   _subpop_4 |   .2955999   .0822422      .1341294    .4570704
     EASTERN |   .3455755   .0720795      .2040579    .4870932
   _subpop_6 |   1.612247   .4728971      .6837828    2.540712
   _subpop_7 |   14.39401   2.145383      10.18186    18.60615
   _subpop_8 |   .5148456   .1700931      .1808927    .8487986
   _subpop_9 |   1.777184   .5152973      .7654726    2.788895
  _subpop_10 |   .4594462   .1375009      .1894832    .7294092
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(spdomain);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10       Number of obs    =       6775
Number of PSUs   =     711       Population size  =  200636622
                                 Design df        =        701

    _subpop_1: spdomain = Central rural
    _subpop_2: spdomain = Central urban
      Eastern: spdomain = Eastern
     Northern: spdomain = Northern
      Western: spdomain = Western

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
   _subpop_1 |   6.581367   1.376393       3.87902    9.283714
   _subpop_2 |   3.920949   1.470722      1.033401    6.808497
     Eastern |   7.564058   1.320862      4.970739    10.15738
    Northern |   19.57422    1.77695      16.08544    23.06301
     Western |   11.52681   1.469106      8.642435    14.41118
-------------+------------------------------------------------
pg_flex      |
   _subpop_1 |    1.30957   .3419335      .6382338    1.980907
   _subpop_2 |   .9476586   .3401444      .2798348    1.615482
     Eastern |   1.288145   .1995211      .8964142    1.679875
    Northern |   6.850458   .8519829      5.177714    8.523202
     Western |   2.911518   .4946526       1.94034    3.882696
-------------+------------------------------------------------
spg_flex     |
   _subpop_1 |   .4140012   .1338224      .1512604     .676742
   _subpop_2 |   .2796657    .100253      .0828337    .4764977
     Eastern |   .3231182    .054356      .2163981    .4298383
    Northern |   3.309993   .4812525      2.365124    4.254862
     Western |   1.137488   .2875278       .572969    1.702007
--------------------------------------------------------------

.         compress;
survquar was float now byte
spdomain was float now byte
reg_tpi was float now byte
one was float now byte
triwt was float now byte
h was float now byte
h_flex was float now byte
rmult was float now int
poor09 was float now byte
survmon was float now byte
rural was float now byte
news was float now byte
bswt was float now byte
hhsize was double now byte

.         sort hhid;

. save "$path/work/cons_real.dta" , replace;
file C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA/work/cons_real.dta saved

.         collapse  (mean) h_flex pg_flex spg_flex [aw=hhweight*hhsize], by(strata);

. save "$path\work\povmeas.dta", replace;
file C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA\work\povmeas.dta saved

. **************************************************************************
> * 130_povmeas_flex.do           (end)
> **************************************************************************;
. log close;
      name:  <unnamed>
       log:  C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA/rep/130_povmeas_flex.log
  log type:  text
 closed on:  17 May 2013, 09:52:49
-------------------------------------------------------------------------------------------
