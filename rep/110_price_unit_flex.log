---------------------------------------------------
      name:  <unnamed>
       log:  /home/bjvca/data/data/GAP/Haruna/rep/1
> 10_price_unit_flex.log
  log type:  text
 opened on:  20 May 2013, 12:16:28

. clear

. set more off

. #delimit ;
delimiter now ;
. *************************************************
> ***************************************
> * 110_price_unit_flex.do                (start)
> *
> * Purpose: This do file creates a price_unit_flex
>  database with the unit prices of the
> * goods of the flexible food basket in order to d
> etermine the poverty lines per spatial
> * domain. It uses the files work/daily.dta and wo
> rk/own.dta file and draw unit prices
> * by: sum of values and quantity
> *************************************************
> ***************************************;
. *CA modified to bring in work/hhdata.dta for boot
> strap
> *CA check for price calcs conditional on number o
> f observations;
. /*
> This file uses:
>         work/daily.dta
>         work/own.dta
>         work/hhdata.dta
>         work/consump_nom.dta
>         work/codes_food_basket_flex.dta
>         work/temp_index_reg_tpi.dta
>           new/conversions.do
> 
> This file creates:
>         work/price_unit_flex.dta
>         work/bottom_basket.dta
> */
> 
> 
> 
> 
> *do "$path/new/010_initial.do";
. *************************************************
> *************************************
> * Create sorted data set with daily and own and t
> he matched codes
> *************************************************
> *************************************;
. use "$path/work/cons_cod_trans.dta", clear;

. *use "$path/in/cons_cod_trans.dta", clear;
. *save "$path/work/cons_cod_trans.dta", replace;
. *drop if quantityd==0 ;
. keep hhid product food_cat valuez quantityz unit;

. rename valuez    value;

. rename quantityz quantity;

. drop if quantity==0 ;
(4392 observations deleted)

. *drop count;
.         sort product;

.         gen count=1;

.                 tempfile dd_acsort;

. save `dd_acsort', replace;
(note: file /tmp/St02502.000007 not found)
file /tmp/St02502.000007 saved

. /*
> use "$path/work/daily.dta";
> tempfile dd_acsort;
>         drop days;
>         sort product;
>         tempfile dd_acsort;
> save `dd_acsort', replace;
> 
> use "$path/work/own.dta";
>         keep hhid product valued quantityd unit;
>         rename valued value;
>         rename quantityd quantity;
> 
>         *CHECK THE ZEROS IN quantity FOR NOW DELE
> TE;
>         drop if quantity==0;
> 
>         append using `dd_acsort';
> 
> *CA modified to merge in work/hhdata.dta for boot
> strap;
>         sort hhid;
>       merge hhid using "$path/work/hhdata.dta";
>       tab _m;
> 
> * Drop observations if non existent in HH data se
> t;
> drop if _m!=3;
> drop _m;
> 
> 
>         sort product;
>         gen count=1;
> 
> 
> save `dd_acsort', replace;
> */
> 
> 
> *************************************************
> *************************************;
. * Merge the flexible food basket codes with the d
> aily and own data sets
> * Drop all codes not a part of the flexible food 
> basket
> *************************************************
> *************************************;
.         merge product using "$path/work/codes_foo
> d_basket_flex.dta";
variable product does not uniquely identify
    observations in the master data

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |     13,346       15.66       15.66
          3 |     71,858       84.34      100.00
------------+-----------------------------------
      Total |     85,204      100.00

.         drop if _merge~=3;
(13346 observations deleted)

.         drop _merge;

. *************************************************
> *************************************;
. * Drop observations where product code or quantit
> y or value information is unavailable
> *************************************************
> *************************************;
.                                 codebook hhid;

---------------------------------------------------
hhid                                   household id
---------------------------------------------------

                  type:  numeric (double)

                 range:  [1.013e+09,4.193e+09]     
>    units:  1
         unique values:  6747                     m
> issing .:  0/71858

                  mean:   2.5e+09
              std. dev:   1.1e+09

           percentiles:        10%       25%       
> 50%                                              
>           75%                                    
>                     90%
                           1.0e+09   1.1e+09   2.2e
> +09                                              
>       3.2e+09                                    
>                 4.1e+09

. *        drop if product==. | value==. | quantity
> ==.  ;
.                                 codebook hhid;

---------------------------------------------------
hhid                                   household id
---------------------------------------------------

                  type:  numeric (double)

                 range:  [1.013e+09,4.193e+09]     
>    units:  1
         unique values:  6747                     m
> issing .:  0/71858

                  mean:   2.5e+09
              std. dev:   1.1e+09

           percentiles:        10%       25%       
> 50%                                              
>           75%                                    
>                     90%
                           1.0e+09   1.1e+09   2.2e
> +09                                              
>       3.2e+09                                    
>                 4.1e+09

. *************************************************
> *************************************;
. * Convert non-KG quantities (units and liters) to
>  kilograms;
. *************************************************
> *************************************;
. *do "$path/new/110a_conversions.do"
> 
> *************************************************
> *******************
> * There remain a few difficult to interpret obser
> vations such as liters
> * of fish and liters of pasta. These are dropped
> *************************************************
> *******************;
. *        drop if unit~=2;
. *************************************************
> *******************
> * Merge in labels for the 13 spatial domains
> *************************************************
> *******************;
.         preserve;

.                 use "$path/work/hhdata.dta", clea
> r;

.                                                  
>                        keep hhid spdomain reg_tpi
>  survquar;

.                         sort hhid;

.                         tempfile spdomainreg_tpi;

.                 save `spdomainreg_tpi', replace;
(note: file /tmp/St02502.000009 not found)
file /tmp/St02502.000009 saved

.                                 codebook hhid;

---------------------------------------------------
hhid                                   Household ID
---------------------------------------------------

                  type:  numeric (double)

                 range:  [1.013e+09,4.193e+09]     
>    units:  1
         unique values:  6775                     m
> issing .:  0/6775

                  mean:   2.5e+09
              std. dev:   1.1e+09

           percentiles:        10%       25%       
> 50%                                              
>           75%                                    
>                     90%
                           1.0e+09   1.1e+09   2.2e
> +09                                              
>       3.2e+09                                    
>                 4.1e+09

.         restore;

.                 sort hhid;

.         merge hhid using `spdomainreg_tpi';
variable hhid does not uniquely identify
    observations in the master data

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         28        0.04        0.04
          3 |     71,858       99.96      100.00
------------+-----------------------------------
      Total |     71,886      100.00

.         drop _merge;

.         drop if product==.;
(28 observations deleted)

. codebook hhid;

---------------------------------------------------
hhid                                   household id
---------------------------------------------------

                  type:  numeric (double)

                 range:  [1.013e+09,4.193e+09]     
>    units:  1
         unique values:  6747                     m
> issing .:  0/71858

                  mean:   2.5e+09
              std. dev:   1.1e+09

           percentiles:        10%       25%       
> 50%                                              
>           75%                                    
>                     90%
                           1.0e+09   1.1e+09   2.2e
> +09                                              
>       3.2e+09                                    
>                 4.1e+09

. tab spd;

     spdomain |      Freq.     Percent        Cum.
--------------+-----------------------------------
Central rural |     12,483       17.37       17.37
Central urban |      9,125       12.70       30.07
      Eastern |     16,311       22.70       52.77
     Northern |     19,026       26.48       79.25
      Western |     14,913       20.75      100.00
--------------+-----------------------------------
        Total |     71,858      100.00

. sum if spd>=3;

    Variable |       Obs        Mean    Std. Dev.  
>      Min        Max
-------------+-------------------------------------
> -------------------
        hhid |     50250    3.07e+09    7.86e+08   
> 2.01e+09   4.19e+09
     product |     50250    130.2235    15.80087   
>      102        161
        unit |     50250           1           0   
>        1          1
    food_cat |     50250           1           0   
>        1          1
    quantity |     50250    .9732545    3.934012   
> .0000286   364.2857
-------------+-------------------------------------
> -------------------
       value |     50250    412.0003    637.8504   
>        0      18500
       count |     50250           1           0   
>        1          1
    descript |     50250           1           0   
>        1          1
      numreg |     50250    4.145254     1.29297   
>        1          5
    survquar |     50250    2.476876    1.137676   
>        1          4
-------------+-------------------------------------
> -------------------
    spdomain |     50250    3.972179     .787789   
>        3          5
     reg_tpi |     50250    2.972179     .787789   
>        2          4

. table spdomain, content(mean quantity count quant
> ity count hhid) row missing;

---------------------------------------------------
     spdomain |    __000002 N(quantity)     N(hhid)
--------------+------------------------------------
Central rural |    1.002078      12,483      12,483
Central urban |    .6193954       9,125       9,125
      Eastern |    .9685605      16,311      16,311
     Northern |    .8221988      19,026      19,026
      Western |    1.171105      14,913      14,913
              | 
        Total |    .9333262      71,858      71,858
---------------------------------------------------

.         drop if product==. | value==. | quantity=
> =.  ;
(0 observations deleted)

. codebook hhid;

---------------------------------------------------
hhid                                   household id
---------------------------------------------------

                  type:  numeric (double)

                 range:  [1.013e+09,4.193e+09]     
>    units:  1
         unique values:  6747                     m
> issing .:  0/71858

                  mean:   2.5e+09
              std. dev:   1.1e+09

           percentiles:        10%       25%       
> 50%                                              
>           75%                                    
>                     90%
                           1.0e+09   1.1e+09   2.2e
> +09                                              
>       3.2e+09                                    
>                 4.1e+09

. tab spd;

     spdomain |      Freq.     Percent        Cum.
--------------+-----------------------------------
Central rural |     12,483       17.37       17.37
Central urban |      9,125       12.70       30.07
      Eastern |     16,311       22.70       52.77
     Northern |     19,026       26.48       79.25
      Western |     14,913       20.75      100.00
--------------+-----------------------------------
        Total |     71,858      100.00

. *************************************************
> *******************
> * Merge in temporal price index to convert nomina
> l value to real
> *************************************************
> *******************;
.         sort reg_tpi survquar;

.         merge reg_tpi survquar using "$path/work/
> temp_index_reg_tpi.dta";
variables reg_tpi survquar do not uniquely
    identify observations in the master data
(label lsurvquar already defined)
(label REG_TPI already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |     71,858      100.00      100.00
------------+-----------------------------------
      Total |     71,858      100.00

.         drop if _merge ~= 3;
(0 observations deleted)

.         drop _merge;

.         gen value_r=value/tpi_trim;

. *************************************************
> *************************;
. * Identify relatively poor households, based on n
> ominal temporally adjusted
> * consumption per capita. Only work with these ho
> useholds for the price
> * calculations.
> *************************************************
> *************************;
.                 preserve;

.                         use "$path/work/conpc.dta
> ", clear;

. *                       use "$path/work/consump_n
> om.dta", clear;
. *CA modified to merge in work/hhdata.dta for boot
> strap;
.         sort hhid;

.       merge hhid using "$path/work/hhdata.dta";

.       tab _m;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.       drop _m;

. *CA modified to keep bswt;
.                                 keep hhid hhweigh
> t hhsize cons_pc_nom bswt ;

.                                 sort hhid;

.                                 merge hhid using 
> `spdomainreg_tpi';
(label REG_TPI already defined)
(label spdomain_original already defined)
(label lsurvquar already defined)

.                                 tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.                                 drop _merge;

.                                 sort reg_tpi surv
> quar;

.                                 cap drop _merge;

.                                 merge reg_tpi sur
> vquar using "$path/work/temp_index_reg_tpi.dta";
variables reg_tpi survquar do not uniquely
    identify observations in the master data
(label lsurvquar already defined)
(label REG_TPI already defined)

.                                 tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.                                 drop _merge;

.                                 sort hhid;

.                                 merge hhid using 
> "$path/work/conpc.dta";

.                                 tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.                                 drop _merge;

.                                 gen food_pc_tpi  
> = food_pc_nom /tpi_trim;

.                                 lab var food_pc_t
> pi "Temp-adjusted per capita food consumption/day
> ";

.                                                  
>                * Non-food not TPI adjusted ;
.                                 gen cons_pc_tpi =
>  food_pc_tpi + nf_pc_nom;

.                                 lab var cons_pc_t
> pi "Temp adjusted total consumption/day";

.                                 gen one=1;

.                                 tempfile contpi;

.                                 save `contpi', re
> place;
(note: file /tmp/St02502.00000b not found)
file /tmp/St02502.00000b saved

.                                 collapse (p$botto
> m) one cons_pc_tpi [aw=hhsize*hhweight], by(spdom
> ain) ;

.                                 rename cons_pc_tp
> i pctile_60;

.                                 tempfile 60pct;

.                                 sort spdomain;

.                                 save `60pct', rep
> lace;
(note: file /tmp/St02502.00000c not found)
file /tmp/St02502.00000c saved

.                                 use `contpi';

.                                         sort spdo
> main;

.                                         merge spd
> omain using `60pct';
variable spdomain does not uniquely identify
    observations in the master data
(label spdomain_original already defined)

.                                         tab _merg
> e;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.                                         drop _mer
> ge;

.                                         drop one;

.                                         sort spdo
> main;

.                                         gen botto
> m_basket=cons_pc_tpi< pctile_60;

.                                         by spdoma
> in: tab bottom_basket [aw=hhsize*hhweight];

---------------------------------------------------
-> spdomain = Central rural

bottom_bask |
         et |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 824.031356       70.01       70.01
          1 | 352.968644       29.99      100.00
------------+-----------------------------------
      Total |      1,177      100.00

---------------------------------------------------
-> spdomain = Central urban

bottom_bask |
         et |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 571.588845       70.65       70.65
          1 | 237.411155       29.35      100.00
------------+-----------------------------------
      Total |        809      100.00

---------------------------------------------------
-> spdomain = Eastern

bottom_bask |
         et |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 984.333338       70.01       70.01
          1 | 421.666662       29.99      100.00
------------+-----------------------------------
      Total |      1,406      100.00

---------------------------------------------------
-> spdomain = Northern

bottom_bask |
         et |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 1,374.0502       70.25       70.25
          1 |581.9498358       29.75      100.00
------------+-----------------------------------
      Total |      1,956      100.00

---------------------------------------------------
-> spdomain = Western

bottom_bask |
         et |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 999.376658       70.03       70.03
          1 | 427.623342       29.97      100.00
------------+-----------------------------------
      Total |      1,427      100.00


.                                         lab var b
> ottom_basket "=1 if in bottom (60%) of PCE";

.                                         sort hhid
> ;

.                                                  
>                save "$path/work/bottom_basket.dta
> ", replace;
file /home/bjvca/data/data/GAP/Haruna/work/bottom_b
> asket.dta saved

.         restore;

.         sort hhid;

.         merge hhid using "$path/work/bottom_baske
> t.dta";
variable hhid does not uniquely identify
    observations in the master data
(label lsurvquar already defined)
(label spdomain_original already defined)
(label REG_TPI already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         28        0.04        0.04
          3 |     71,858       99.96      100.00
------------+-----------------------------------
      Total |     71,886      100.00

.         drop _merge;

.                         * Only keep price observa
> tions for the poor ;
.         keep if bottom_basket==1;
(56077 observations deleted)

.         *****************************************
> *********************************;
. * Toss out the bottom 5% and top 5% of the HH-LEV
> EL prices per kg in
> * for each spdomain & product combination. This s
> hould eliminate outliers
> * that may have an undue influence on the price c
> alculation. 
> *************************************************
> *************************;
.                 gen hhppkg=value_r/quantity;
(11 missing values generated)

.                 egen lower5=pctile(hhppkg), p(5) 
> by(spdomain product);
(11 missing values generated)

.                 egen upper5=pctile(hhppkg), p(95)
>  by(spdomain product);
(11 missing values generated)

. sum;

    Variable |       Obs        Mean    Std. Dev.  
>      Min        Max
-------------+-------------------------------------
> -------------------
        hhid |     15809    2.44e+09    1.16e+09   
> 1.01e+09   4.19e+09
     product |     15798    131.2775     16.2917   
>      102        161
        unit |     15798           1           0   
>        1          1
    food_cat |     15798           1           0   
>        1          1
    quantity |     15798    .7916805    2.808474   
> .0000429      227.4
-------------+-------------------------------------
> -------------------
       value |     15798    318.2154    466.6913   
>        0   8142.857
       count |     15798           1           0   
>        1          1
    descript |     15798           1           0   
>        1          1
      numreg |     15798     4.16078    1.291418   
>        1          5
    survquar |     15809    2.515023    1.165588   
>        1          4
-------------+-------------------------------------
> -------------------
    spdomain |     15809    3.176988    1.387498   
>        1          5
     reg_tpi |     15809    2.349484    1.147522   
>        1          4
    tpi_trim |     15809    1.010909    .0342491   
> .9592169   1.100966
     value_r |     15798    314.7535     462.268   
>        0   8489.067
 cons_pc_nom |     15809    1351.051     892.386   
> 78.55931   4466.259
-------------+-------------------------------------
> -------------------
      hhsize |     15809    5.708331    2.463885   
>        1         18
    hhweight |     15809    5051.077    4386.431   
>      100      60164
        bswt |     15809           1           0   
>        1          1
 cons_hh_nom |     15809     7092.23    4779.402   
> 232.1918   41911.81
 food_pc_nom |     15809    625.3658    395.8899   
>        0   2984.524
-------------+-------------------------------------
> -------------------
   nf_pc_nom |     15809    725.6852    619.6513   
> 23.11263   3923.402
 food_pc_tpi |     15809    620.4625    398.5883   
>        0   2984.524
 cons_pc_tpi |     15809    1346.148    896.7206   
> 77.24399   4457.659
   pctile_60 |     15809    1931.414    1165.033   
> 955.8005   4465.591
bottom_bas~t |     15809           1           0   
>        1          1
-------------+-------------------------------------
> -------------------
      hhppkg |     15798    1542.042    9722.969   
>        0   956335.4
      lower5 |     15798    527.7237    547.1752   
>        0   5904.947
      upper5 |     15798    2528.168    2200.834   
> 78.94154    13413.4

. describe;

Contains data from /tmp/St02502.000007
  obs:        15,809                          
 vars:            28                          20 Ma
> y 2013 12:16
 size:     2,023,552                          
---------------------------------------------------
              storage  display     value
variable name   type   format      label      varia
> ble label
---------------------------------------------------
hhid            double %9.0g                  house
                               > hold id
product         float  %10.0g      HS10A2     Food
                               product code:
                               numerical
unit            float  %10.0g                 set
                               equal to one since
                               all observations are
                               converted into kg
food_cat        float  %9.0g                  food
                               category equals 1,
                               if product is food
                               and 0 if non food
quantity        float  %9.0g                  daily
                               quantity consumed in
                               Kgs per household
value           float  %9.0g                  daily
                               value of consumption
                               in UGX per per
                               household
count           float  %9.0g                  
descript        float  %9.0g       descrip    produ
                               > ct description
                               including product
                               code but equals 2
                               for all non-foods
numreg          double %9.0g                  numbe
                               > r of goods in the
                               basket
survquar        float  %11.0g      lsurvquar
                                              Seque
                               > ntial Survey
                               Quarter May-Jun
                               09=1)
spdomain        float  %13.0g      spdomain_origina
                               > l
                                              
reg_tpi         float  %9.0g       REG_TPI    
tpi_trim        float  %9.0g                  TRIMM
                               > ED Temporal price
                               index (Q4=1)
value_r         float  %9.0g                  
cons_pc_nom     float  %9.0g                  
hhsize          double %9.0g                  House
                               > hold Size
hhweight        float  %9.0g                  House
                               > hold sample weight
bswt            float  %9.0g                  
cons_hh_nom     double %9.0g                  (sum)
                               cod_hh_nom
food_pc_nom     float  %9.0g                  nomin
                               > al food
                               consumption per
                               capita
nf_pc_nom       float  %9.0g                  nomin
                               > al non-food
                               consumption per
                               capita
food_pc_tpi     float  %9.0g                  Temp-
                               > adjusted per
                               capita food
                               consumption/day
cons_pc_tpi     float  %9.0g                  Temp
                               adjusted total
                               consumption/day
pctile_60       float  %9.0g                  (p
                               30) cons_pc_tpi
bottom_basket   float  %9.0g                  =1 if
                               in bottom (60%) of
                               PCE
hhppkg          float  %9.0g                  
lower5          float  %9.0g                  
upper5          float  %9.0g                  
---------------------------------------------------
Sorted by:  
     Note:  dataset has changed since last saved

. keep if hhppkg-lower5>=0 & hhppkg-upper5<=0;
(1143 observations deleted)

. *************************************************
> ********************
> * Note that we do prices in three ways. First, by
>  summing quantity and value 
> * This average price price_unitw is thus quantity
> /value weighted. Second, we
> * calculate the price and take simple means for a
>  transaction weighted
> * price, price_unitt. Last we take the median, pr
> ice_unitm. But in the end
> * we only use price_unitw
> *************************************************
> ********************;
.         gen price_unitt=value_r/(quantity*1000);

.         gen price_unitm=price_unitt;

.                 *CA modified to count the boot sa
> mple weight bswt;
.         collapse (sum) quantity value_r count bsw
> t 
>                  (mean) price_unitt 
>                  (median) price_unitm [aw=hhweigh
> t], by(spdomain product);

.         *Generate weighted price per gram ;
.         gen price_unitw=value_r/(quantity*1000);

.         drop value_r quantity;

.         sort spdomain product;

.         lab var price_unitt "simple average of ca
> lculated prices - transaction weighted";

.         lab var price_unitm "median of prices";

.         lab var price_unitw "value share weighted
>  mean prices";

. * Get an idea of the difference between the price
>  measures;
.         gen ratiotw=price_unitt/price_unitw;

.         gen ratiomw=price_unitm/price_unitw;

.         sum ratiotw ratiomw;

    Variable |       Obs        Mean    Std. Dev.  
>      Min        Max
-------------+-------------------------------------
> -------------------
     ratiotw |       208    1.240923    .4444796   
> .8704481   3.768888
     ratiomw |       208    1.094773    .5160427   
>        0    4.85301

.         sort product;

.         merge product using "$path/work/codes_foo
> d_basket_flex.dta";
variable product does not uniquely identify
    observations in the master data

.         tab _m;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |        208      100.00      100.00
------------+-----------------------------------
      Total |        208      100.00

.         count if _merge~=3;
    0

.         drop if _merge~=3;
(0 observations deleted)

.         drop _merge;

.         sort product spdomain;

. save "$path/work/price_unit_flex.dta", replace;
file /home/bjvca/data/data/GAP/Haruna/work/price_un
> it_flex.dta saved

. *************************************************
> ***************************************
> * 110_price_unit_flex.do                (end)
> *************************************************
> ***************************************;
. cap log close;
