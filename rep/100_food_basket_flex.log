---------------------------------------------------
      name:  <unnamed>
       log:  /home/bjvca/data/data/GAP/Haruna/rep/1
> 00_food_basket_flex.log
  log type:  text
 opened on:  20 May 2013, 12:16:27

. clear

. set more off

. #delimit ;
delimiter now ;
. *************************************************
> *************************
> * 100_food_basket_flex.do     (start)
> *
> * This file is to get the data from the cons_cod.
> dta in work and then 
> * to create the do file with the 90% of the consu
> mption expenditures 
> * using a flexible basket of goods.
> *
> * NOTE: we actually keep goods representing 95% o
> f expenditure
> * in order to facilitate dropping of some goods (
> such as rats) where
> * quantity and nutrition information is unknown.
> *
> * We base our basket on the bottom 60 percent of 
> consumption per capita
> * (weighted by hhweight*hhsize). We use the TEMPO
> RALLY-ADJUSTED
> * NOMINAL consumption because we don't have a spa
> tial adjustment yet.
> *
> * (Then we iterate this process to arrive at a fi
> nal food bundle in later code)
> *************************************************
> *************************;
. *CA modified to bring in hhdata into bootstrap;
. /*
> This file uses:
>                 work/cons_cod.dta
>                 work/hhdata.dta
>                 work/products.dta
>                 work/consump_nom.dta
>                 work/temp_index_reg_tpi.dta
>                 work/food_cat.dta
> 
> This file creates:
>                 work/food_basket_flex.dta
>                 work/codes_food_basket_flex.dta
> */
> 
> 
> 
> *do "$path/new/010_initial.do";
. *************************************************
> *************************;
. * First, make a small temp file that has the temp
> orally adjusted 
> * nominal consumption per capita, using work/cons
> ump_nom and 
> * work/temp_index_reg_tpi.dta. Make a dummy varia
> ble indicating
> * whether they are in the bottom 60%.
> *************************************************
> *************************;
. use "$path/work/conpc.dta", clear;

. *use "$path/work/consump_nom.dta", clear;
. *CA modified to merge in work/hhdata.dta for boot
> strap;
.         sort hhid;

.         merge hhid using "$path/work/hhdata.dta";

.         tab _m;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _m;

.         keep hhid hhweight hhsize cons_pc_nom reg
> _tpi rural survquar;

.         sort reg_tpi survquar;

.         cap drop _merge;

.         merge reg_tpi survquar using "$path/work/
> temp_index_reg_tpi.dta";
variables reg_tpi survquar do not uniquely
    identify observations in the master data
(label lsurvquar already defined)
(label REG_TPI already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

.         sort hhid;

.         merge hhid using "$path/work/conpc.dta";

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.         drop _merge;

.                 gen food_pc_tpi  = food_pc_nom /t
> pi_trim;

.         lab var food_pc_tpi "Temp-adjusted per ca
> pita food consumption/day";

.         gen cons_pc_tpi = food_pc_tpi + nf_pc_nom
> ;

.         lab var cons_pc_tpi "Temp adjusted total 
> consumption/day";

.         gen one=1;

.         tempfile contpi;

.         save `contpi', replace;
(note: file /tmp/St02502.000007 not found)
file /tmp/St02502.000007 saved

.         collapse (p$bottom) one cons_pc_tpi [aw=h
> hsize*hhweight] ;

.         rename cons_pc_tpi pctile_60;

.         tempfile 60pct;

.         sort one;

.         save `60pct', replace;
(note: file /tmp/St02502.000008 not found)
file /tmp/St02502.000008 saved

.                 use `contpi';

.                 sort one;

.                 merge one using `60pct';
variable one does not uniquely identify
    observations in the master data

.                 tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      6,775      100.00      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.                 drop _merge;

.                 drop one;

.                         gen bottom_basket=cons_pc
> _tpi< pctile_60;

.                 tab bottom_basket [aw=hhsize*hhwe
> ight];

bottom_bask |
         et |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 4,746.2627       70.06       70.06
          1 | 2,028.7373       29.94      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.                 lab var bottom_basket "=1 if in b
> ottom 60% of PCE";

.                                 sort hhid;

. save `contpi' , replace;
file /tmp/St02502.000007 saved

. *************************************************
> *************************;
. * Next, need to keep only the food products in or
> der to calculate the 
> * food poverty line, and then calculate the food 
> expenses by code.
> *************************************************
> *************************;
. use "$path/work/cons_cod.dta";

. /*
>         sort product;
>         merge product using "$path/work/food_cat.
> dta";
>         tab _merge;
>         keep if _merge==3;
>         drop _merge;
> */
>         
>         keep if food_cat;
(0 observations deleted)

.         codebook hhid;

---------------------------------------------------
hhid                                 Household Code
---------------------------------------------------

                  type:  numeric (double)

                 range:  [1.013e+09,4.193e+09]     
>    units:  1
         unique values:  6775                     m
> issing .:  0/412045

                  mean:   2.5e+09
              std. dev:   1.1e+09

           percentiles:        10%       25%       
> 50%                                              
>           75%                                    
>                     90%
                           1.0e+09   1.1e+09   2.2e
> +09                                              
>       3.2e+09                                    
>                 4.1e+09

.         sort hhid;

. *************************************************
> *************************;
. * Next, merge in the consumption information, and
>  select those in bottom
> * 60% of nominal distribution, after making tempo
> ral adjustment. 
> *************************************************
> *************************;
.         merge hhid using `contpi';
variable hhid does not uniquely identify
    observations in the master data

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    412,045      100.00      100.00
------------+-----------------------------------
      Total |    412,045      100.00

.         keep if _merge==3;
(0 observations deleted)

.         drop _merge;

.         keep if bottom_basket==1;
(308310 observations deleted)

.      ********************************************
> ******************************;
. * Calculate food shares. Since we're only doing s
> hares here, we can
> * work with the expenditures without doing tempor
> al adjustment.
> *************************************************
> *************************;
.           gen  food_expenditure= cod_hh_nom3;

.                             *gen  food_expenditur
> e= own_valued + daily_valued + monthly_valued + e
> duc_valued;
.           egen tot_food_expen= sum (food_expen), 
> by (hhid) ;

.           count if food_expenditure==.;
    0

.           count if tot_food_expen==.;
    0

.                     gen food_share= food_expendit
> ure/tot_food_expen;
(792 missing values generated)

.           count if food_share==.;
  792

.           drop if food_share==.;
(792 observations deleted)

.           sort hhid product;

.                         tempfile food_basket_flex
> ;

. save `food_basket_flex', replace;
(note: file /tmp/St02502.000009 not found)
file /tmp/St02502.000009 saved

. *************************************************
> *******************************;
. * Now prepare to get the variable spdomain to the
>  using dataset, and then find the 
> * total shares by each product in order to select
>  the most important goods in the 
> * basket.
> *************************************************
> *******************************;
.                 preserve;

.                 use "$path/work/hhdata.dta", clea
> r;

.                         keep hhid spdomain;

.                         sort hhid;

.                         tempfile spdomain;

.                 save `spdomain' , replace;
(note: file /tmp/St02502.00000b not found)
file /tmp/St02502.00000b saved

.                 restore;

.                            collapse (mean) hhweig
> ht, by (hhid);

.            sort hhid ;

.             merge hhid using `spdomain';

.            tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |      4,866       71.82       71.82
          3 |      1,909       28.18      100.00
------------+-----------------------------------
      Total |      6,775      100.00

.            drop if _m==2;
(4866 observations deleted)

.            drop _merge;

.             collapse (sum) hhweight , by(spdomain
> );

.            rename hhweight tothhweight;

.            tempfile tothhweight;

. save `tothhweight';
file /tmp/St02502.00000c saved

. use `food_basket_flex';

.           sort hhid;

.           merge hhid using `spdomain';
variable hhid does not uniquely identify
    observations in the master data

.           tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |      4,866        4.51        4.51
          3 |    102,943       95.49      100.00
------------+-----------------------------------
      Total |    107,809      100.00

.           sort _m;

.           drop if _m==2;
(4866 observations deleted)

.           drop _m;

.           sort spdomain;

.             merge spdomain using `tothhweight';
variable spdomain does not uniquely identify
    observations in the master data
(label spdomain_original already defined)

.           tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    102,943      100.00      100.00
------------+-----------------------------------
      Total |    102,943      100.00

.           drop _merge;

.             sort spdomain product;

.             gen f_share_w=(food_share*hhweight)/t
> othhweight;

.                                                 *
> drop descript;
.                         *gen descript = 0;
.             collapse (sum) f_share_w, by(spdomain
>  product descript);

.                      sort spdomain f_share_w;

.           by spdomain: gen cumshr= sum(f_share_w)
> ;

.                     count if cumshr<=.075;
  147

.           drop if cumshr<=.075;
(147 observations deleted)

.             lab var f_share_w "average food share
>  for the 13 regions";

. save "$path/work/food_basket_flex.dta", replace;
file /home/bjvca/data/data/GAP/Haruna/work/food_bas
> ket_flex.dta saved

. * List first spatial region to get an idea about 
> contents;
. list product spdomain f_share_w cumshr if spdomai
> n==1;

     +------------------------------------+
  1. | product |      spdomain | f_shar~w |
     |     132 | Central rural | .0064902 |
     |------------------------------------|
     |                cumshr              |
     |              .0767658              |
     +------------------------------------+

     +------------------------------------+
  2. | product |      spdomain | f_shar~w |
     |     157 | Central rural | .0070342 |
     |------------------------------------|
     |                cumshr              |
     |                 .0838              |
     +------------------------------------+

     +------------------------------------+
  3. | product |      spdomain | f_shar~w |
     |     137 | Central rural | .0070677 |
     |------------------------------------|
     |                cumshr              |
     |              .0908678              |
     +------------------------------------+

     +------------------------------------+
  4. | product |      spdomain | f_shar~w |
     |     118 | Central rural | .0075093 |
     |------------------------------------|
     |                cumshr              |
     |              .0983771              |
     +------------------------------------+

     +------------------------------------+
  5. | product |      spdomain | f_shar~w |
     |     139 | Central rural |  .007917 |
     |------------------------------------|
     |                cumshr              |
     |               .106294              |
     +------------------------------------+

     +------------------------------------+
  6. | product |      spdomain | f_shar~w |
     |     153 | Central rural | .0085809 |
     |------------------------------------|
     |                cumshr              |
     |               .114875              |
     +------------------------------------+

     +------------------------------------+
  7. | product |      spdomain | f_shar~w |
     |     102 | Central rural | .0087598 |
     |------------------------------------|
     |                cumshr              |
     |              .1236347              |
     +------------------------------------+

     +------------------------------------+
  8. | product |      spdomain | f_shar~w |
     |     122 | Central rural | .0098372 |
     |------------------------------------|
     |                cumshr              |
     |              .1334719              |
     +------------------------------------+

     +------------------------------------+
  9. | product |      spdomain | f_shar~w |
     |     135 | Central rural | .0104738 |
     |------------------------------------|
     |                cumshr              |
     |              .1439457              |
     +------------------------------------+

     +------------------------------------+
 10. | product |      spdomain | f_shar~w |
     |     117 | Central rural | .0119606 |
     |------------------------------------|
     |                cumshr              |
     |              .1559063              |
     +------------------------------------+

     +------------------------------------+
 11. | product |      spdomain | f_shar~w |
     |     150 | Central rural | .0137989 |
     |------------------------------------|
     |                cumshr              |
     |              .1697052              |
     +------------------------------------+

     +------------------------------------+
 12. | product |      spdomain | f_shar~w |
     |     125 | Central rural | .0139139 |
     |------------------------------------|
     |                cumshr              |
     |              .1836191              |
     +------------------------------------+

     +------------------------------------+
 13. | product |      spdomain | f_shar~w |
     |     123 | Central rural | .0141114 |
     |------------------------------------|
     |                cumshr              |
     |              .1977305              |
     +------------------------------------+

     +------------------------------------+
 14. | product |      spdomain | f_shar~w |
     |     134 | Central rural | .0155849 |
     |------------------------------------|
     |                cumshr              |
     |              .2133154              |
     +------------------------------------+

     +------------------------------------+
 15. | product |      spdomain | f_shar~w |
     |     127 | Central rural | .0169561 |
     |------------------------------------|
     |                cumshr              |
     |              .2302715              |
     +------------------------------------+

     +------------------------------------+
 16. | product |      spdomain | f_shar~w |
     |     144 | Central rural | .0182187 |
     |------------------------------------|
     |                cumshr              |
     |              .2484902              |
     +------------------------------------+

     +------------------------------------+
 17. | product |      spdomain | f_shar~w |
     |     136 | Central rural | .0223372 |
     |------------------------------------|
     |                cumshr              |
     |              .2708274              |
     +------------------------------------+

     +------------------------------------+
 18. | product |      spdomain | f_shar~w |
     |     140 | Central rural |  .025018 |
     |------------------------------------|
     |                cumshr              |
     |              .2958453              |
     +------------------------------------+

     +------------------------------------+
 19. | product |      spdomain | f_shar~w |
     |     108 | Central rural | .0275436 |
     |------------------------------------|
     |                cumshr              |
     |              .3233889              |
     +------------------------------------+

     +------------------------------------+
 20. | product |      spdomain | f_shar~w |
     |     112 | Central rural | .0288198 |
     |------------------------------------|
     |                cumshr              |
     |              .3522087              |
     +------------------------------------+

     +------------------------------------+
 21. | product |      spdomain | f_shar~w |
     |     147 | Central rural | .0372514 |
     |------------------------------------|
     |                cumshr              |
     |              .3894601              |
     +------------------------------------+

     +------------------------------------+
 22. | product |      spdomain | f_shar~w |
     |     138 | Central rural |  .037537 |
     |------------------------------------|
     |                cumshr              |
     |              .4269971              |
     +------------------------------------+

     +------------------------------------+
 23. | product |      spdomain | f_shar~w |
     |     103 | Central rural | .0500118 |
     |------------------------------------|
     |                cumshr              |
     |               .477009              |
     +------------------------------------+

     +------------------------------------+
 24. | product |      spdomain | f_shar~w |
     |     141 | Central rural | .0610395 |
     |------------------------------------|
     |                cumshr              |
     |              .5380485              |
     +------------------------------------+

     +------------------------------------+
 25. | product |      spdomain | f_shar~w |
     |     104 | Central rural | .0611586 |
     |------------------------------------|
     |                cumshr              |
     |              .5992071              |
     +------------------------------------+

     +------------------------------------+
 26. | product |      spdomain | f_shar~w |
     |     107 | Central rural | .0639378 |
     |------------------------------------|
     |                cumshr              |
     |              .6631449              |
     +------------------------------------+

     +------------------------------------+
 27. | product |      spdomain | f_shar~w |
     |     113 | Central rural | .1620319 |
     |------------------------------------|
     |                cumshr              |
     |              .8251768              |
     +------------------------------------+

     +------------------------------------+
 28. | product |      spdomain | f_shar~w |
     |     105 | Central rural | .1748232 |
     |------------------------------------|
     |                cumshr              |
     |                     1              |
     +------------------------------------+

.                     gen numreg=1;

.           collapse (sum) numreg cumshr, by (produ
> ct descript);

.                           keep product descript n
> umreg;

.           display _N;
42

.                     lab var numreg "number of goo
> ds in the basket";

. /*
>           merge product using "$path/work/product
> s.dta";
>             tab _merge;
>           keep if _merge==3;
> */
>           keep product descript numreg;

.             sort product;

.                display _N;
42

.   save "$path/work/codes_food_basket_flex.dta", r
> eplace;
file /home/bjvca/data/data/GAP/Haruna/work/codes_fo
> od_basket_flex.dta saved

. *************************************************
> *************************
> * 100_food_basket_flex.do     (end)
> *************************************************
> *************************;
. cap log close;
