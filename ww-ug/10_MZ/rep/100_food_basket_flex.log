-------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA\ww-ug\10_MZ/rep/100_food_ba
> sket_flex.log
  log type:  text
 opened on:  17 May 2013, 16:44:27

. clear

. set more off

. #delimit ;
delimiter now ;
. **************************************************************************
> * 100_food_basket_flex.do     (start)
> *
> * This file is to get the data from the cons_cod.dta in work and then 
> * to create the do file with the 90% of the consumption expenditures 
> * using a flexible basket of goods.
> *
> * NOTE: we actually keep goods representing 95% of expenditure
> * in order to facilitate dropping of some goods (such as rats) where
> * quantity and nutrition information is unknown.
> *
> * We base our basket on the bottom 60 percent of consumption per capita
> * (weighted by hhweight*hhsize). We use the TEMPORALLY-ADJUSTED
> * NOMINAL consumption because we don't have a spatial adjustment yet.
> *
> * (Then we iterate this process to arrive at a final food bundle in later code)
> **************************************************************************;
. *CA modified to bring in hhdata into bootstrap;
. /*
> This file uses:
>                 work\cons_cod.dta
>                 work\hhdata.dta
>                 work\products.dta
>                 work/consump_nom.dta
>                 work/temp_index_reg_tpi.dta
>                 work/food_cat.dta
> 
> This file creates:
>                 work\food_basket_flex.dta
>                 work\codes_food_basket_flex.dta
> */
> 
> 
> 
> *do "$path/new/010_initial.do";
. **************************************************************************;
. * First, make a small temp file that has the temporally adjusted 
> * nominal consumption per capita, using work/consump_nom and 
> * work/temp_index_reg_tpi.dta. Make a dummy variable indicating
> * whether they are in the bottom 60%.
> **************************************************************************;
. use "$path/work/conpc.dta", clear;

. *use "$path/work/consump_nom.dta", clear;
. *CA modified to merge in work\hhdata.dta for bootstrap;
.         sort hhid;

.         merge hhid using "$path/work\hhdata.dta";

.         tab _m;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |     10,832      100.00      100.00
------------+-----------------------------------
      Total |     10,832      100.00

.         drop _m;

.         keep hhid hhweight hhsize cons_pc_nom reg_tpi rural survquar;

.         sort reg_tpi survquar;

.         cap drop _merge;

.         merge reg_tpi survquar using "$path/work/temp_index_reg_tpi.dta";
variables reg_tpi survquar do not uniquely identify observations in the master data
(label survquar already defined)
(label news_ru_ur already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |     10,832      100.00      100.00
------------+-----------------------------------
      Total |     10,832      100.00

.         drop _merge;

.         sort hhid;

.         merge hhid using "$path/work/conpc.dta";

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |     10,832      100.00      100.00
------------+-----------------------------------
      Total |     10,832      100.00

.         drop _merge;

.                 gen food_pc_tpi  = food_pc_nom /tpi_trim;

.         lab var food_pc_tpi "Temp-adjusted per capita food consumption/day";

.         gen cons_pc_tpi = food_pc_tpi + nf_pc_nom;

.         lab var cons_pc_tpi "Temp adjusted total consumption/day";

.         gen one=1;

.         tempfile contpi;

.         save `contpi', replace;
(note: file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000001.tmp not found)
file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000001.tmp saved

.         collapse (p$bottom) one cons_pc_tpi [aw=hhsize*hhweight] ;

.         rename cons_pc_tpi pctile_60;

.         tempfile 60pct;

.         sort one;

.         save `60pct', replace;
(note: file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000002.tmp not found)
file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000002.tmp saved

.                 use `contpi';

.                 sort one;

.                 merge one using `60pct';
variable one does not uniquely identify observations in the master data

.                 tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |     10,832      100.00      100.00
------------+-----------------------------------
      Total |     10,832      100.00

.                 drop _merge;

.                 drop one;

.                         gen bottom_basket=cons_pc_tpi< pctile_60;

.                 tab bottom_basket [aw=hhsize*hhweight];

bottom_bask |
         et |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |4,333.00951       40.00       40.00
          1 |6,498.99049       60.00      100.00
------------+-----------------------------------
      Total |     10,832      100.00

.                 lab var bottom_basket "=1 if in bottom 60% of PCE";

.                                 sort hhid;

. save `contpi' , replace;
file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000001.tmp saved

. **************************************************************************;
. * Next, need to keep only the food products in order to calculate the 
> * food poverty line, and then calculate the food expenses by code.
> **************************************************************************;
. use "$path/work/cons_cod.dta";

. /*
>         sort product;
>         merge product using "$path/work/food_cat.dta";
>         tab _merge;
>         keep if _merge==3;
>         drop _merge;
> */
>         
>         keep if food_cat;
(130896 observations deleted)

.         codebook hhid;

-------------------------------------------------------------------------------------------
hhid                                                                           Household ID
-------------------------------------------------------------------------------------------

                  type:  numeric (float)

                 range:  [1005,1060074]               units:  1
         unique values:  10832                    missing .:  0/126625

                  mean:    562972
              std. dev:    327800

           percentiles:        10%       25%       50%       75%       90%
                            102014    259107    585044    874070   1.0e+06

.         sort hhid;

. **************************************************************************;
. * Next, merge in the consumption information, and select those in bottom
> * 60% of nominal distribution, after making temporal adjustment. 
> **************************************************************************;
.         merge hhid using `contpi';
variable hhid does not uniquely identify observations in the master data

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    126,625      100.00      100.00
------------+-----------------------------------
      Total |    126,625      100.00

.         keep if _merge==3;
(0 observations deleted)

.         drop _merge;

.         keep if bottom_basket==1;
(76453 observations deleted)

.      **************************************************************************;
. * Calculate food shares. Since we're only doing shares here, we can
> * work with the expenditures without doing temporal adjustment.
> **************************************************************************;
.           gen  food_expenditure= cod_hh_nom3;

.                             *gen  food_expenditure= own_valued + daily_valued + monthly_v
> alued + educ_valued;
.           egen tot_food_expen= sum (food_expen), by (hhid) ;

.           count if food_expenditure==.;
    0

.           count if tot_food_expen==.;
    0

.                     gen food_share= food_expenditure/tot_food_expen;
(65 missing values generated)

.           count if food_share==.;
   65

.           drop if food_share==.;
(65 observations deleted)

.           sort hhid product;

.                         tempfile food_basket_flex;

. save `food_basket_flex', replace;
(note: file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000003.tmp not found)
file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000003.tmp saved

. ********************************************************************************;
. * Now prepare to get the variable spdomain to the using dataset, and then find the 
> * total shares by each product in order to select the most important goods in the 
> * basket.
> ********************************************************************************;
.                 preserve;

.                 use "$path/work/hhdata.dta", clear;

.                         keep hhid spdomain;

.                         sort hhid;

.                         tempfile spdomain;

.                 save `spdomain' , replace;
(note: file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000005.tmp not found)
file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000005.tmp saved

.                 restore;

.                            collapse (mean) hhweight, by (hhid);

.            sort hhid ;

.             merge hhid using `spdomain';

.            tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |      5,815       53.68       53.68
          3 |      5,017       46.32      100.00
------------+-----------------------------------
      Total |     10,832      100.00

.            drop if _m==2;
(5815 observations deleted)

.            drop _merge;

.             collapse (sum) hhweight , by(spdomain);

.            rename hhweight tothhweight;

.            tempfile tothhweight;

. save `tothhweight';
file C:\Users\TEMPLE~1\AppData\Local\Temp\ST_0j000006.tmp saved

. use `food_basket_flex';

.           sort hhid;

.           merge hhid using `spdomain';
variable hhid does not uniquely identify observations in the master data

.           tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |      5,815       10.40       10.40
          3 |     50,107       89.60      100.00
------------+-----------------------------------
      Total |     55,922      100.00

.           sort _m;

.           drop if _m==2;
(5815 observations deleted)

.           drop _m;

.           sort spdomain;

.             merge spdomain using `tothhweight';
variable spdomain does not uniquely identify observations in the master data
(label reg13 already defined)

.           tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |     50,107      100.00      100.00
------------+-----------------------------------
      Total |     50,107      100.00

.           drop _merge;

.             sort spdomain product;

.             gen f_share_w=(food_share*hhweight)/tothhweight;

.                                                 *drop descript;
.                         *gen descript = 0;
.             collapse (sum) f_share_w, by(spdomain product descript);

.                      sort spdomain f_share_w;

.           by spdomain: gen cumshr= sum(f_share_w);

.                     count if cumshr<=.075;
 1038

.           drop if cumshr<=.075;
(1038 observations deleted)

.             lab var f_share_w "average food share for the 13 regions";

. save "$path\work\food_basket_flex.dta", replace;
file C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA\ww-ug\10_MZ\work\food_basket_flex.d
> ta saved

. * List first spatial region to get an idea about contents;
. list product spdomain f_share_w cumshr if spdomain==1;

     +---------------------------------------------------------+
     | product                  spdomain   f_shar~w     cumshr |
     |---------------------------------------------------------|
  1. |   11676   Niassa & Cabo Delg.-rur   .0045555   .0761324 |
  2. |   11244   Niassa & Cabo Delg.-rur   .0048407    .080973 |
  3. |   11736   Niassa & Cabo Delg.-rur   .0052354   .0862084 |
  4. |   11354   Niassa & Cabo Delg.-rur   .0054018   .0916102 |
  5. |   11781   Niassa & Cabo Delg.-rur   .0055502   .0971605 |
     |---------------------------------------------------------|
  6. |   11737   Niassa & Cabo Delg.-rur   .0059509   .1031113 |
  7. |   11783   Niassa & Cabo Delg.-rur   .0061833   .1092947 |
  8. |   11751   Niassa & Cabo Delg.-rur   .0069238   .1162184 |
  9. |   11753   Niassa & Cabo Delg.-rur   .0070407   .1232592 |
 10. |   11132   Niassa & Cabo Delg.-rur   .0073268    .130586 |
     |---------------------------------------------------------|
 11. |   11623   Niassa & Cabo Delg.-rur   .0080298   .1386158 |
 12. |   11812   Niassa & Cabo Delg.-rur   .0097388   .1483545 |
 13. |   11755   Niassa & Cabo Delg.-rur   .0097467   .1581013 |
 14. |   11715   Niassa & Cabo Delg.-rur   .0099373   .1680385 |
 15. |   11731   Niassa & Cabo Delg.-rur   .0104351   .1784736 |
     |---------------------------------------------------------|
 16. |   11143   Niassa & Cabo Delg.-rur   .0108681   .1893417 |
 17. |   11133   Niassa & Cabo Delg.-rur   .0112947   .2006364 |
 18. |   11719   Niassa & Cabo Delg.-rur   .0116148   .2122512 |
 19. |   11121   Niassa & Cabo Delg.-rur   .0124618   .2247129 |
 20. |   11754   Niassa & Cabo Delg.-rur   .0136805   .2383934 |
     |---------------------------------------------------------|
 21. |  117392   Niassa & Cabo Delg.-rur   .0156328   .2540262 |
 22. |   11279   Niassa & Cabo Delg.-rur   .0180708    .272097 |
 23. |   11712   Niassa & Cabo Delg.-rur   .0200467   .2921437 |
 24. |   11782   Niassa & Cabo Delg.-rur   .0202422   .3123859 |
 25. |   11541   Niassa & Cabo Delg.-rur   .0223212   .3347071 |
     |---------------------------------------------------------|
 26. |   11713   Niassa & Cabo Delg.-rur   .0300423   .3647495 |
 27. |   11674   Niassa & Cabo Delg.-rur   .0307587   .3955082 |
 28. |   11738   Niassa & Cabo Delg.-rur   .0322078    .427716 |
 29. |   11112   Niassa & Cabo Delg.-rur    .041687   .4694031 |
 30. |   11752   Niassa & Cabo Delg.-rur   .0428736   .5122766 |
     |---------------------------------------------------------|
 31. |   11311   Niassa & Cabo Delg.-rur   .0563368   .5686135 |
 32. |   11361   Niassa & Cabo Delg.-rur   .0659862   .6345997 |
 33. |   11146   Niassa & Cabo Delg.-rur   .1225905   .7571902 |
 34. |   11141   Niassa & Cabo Delg.-rur   .2428098          1 |
     +---------------------------------------------------------+

.                     gen numreg=1;

.           collapse (sum) numreg cumshr, by (product descript);

.                           keep product descript numreg;

.           display _N;
69

.                     lab var numreg "number of goods in the basket";

. /*
>           merge product using "$path\work\products.dta";
>             tab _merge;
>           keep if _merge==3;
> */
>           keep product descript numreg;

.             sort product;

.                display _N;
69

.   save "$path/work\codes_food_basket_flex.dta", replace;
file C:\Users\Templeton\Desktop\GAPP\GAPP-UGANDA-HARUNA\ww-ug\10_MZ/work\codes_food_basket_
> flex.dta saved

. **************************************************************************
> * 100_food_basket_flex.do     (end)
> **************************************************************************;
. cap log close;
