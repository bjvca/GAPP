------------------------------------------------------------
      name:  <unnamed>
       log:  /home/bjvca/data/data/GAP/Haruna/UNPS_2011/GAPP
> 3//rep/100_food_basket_flex.log
  log type:  text
 opened on:  23 Oct 2013, 16:01:35

. clear

. set more off

. #delimit ;
delimiter now ;
. **********************************************************
> ****************
> * 100_food_basket_flex.do     (start)
> *
> * This file is to get the data from the cons_cod.dta in wo
> rk and then 
> * to create the do file with the 90% of the consumption ex
> penditures 
> * using a flexible basket of goods.
> *
> * NOTE: we actually keep goods representing 95% of expendi
> ture
> * in order to facilitate dropping of some goods (such as r
> ats) where
> * quantity and nutrition information is unknown.
> *
> * We base our basket on the bottom 60 percent of consumpti
> on per capita
> * (weighted by hhweight*hhsize). We use the TEMPORALLY-ADJ
> USTED
> * NOMINAL consumption because we don't have a spatial adju
> stment yet.
> *
> * (Then we iterate this process to arrive at a final food 
> bundle in later code)
> **********************************************************
> ****************;
. *CA modified to bring in hhdata into bootstrap;
. /*
> This file uses:
>                 work/cons_cod.dta
>                 work/hhdata.dta
>                 work/products.dta
>                 work/consump_nom.dta
>                 work/temp_index_reg_tpi.dta
>                 work/food_cat.dta
> 
> This file creates:
>                 work/food_basket_flex.dta
>                 work/codes_food_basket_flex.dta
> */
> 
> 
> 
> *do "$path/new/010_initial.do";
. **********************************************************
> ****************;
. * First, make a small temp file that has the temporally ad
> justed 
> * nominal consumption per capita, using work/consump_nom a
> nd 
> * work/temp_index_reg_tpi.dta. Make a dummy variable indic
> ating
> * whether they are in the bottom 60%.
> **********************************************************
> ****************;
. use "$path/work/conpc.dta", clear;

. *use "$path/work/consump_nom.dta", clear;
. *CA modified to merge in work/hhdata.dta for bootstrap;
.         sort hhid;

.         merge hhid using "$path/work/hhdata.dta";

.         tab _m;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          1        0.04        0.04
          3 |      2,716       99.96      100.00
------------+-----------------------------------
      Total |      2,717      100.00

.         drop _m;

.         keep hhid hhweight hhsize cons_pc_nom reg_tpi rura
> l survquar;

.         sort reg_tpi survquar;

.         cap drop _merge;

.         merge reg_tpi survquar using "$path/work/temp_inde
> x_reg_tpi.dta";
variables reg_tpi survquar do not uniquely identify
    observations in the master data
(label lsurvquar already defined)
(label lbreg already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |         49        1.80        1.80
          3 |      2,668       98.20      100.00
------------+-----------------------------------
      Total |      2,717      100.00

.         drop _merge;

.         sort hhid;

.         merge hhid using "$path/work/conpc.dta";

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      2,717      100.00      100.00
------------+-----------------------------------
      Total |      2,717      100.00

.         drop _merge;

.                 gen food_pc_tpi  = food_pc_nom /tpi_trim;
(49 missing values generated)

.         lab var food_pc_tpi "Temp-adjusted per capita food
>  consumption/day";

.         gen cons_pc_tpi = food_pc_tpi + nf_pc_nom;
(49 missing values generated)

.         lab var cons_pc_tpi "Temp adjusted total consumpti
> on/day";

.         gen one=1;

.         tempfile contpi;

.         save `contpi', replace;
(note: file /tmp/St09373.000001 not found)
file /tmp/St09373.000001 saved

.         collapse (p$bottom) one cons_pc_tpi [aw=hhsize*hhw
> eight] ;

.         rename cons_pc_tpi pctile_60;

.         tempfile 60pct;

.         sort one;

.         save `60pct', replace;
(note: file /tmp/St09373.000002 not found)
file /tmp/St09373.000002 saved

.                 use `contpi';

.                 sort one;

.                 merge one using `60pct';
variable one does not uniquely identify observations in
    the master data

.                 tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      2,717      100.00      100.00
------------+-----------------------------------
      Total |      2,717      100.00

.                 drop _merge;

.                 drop one;

.                         gen bottom_basket=cons_pc_tpi< pct
> ile_60;

.                 tab bottom_basket [aw=hhsize*hhweight];

bottom_bask |
         et |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |1,383.54757       50.98       50.98
          1 |1,330.45243       49.02      100.00
------------+-----------------------------------
      Total |      2,714      100.00

.                 lab var bottom_basket "=1 if in bottom 60%
>  of PCE";

.                                 sort hhid;

. save `contpi' , replace;
file /tmp/St09373.000001 saved

. **********************************************************
> ****************;
. * Next, need to keep only the food products in order to ca
> lculate the 
> * food poverty line, and then calculate the food expenses 
> by code.
> **********************************************************
> ****************;
. use "$path/work/cons_cod.dta";

. /*
>         sort product;
>         merge product using "$path/work/food_cat.dta";
>         tab _merge;
>         keep if _merge==3;
>         drop _merge;
> */
>         
>         keep if food_cat;
(0 observations deleted)

.         codebook hhid;

------------------------------------------------------------
hhid                 Unique HH Identifier Across Panel Waves
------------------------------------------------------------

                  type:  numeric (double)

                 range:  [1.013e+09,2.115e+14]        units:
>   1
         unique values:  2712                     missing .:
>   283/37116

                  mean:   1.3e+11
              std. dev:   4.1e+12

           percentiles:        10%       25%       50%      
>  75%                                                      
>            90%
                           1.1e+09   1.1e+09   2.2e+09   4.0
> e+09                                                      
>        1.1e+11

.         sort hhid;

. **********************************************************
> ****************;
. * Next, merge in the consumption information, and select t
> hose in bottom
> * 60% of nominal distribution, after making temporal adjus
> tment. 
> **********************************************************
> ****************;
.         merge hhid using `contpi';
variable hhid does not uniquely identify observations in
    the master data

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |          4        0.01        0.01
          3 |     37,116       99.99      100.00
------------+-----------------------------------
      Total |     37,120      100.00

.         keep if _merge==3;
(4 observations deleted)

.         drop _merge;

.         keep if bottom_basket==1;
(22699 observations deleted)

.      *****************************************************
> *********************;
. * Calculate food shares. Since we're only doing shares her
> e, we can
> * work with the expenditures without doing temporal adjust
> ment.
> **********************************************************
> ****************;
.           gen  food_expenditure= cod_hh_nom;

.                             *gen  food_expenditure= own_va
> lued + daily_valued + monthly_valued + educ_valued;
.           egen tot_food_expen= sum (food_expen), by (hhid)
>  ;

.           count if food_expenditure==.;
    0

.           count if tot_food_expen==.;
    0

.                     gen food_share= food_expenditure/tot_f
> ood_expen;
(10 missing values generated)

.           count if food_share==.;
   10

.           drop if food_share==.;
(10 observations deleted)

.           sort hhid product;

.                         tempfile food_basket_flex;

. save `food_basket_flex', replace;
(note: file /tmp/St09373.000003 not found)
file /tmp/St09373.000003 saved

. **********************************************************
> **********************;
. * Now prepare to get the variable spdomain to the using da
> taset, and then find the 
> * total shares by each product in order to select the most
>  important goods in the 
> * basket.
> **********************************************************
> **********************;
.                 preserve;

.                 use "$path/work/hhdata.dta", clear;
(Household master record (1 record per household))

.                         keep hhid spdomain;

.                         sort hhid;

.                         tempfile spdomain;

.                 save `spdomain' , replace;
(note: file /tmp/St09373.000005 not found)
file /tmp/St09373.000005 saved

.                 restore;

.                            collapse (mean) hhweight, by (h
> hid);

.            sort hhid ;

.             merge hhid using `spdomain';

.            tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |      1,451       53.42       53.42
          3 |      1,265       46.58      100.00
------------+-----------------------------------
      Total |      2,716      100.00

.            drop if _m==2;
(1451 observations deleted)

.            drop _merge;

.             collapse (sum) hhweight , by(spdomain);

.            rename hhweight tothhweight;

.            tempfile tothhweight;

. save `tothhweight';
file /tmp/St09373.000006 saved

. use `food_basket_flex';

.           sort hhid;

.           merge hhid using `spdomain';
variable hhid does not uniquely identify observations in
    the master data

.           tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |      1,451        9.15        9.15
          3 |     14,407       90.85      100.00
------------+-----------------------------------
      Total |     15,858      100.00

.           sort _m;

.           drop if _m==2;
(1451 observations deleted)

.           drop _m;

.           sort spdomain;

.             merge spdomain using `tothhweight';
variable spdomain does not uniquely identify observations
    in the master data
(label lspdomain already defined)

.           tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |     14,407      100.00      100.00
------------+-----------------------------------
      Total |     14,407      100.00

.           drop _merge;

.             sort spdomain product;

.             gen f_share_w=(food_share*hhweight)/tothhweigh
> t;

.                                                 *drop desc
> ript;
.                         *gen descript = 0;
.             collapse (sum) f_share_w, by(spdomain product 
> descript);

.                      sort spdomain f_share_w;

.           by spdomain: gen cumshr= sum(f_share_w);

.                     count if cumshr<=.075;
  149

.           drop if cumshr<=.075;
(149 observations deleted)

.             lab var f_share_w "average food share for the 
> 13 regions";

. save "$path/work/food_basket_flex.dta", replace;
file /home/bjvca/data/data/GAP/Haruna/UNPS_2011/GAPP3//work/
> food_basket_flex.dta saved

. * List first spatial region to get an idea about contents;
. list product spdomain f_share_w cumshr if spdomain==1;

     +------------------------------------------+
     | product   spdomain   f_shar~w     cumshr |
     |------------------------------------------|
  1. |     150    Central   .0072882   .0819964 |
  2. |     138    Central   .0073462   .0893425 |
  3. |     114    Central   .0076678   .0970103 |
  4. |     134    Central   .0079754   .1049857 |
  5. |     122    Central   .0079987   .1129844 |
     |------------------------------------------|
  6. |     135    Central   .0085053   .1214897 |
  7. |     139    Central   .0105225   .1320122 |
  8. |     105    Central   .0108133   .1428255 |
  9. |     125    Central   .0110401   .1538657 |
 10. |     127    Central   .0113729   .1652385 |
     |------------------------------------------|
 11. |     110    Central    .012941   .1781795 |
 12. |     136    Central   .0133429   .1915224 |
 13. |     117    Central   .0134696    .204992 |
 14. |     108    Central   .0158653   .2208573 |
 15. |     144    Central   .0208415   .2416988 |
     |------------------------------------------|
 16. |     140    Central   .0244673    .266166 |
 17. |     107    Central   .0248364   .2910024 |
 18. |     147    Central   .0316927   .3226951 |
 19. |     141    Central   .0399678   .3626629 |
 20. |     101    Central   .0541264   .4167894 |
     |------------------------------------------|
 21. |     157    Central   .0594484   .4762377 |
 22. |       .    Central   .0878934   .5641311 |
 23. |     113    Central   .0904238   .6545549 |
 24. |     999    Central   .3454451          1 |
     +------------------------------------------+

.                     gen numreg=1;

.           collapse (sum) numreg cumshr, by (product descri
> pt);

.                           keep product descript numreg;

.           display _N;
38

.                     lab var numreg "number of goods in the
>  basket";

. /*
>           merge product using "$path/work/products.dta";
>             tab _merge;
>           keep if _merge==3;
> */
>           keep product descript numreg;

.             sort product;

.                display _N;
38

.   save "$path/work/codes_food_basket_flex.dta", replace;
file /home/bjvca/data/data/GAP/Haruna/UNPS_2011/GAPP3//work/
> codes_food_basket_flex.dta saved

. **********************************************************
> ****************
> * 100_food_basket_flex.do     (end)
> **********************************************************
> ****************;
. cap log close;
