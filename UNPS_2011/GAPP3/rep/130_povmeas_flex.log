------------------------------------------------------------
      name:  <unnamed>
       log:  /home/bjvca/data/data/GAP/Haruna/UNPS_2011/GAPP
> 3//rep/130_povmeas_flex.log
  log type:  text
 opened on:  23 Oct 2013, 16:01:36

. clear

. set more off

. #delimit ;
delimiter now ;
. **********************************************************
> ****************
> * 130_povmeas_flex.do           (start)
> *
> * Purpose:
> * Initial poverty measures calculation for flexible basket
> . (Before any iteration)
> **********************************************************
> ****************;
. *CA modified to add work/hhdata.dta for bootstrap;
. /*
> This file uses:
>         in/foodshr96.dta
>         work/povline_f_flex.dta
>         work/consump_nom.dta
>         work/hhdata.dta
>         work/temp_index_reg_tpi.dta
> 
> This file creates:
>         work/foodshr96.dta
>         work/povmeas.dta
>         work/povlines.dta
>         work/cons_real.dta
> */
> 
> 
> 
> **********************************************************
> ****************;
. * Bring in data file with nominal consumption per capita, 
> and deflate it
> * by temporal price index.
> **********************************************************
> ****************;
. use "$path/work/hhdata.dta", clear;
(Household master record (1 record per household))

.         keep hhid strata reg_tpi spdomain news rural survm
> on survquar;

.         tab reg_tpi, miss;

    Regions |
   used for |
   temporal |
price index |
calculation |
          s |      Freq.     Percent        Cum.
------------+-----------------------------------
    Central |        841       30.96       30.96
    Eastern |        647       23.82       54.79
   Northern |        693       25.52       80.30
    Western |        535       19.70      100.00
------------+-----------------------------------
      Total |      2,716      100.00

.         tab survquar, miss;

    Sequential |
Survey Quarter |
 (Oct-Dec 10 = |
            1) |      Freq.     Percent        Cum.
---------------+-----------------------------------
    Oct-Dec 10 |        690       25.41       25.41
   Jan-Marc 11 |        692       25.48       50.88
   Apr-June 11 |        676       24.89       75.77
July-Sept 2011 |        610       22.46       98.23
             . |         48        1.77      100.00
---------------+-----------------------------------
         Total |      2,716      100.00

.         keep hhid spdomain reg_tpi survquar;

.         sort hhid;

.         tempfile spdomainreg_tpi;

. save `spdomainreg_tpi', replace;
(note: file /tmp/St09373.000001 not found)
file /tmp/St09373.000001 saved

. use "$path/work/conpc.dta", clear;

. *use "$path/work/consump_nom.dta", clear;
. *CA modified to merge in work/hhdata.dta for bootstrap;
.     sort hhid;

.     merge hhid using "$path/work/hhdata.dta";

.     tab _m;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          1        0.04        0.04
          3 |      2,716       99.96      100.00
------------+-----------------------------------
      Total |      2,717      100.00

.     drop _m;

.         keep hhid hhweight hhsize cons_pc_nom ;

.         sort hhid;

.         merge hhid using `spdomainreg_tpi';
(label lbreg already defined)
(label lsurvquar already defined)
(label lspdomain already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          1        0.04        0.04
          3 |      2,716       99.96      100.00
------------+-----------------------------------
      Total |      2,717      100.00

.         drop _merge;

.         sort reg_tpi survquar;

.         merge reg_tpi survquar using "$path/work/temp_inde
> x_reg_tpi.dta";
variables reg_tpi survquar do not uniquely identify
    observations in the master data
(label lsurvquar already defined)
(label lbreg already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |         49        1.80        1.80
          3 |      2,668       98.20      100.00
------------+-----------------------------------
      Total |      2,717      100.00

.         drop _merge;

.         sort hhid;

.         merge hhid using "$path/work/conpc.dta";

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      2,717      100.00      100.00
------------+-----------------------------------
      Total |      2,717      100.00

.         drop _merge;

.         gen food_pc_tpi  = food_pc_nom /tpi_trim;
(49 missing values generated)

.         lab var food_pc_tpi "Temp-adjusted per capita food
>  consumption/day";

.                 gen cons_pc_tpi = food_pc_tpi + nf_pc_nom;
(49 missing values generated)

.         lab var cons_pc_tpi "Temp adjusted total consumpti
> on/day";

.         gen one=1;

. * TPI deflated per capita consumption ;
.         tempfile contpi;

. save `contpi', replace;
(note: file /tmp/St09373.000002 not found)
file /tmp/St09373.000002 saved

. **********************************************************
> ****************
> * Calculate non-food expenditure for HH around the food po
> verty line
> *
> * Develop a discrete triangular weighted distribution. Thi
> s gives a
> * weight of  1 to HH at +/- 18-20% from food poverty line,
>  and
> * weight of  2 to HH at +/- 16-18% from food poverty line,
>  and ...
> * weight of 10 to HH at +/-  0- 2% from food poverty line.
> * This weight is called triwt below.
> **********************************************************
> ****************;
. use `contpi';

.         sort spdomain;

.         merge spdomain using "$path/work/povline_food_flex
> .dta";
variable spdomain does not uniquely identify observations
    in the master data
(label lspdomain already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          9        0.33        0.33
          3 |      2,708       99.67      100.00
------------+-----------------------------------
      Total |      2,717      100.00

.         drop _merge;

. gen     triwt = 0 ;

. replace triwt = 11 - round(50*abs(cons_pc_tpi/povline_f_fl
> ex-1)+0.5)
>                 if abs(cons_pc_tpi/povline_f_flex-1)<=0.2;
(279 real changes made)

.                                         * Nearness to pove
> rty line and population weights ;
.         gen tripopwt=triwt*hhweight*hhsize;
(3 missing values generated)

.         preserve;

.                 collapse (mean) nf_pc_nom [aw=tripopwt] ,
>                         by(spdomain);

.                                         rename nf_pc_nom p
> ovline_na_flex;

.                 lab var povline_na_flex "Nonfood poverty l
> ine. Flexible bundle";

.                                 tempfile znf;

.                 sort spdomain;

.                 save `znf', replace;
(note: file /tmp/St09373.000004 not found)
file /tmp/St09373.000004 saved

.                 tab spdomain;

    Spatial |
   domains: |
  each with |
own poverty |
 line (they |
     are 4) |      Freq.     Percent        Cum.
------------+-----------------------------------
    Central |          1       25.00       25.00
    Eastern |          1       25.00       50.00
   Northern |          1       25.00       75.00
    Western |          1       25.00      100.00
------------+-----------------------------------
      Total |          4      100.00

.         restore;

.         sort spdomain;

.         merge spdomain using `znf';
variable spdomain does not uniquely identify observations
    in the master data
(label lspdomain already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          9        0.33        0.33
          3 |      2,708       99.67      100.00
------------+-----------------------------------
      Total |      2,717      100.00

.         drop _merge;

. **********************************************************
> ****************;
. * Poverty line is the sum of the food and non-food poverty
>  lines
> **********************************************************
> ****************;
.         gen povline_flex=povline_f_flex + povline_na_flex;
(9 missing values generated)

.         lab var povline_flex "Poverty line. Flexible bundl
> e";

.         sort spdomain;

. save "$path/work/povlines.dta", replace;
file /home/bjvca/data/data/GAP/Haruna/UNPS_2011/GAPP3//work/
> povlines.dta saved

. **********************************************************
> ****************;
. * Create spatial price index, based on the total poverty l
> ine, with
> * adjustment so that mean (and total) nominal consumption 
> equals
> * mean (and total) spatially deflated consumption.
> *
> * Choose arbitrary strata to be the base at first: we just
>  use the first stratum.
> **********************************************************
> ****************;
. use `contpi';

.         sort spdomain;

.         merge spdomain using "$path/work/povlines.dta";
variable spdomain does not uniquely identify observations
    in the master data
variable spdomain does not uniquely identify observations
    in
    /home/bjvca/data/data/GAP/Haruna/UNPS_2011/GAPP3//work
    > /povlines.dta
(label lbreg already defined)
(label lsurvquar already defined)
(label lspdomain already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      2,717      100.00      100.00
------------+-----------------------------------
      Total |      2,717      100.00

.         drop _merge;

.         * Real consumption pc, temporally deflated ;
.         gen cr= cons_pc_tpi ;
(49 missing values generated)

.         * Poverty line;
.         gen linpob=povline_flex;
(9 missing values generated)

.         *qui sum linpob if spdomain==1, meanonly;
.         sum linpob if spdomain==3, meanonly;

.         global spi_base=r(mean);

.         * Spatial price index ;
.         gen spi=linpob/$spi_base;
(9 missing values generated)

.         * Real consumption pc, temporally and spatially de
> flated ;
.         gen cr2=cr/spi;
(49 missing values generated)

.         qui sum cr [aw=hhweight*hhsize];

.         global sumcr=r(sum);

.         qui sum cr2 [aw=hhweight*hhsize];

.         global sumcr2=r(sum);

.         replace spi=spi*$sumcr2/$sumcr;
(2708 real changes made)

.         gen linpobr=linpob/spi;
(9 missing values generated)

.         replace cr2=cr/spi;
(2658 real changes made)

.         sum cr cr2 linpob linpobr [aw=hhweight*hhsize];

    Variable |     Obs      Weight        Mean   Std. Dev.  
>      Min        Max
-------------+----------------------------------------------
> -------------------
          cr |    2668  36669748.9    1891.771   3012.061   
>        0   86178.92
         cr2 |    2668  36669748.9    1891.772   2775.075   
>        0   78224.86
      linpob |    2707    37257099    831.0039   262.3186   
>  577.541   1245.596
     linpobr |    2707    37257099    792.6632   .0000494   
> 792.6631   792.6632

.         lab var cr      "Temporally-adjusted cons pc";

.         lab var cr2     "Spatially & temporally adjusted c
> ons pc";

.         lab var linpob  "Poverty line";

.         lab var linpobr "Real poverty line";

.         lab var spi     "Spatial price index";

. **********************************************************
> ****************
> * calculate poverty measures with the flexible food bundle
> **********************************************************
> ****************;
.         gen h = 100     if cr <=(linpob);
(2122 missing values generated)

.         replace  h = 0 if cr > (linpob);
(2122 real changes made)

.                         gen             pg      = ((linpob
>  - cr )/linpob) *100;
(49 missing values generated)

.         replace         pg      = 0             if h==0;
(2122 real changes made)

.         gen             spg     = ((( linpob - cr )/ linpo
> b )^2)*100;
(49 missing values generated)

.         replace         spg     = 0             if h==0;
(2122 real changes made)

.         gen h_flex=h;

.         gen pg_flex=pg;
(9 missing values generated)

.         gen spg_flex=spg;
(9 missing values generated)

.         lab var h_flex   "Poverty headcount. Flex bundle";

.         lab var pg_flex  "Poverty gap. Flex bundle";

.         lab var spg_flex "Squared poverty gap. Flex bundle
> ";

.         sort hhid;

.         merge hhid using "$path/work/hhdata.dta";
(label lspdomain already defined)
(label lsurvquar already defined)
(label lbreg already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          1        0.04        0.04
          3 |      2,716       99.96      100.00
------------+-----------------------------------
      Total |      2,717      100.00

.         drop if _merge~=3;
(1 observation deleted)

.         drop _merge;

.         gen popwt=hhsize*hhweight;
(2 missing values generated)

.                 * Stata 10.1 syntax ;
.         svyset , clear;

.         svyset [pweight=popwt] , str(strata) psu(psu);

      pweight: popwt
          VCE: linearized
  Single unit: missing
     Strata 1: strata
         SU 1: psu
        FPC 1: <zero>

.         svy: mean h_flex pg_flex spg_flex;
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =       6        Number of obs    =      27
> 07
Number of PSUs   =     368        Population size  =  372570
> 99
                                  Design df        =       3
> 62

------------------------------------------------------------
> --
             |             Linearized
             |       Mean   Std. Err.     [95% Conf. Interva
> l]
-------------+----------------------------------------------
> --
      h_flex |   23.78035   1.474744      20.88021    26.680
> 49
     pg_flex |   8.640618   .7062988      7.251654    10.029
> 58
    spg_flex |   4.738182   .5317062      3.692561    5.7838
> 03
------------------------------------------------------------
> --

.         svy: mean h_flex pg_flex spg_flex , over(rural);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =       6        Number of obs    =      27
> 07
Number of PSUs   =     368        Population size  =  372570
> 99
                                  Design df        =       3
> 62

            0: rural = 0
            1: rural = 1

------------------------------------------------------------
> --
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interva
> l]
-------------+----------------------------------------------
> --
h_flex       |
           0 |   6.032549   1.326789      3.423367    8.6417
> 32
           1 |   26.95495   1.709691      23.59277    30.317
> 12
-------------+----------------------------------------------
> --
pg_flex      |
           0 |   2.433973   .6844338      1.088008    3.7799
> 39
           1 |   9.750818    .819836      8.138579    11.363
> 06
-------------+----------------------------------------------
> --
spg_flex     |
           0 |   1.462514   .5584336      .3643328    2.5606
> 95
           1 |    5.32411   .6168346      4.111081    6.5371
> 39
------------------------------------------------------------
> --

.         svy: mean h_flex pg_flex spg_flex , over(news);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =       6        Number of obs    =      27
> 07
Number of PSUs   =     368        Population size  =  372570
> 99
                                  Design df        =       3
> 62

      Central: news = Central
      Eastern: news = Eastern
     Northern: news = Northern
      Western: news = Western

------------------------------------------------------------
> --
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interva
> l]
-------------+----------------------------------------------
> --
h_flex       |
     Central |   14.42243   2.025856       10.4385    18.406
> 35
     Eastern |   15.01479   1.889616      11.29878    18.730
> 79
    Northern |   22.19032   3.048504      16.19532    28.185
> 32
     Western |   44.99748   3.907248      37.31372    52.681
> 23
-------------+----------------------------------------------
> --
pg_flex      |
     Central |   7.622984   1.672593      4.333765     10.91
> 22
     Eastern |   3.724468    .634223      2.477244    4.9716
> 92
    Northern |   6.018522   1.169118      3.719407    8.3176
> 37
     Western |    17.4237   1.683975       14.1121     20.73
> 53
-------------+----------------------------------------------
> --
spg_flex     |
     Central |   5.711281   1.579115      2.605889    8.8166
> 73
     Eastern |   1.596288   .3494187      .9091429    2.2834
> 34
    Northern |   2.419153   .5634548      1.311097    3.5272
> 09
     Western |   9.136437   1.055508       7.06074    11.212
> 13
------------------------------------------------------------
> --

.         svy: mean h_flex pg_flex spg_flex , over(reg_tpi);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =       6        Number of obs    =      27
> 07
Number of PSUs   =     368        Population size  =  372570
> 99
                                  Design df        =       3
> 62

      Central: reg_tpi = Central
      Eastern: reg_tpi = Eastern
     Northern: reg_tpi = Northern
      Western: reg_tpi = Western

------------------------------------------------------------
> --
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interva
> l]
-------------+----------------------------------------------
> --
h_flex       |
     Central |   14.42243   2.025856       10.4385    18.406
> 35
     Eastern |   15.01479   1.889616      11.29878    18.730
> 79
    Northern |   22.19032   3.048504      16.19532    28.185
> 32
     Western |   44.99748   3.907248      37.31372    52.681
> 23
-------------+----------------------------------------------
> --
pg_flex      |
     Central |   7.622984   1.672593      4.333765     10.91
> 22
     Eastern |   3.724468    .634223      2.477244    4.9716
> 92
    Northern |   6.018522   1.169118      3.719407    8.3176
> 37
     Western |    17.4237   1.683975       14.1121     20.73
> 53
-------------+----------------------------------------------
> --
spg_flex     |
     Central |   5.711281   1.579115      2.605889    8.8166
> 73
     Eastern |   1.596288   .3494187      .9091429    2.2834
> 34
    Northern |   2.419153   .5634548      1.311097    3.5272
> 09
     Western |   9.136437   1.055508       7.06074    11.212
> 13
------------------------------------------------------------
> --

.         svy: mean h_flex pg_flex spg_flex , over(strata);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =       6        Number of obs    =      27
> 07
Number of PSUs   =     368        Population size  =  372570
> 99
                                  Design df        =       3
> 62

      Kampala: strata = Kampala
    _subpop_2: strata = Other Urban
    _subpop_3: strata = Central rural
    _subpop_4: strata = East rural
    _subpop_5: strata = North rural
    _subpop_6: strata = West rural

------------------------------------------------------------
> --
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interva
> l]
-------------+----------------------------------------------
> --
h_flex       |
     Kampala |   3.383183    1.79719     -.1510616    6.9174
> 27
   _subpop_2 |   7.427843   1.784915      3.917738    10.937
> 95
   _subpop_3 |   19.91683   2.898469      14.21687    25.616
> 78
   _subpop_4 |   15.86898   2.031866      11.87324    19.864
> 72
   _subpop_5 |   23.74083   3.361665      17.12998    30.351
> 67
   _subpop_6 |   47.18332   4.119882      39.08142    55.285
> 23
-------------+----------------------------------------------
> --
pg_flex      |
     Kampala |   .9953435   .7090994     -.3991281    2.3898
> 15
   _subpop_2 |   3.199488   .9782933      1.275636    5.1233
> 39
   _subpop_3 |   10.46981   2.427794      5.695459    15.244
> 16
   _subpop_4 |   3.912261   .6841744      2.566805    5.2577
> 17
   _subpop_5 |   6.433043   1.296555      3.883318    8.9827
> 68
   _subpop_6 |   18.33858   1.787421      14.82354    21.853
> 61
-------------+----------------------------------------------
> --
spg_flex     |
     Kampala |   .4041599    .320569     -.2262515    1.0345
> 71
   _subpop_2 |   2.028741   .8409646      .3749518    3.6825
> 31
   _subpop_3 |   7.838418   2.309953      3.295806    12.381
> 03
   _subpop_4 |   1.672913   .3775056      .9305335    2.4152
> 92
   _subpop_5 |   2.606302   .6265514      1.374164    3.8384
> 39
   _subpop_6 |   9.633776   1.126522      7.418427    11.849
> 13
------------------------------------------------------------
> --

.         svy: mean h_flex pg_flex spg_flex , over(spdomain)
> ;
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =       6        Number of obs    =      27
> 07
Number of PSUs   =     368        Population size  =  372570
> 99
                                  Design df        =       3
> 62

      Central: spdomain = Central
      Eastern: spdomain = Eastern
     Northern: spdomain = Northern
      Western: spdomain = Western

------------------------------------------------------------
> --
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interva
> l]
-------------+----------------------------------------------
> --
h_flex       |
     Central |   14.42243   2.025856       10.4385    18.406
> 35
     Eastern |   15.01479   1.889616      11.29878    18.730
> 79
    Northern |   22.19032   3.048504      16.19532    28.185
> 32
     Western |   44.99748   3.907248      37.31372    52.681
> 23
-------------+----------------------------------------------
> --
pg_flex      |
     Central |   7.622984   1.672593      4.333765     10.91
> 22
     Eastern |   3.724468    .634223      2.477244    4.9716
> 92
    Northern |   6.018522   1.169118      3.719407    8.3176
> 37
     Western |    17.4237   1.683975       14.1121     20.73
> 53
-------------+----------------------------------------------
> --
spg_flex     |
     Central |   5.711281   1.579115      2.605889    8.8166
> 73
     Eastern |   1.596288   .3494187      .9091429    2.2834
> 34
    Northern |   2.419153   .5634548      1.311097    3.5272
> 09
     Western |   9.136437   1.055508       7.06074    11.212
> 13
------------------------------------------------------------
> --

.         compress;
hhsize was long now byte
survquar was float now byte
spdomain was float now byte
one was float now byte
triwt was float now byte
h was float now byte
h_flex was float now byte
survmon was float now byte
rural was float now byte
news was float now byte
bswt was float now byte

.         sort hhid;

. save "$path/work/cons_real.dta" , replace;
file /home/bjvca/data/data/GAP/Haruna/UNPS_2011/GAPP3//work/
> cons_real.dta saved

.         collapse  (mean) h_flex pg_flex spg_flex [aw=hhwei
> ght*hhsize];

. save "$path/work/povmeas.dta", replace;
file /home/bjvca/data/data/GAP/Haruna/UNPS_2011/GAPP3//work/
> povmeas.dta saved

. *** HARUNA, the file Povmeas.dta gives the headcount pover
> ty rates using flexible food bundle without inflicting rev
> eales preferences
> *** therefore specifications in line 226 of this do file h
> ave been changed repeatedly to generate these counts for p
> articular
> *** classifications of interest including strata spdomain 
> region urban/rural (urban) and national (done by removing 
> the by command 
> **********************************************************
> ****************
> * 130_povmeas_flex.do           (end)
> **********************************************************
> ****************;
. log close;
      name:  <unnamed>
       log:  /home/bjvca/data/data/GAP/Haruna/UNPS_2011/GAPP
> 3//rep/130_povmeas_flex.log
  log type:  text
 closed on:  23 Oct 2013, 16:01:37
------------------------------------------------------------
