------------------------------------------------------------
      name:  <unnamed>
       log:  /home/bjvca/data/data/GAP/Haruna/UNPS_2011/GAPP
> 3//rep/120_povline_food_flex.log
  log type:  text
 opened on:  23 Oct 2013, 16:01:36

. clear

. set more off

. #delimit ;
delimiter now ;
. **********************************************************
> ****************
> * 120_povline_food_flex.do      (start)
> *
> * Use the file with the food basket (food_basket_flex), wh
> ich is in shares. 
> * Then merge it with the prices file, and then with the ca
> lories file.
> * Along the way, drop those observations where we have no 
> price information
> * or no calorie information.
> **********************************************************
> ****************;
. /*
> This file uses:
>         work/food_basket_flex.dta
>         work/price_unit_flex.dta
>         work/calperg.dta
>         work/calpp.dta
> 
> This file creates:
>         work/povline_flex.dta
> */
> 
> 
> * start with the quantity information;
. use "$path/work/food_basket_flex.dta";

.         sort product spdomain;

.         * merge in price information;
.         merge product spdomain using "$path/work/price_uni
> t_flex.dta";
(label lspdomain already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          9        6.04        6.04
          2 |         48       32.21       38.26
          3 |         92       61.74      100.00
------------+-----------------------------------
      Total |        149      100.00

.         list product spdomain descript if _merge==1;

     +-------------------------------+
     | product   spdomain   descript |
     |-------------------------------|
 92. |     157    Central          1 |
 93. |     157    Eastern          1 |
 94. |     157   Northern          1 |
 95. |     157    Western          1 |
 97. |     999    Central          2 |
     |-------------------------------|
 98. |     999    Eastern          2 |
 99. |     999   Northern          2 |
100. |     999    Western          2 |
101. |       .    Central          1 |
     +-------------------------------+

.         drop if _merge ~=3;
(57 observations deleted)

.         drop _merge;

.         sort product;

.         * merge in information on calories per gram;
.         merge product using "$path/work/calperg.dta";
variable product does not uniquely identify observations
    in the master data
(note: descript is str26 in using data but will be float now
> )

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          1        0.83        0.83
          2 |         28       23.33       24.17
          3 |         91       75.83      100.00
------------+-----------------------------------
      Total |        120      100.00

.         * This tells where we are lacking calorie info or 
> are lacking quantity info due to 
>         * missing price info above;
.         list product spdomain descript if _merge==1;

     +-------------------------------+
     | product   spdomain   descript |
     |-------------------------------|
 92. |     166    Western          1 |
     +-------------------------------+

.         drop if _merge~=3;
(29 observations deleted)

.         drop _merge;

.         sort spdomain f_share_w;

.                 * CA modified to handle bootstrap counting
> ;
.         * determine if any quantity has fewer than 10 pric
> e observations;
.         by spdomain: count if round(bswt)<10;

------------------------------------------------------------
-> spdomain = Central
    0
------------------------------------------------------------
-> spdomain = Eastern
    0
------------------------------------------------------------
-> spdomain = Northern
    0
------------------------------------------------------------
-> spdomain = Western
    0

.         drop if round(bswt) < 10;
(0 observations deleted)

.         by spdomain: egen baskshr=sum(f_share_w);

.         by spdomain: gen cumshr1=sum(f_share_w);

.         * bundle was cut at 92.5 percent- cut back to 90 p
> ercent if necessary;
.         drop if cumshr1<=baskshr-.9;
(0 observations deleted)

.         * reobtain the share represented from the average 
> basket- should be slightly more than 90;
.         drop baskshr;

.         by spdomain: egen baskshr=sum(f_share_w);

.         by spdomain: sum baskshr;

------------------------------------------------------------
-> spdomain = Central

    Variable |       Obs        Mean    Std. Dev.       Min 
>        Max
-------------+----------------------------------------------
> ----------
     baskshr |        21     .432505           0    .432505 
>    .432505

------------------------------------------------------------
-> spdomain = Eastern

    Variable |       Obs        Mean    Std. Dev.       Min 
>        Max
-------------+----------------------------------------------
> ----------
     baskshr |        26    .5797779           0   .5797779 
>   .5797779

------------------------------------------------------------
-> spdomain = Northern

    Variable |       Obs        Mean    Std. Dev.       Min 
>        Max
-------------+----------------------------------------------
> ----------
     baskshr |        26    .5067519           0   .5067519 
>   .5067519

------------------------------------------------------------
-> spdomain = Western

    Variable |       Obs        Mean    Std. Dev.       Min 
>        Max
-------------+----------------------------------------------
> ----------
     baskshr |        18     .566602           0    .566602 
>    .566602


.         * obtain quantities and calories provided by these
>  quantities;
.         gen quan=f_share_w/price_unitw;

.                         /* how many g in 1 MT exp on food 
> item */
>         gen cal_ir=quan*calperg;

.                                 /* how many cal in 1 MT ex
> p on food item */
>         by spdomain: egen calreg=sum(cal_ir);

.         /* how many cal in 1 MT exp in food basket*/
> 
>         * merge in calorie requirements;
.         sort spdomain;

.         merge spdomain using "$path/work/calpp.dta";
variable spdomain does not uniquely identify observations
    in the master data

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |         91      100.00      100.00
------------+-----------------------------------
      Total |         91      100.00

.         drop _merge;

.         * get the expansion factor to hit 95% of calorie r
> equirements;
.         gen ratio=.95*calpp/calreg;

.                         replace quan=quan*ratio;
(91 real changes made)

.         replace cal_ir=quan*calperg;
(87 real changes made)

.         * do a consistency check;
.         sort spdomain;

.         by spdomain: egen chkcal=sum(cal_ir);

.         replace chkcal=chkcal/.95-calpp ;
(91 real changes made)

.                         * these values should be about zer
> o;
.         by spdomain: sum chkcal;

------------------------------------------------------------
-> spdomain = Central

    Variable |       Obs        Mean    Std. Dev.       Min 
>        Max
-------------+----------------------------------------------
> ----------
      chkcal |        21    .0000385           0   .0000385 
>   .0000385

------------------------------------------------------------
-> spdomain = Eastern

    Variable |       Obs        Mean    Std. Dev.       Min 
>        Max
-------------+----------------------------------------------
> ----------
      chkcal |        26   -.0000899           0  -.0000899 
>  -.0000899

------------------------------------------------------------
-> spdomain = Northern

    Variable |       Obs        Mean    Std. Dev.       Min 
>        Max
-------------+----------------------------------------------
> ----------
      chkcal |        26    .0000707           0   .0000707 
>   .0000707

------------------------------------------------------------
-> spdomain = Western

    Variable |       Obs        Mean    Std. Dev.       Min 
>        Max
-------------+----------------------------------------------
> ----------
      chkcal |        18   -.0001221           0  -.0001221 
>  -.0001221


.         * obtain the value of each good in the bundle;
.         gen val_ir=quan*price_unitw;

.         * the sum of the value of the goods in the bundle 
> is assumed to represent 90% of expenditure;
.         by spdomain: egen povline_f_flex90=sum(val_ir);

.         replace povline_f_flex=povline_f_flex90/.9;
(91 real changes made)

.         collapse (mean) povline_f_flex, by (spdomain);

.                 lab var povline_f_flex "Food poverty line.
>  Flexible basket";

.         sort spdomain;

.         keep spdomain povline_f_flex;

. save "$path/work/povline_food_flex.dta", replace;
file /home/bjvca/data/data/GAP/Haruna/UNPS_2011/GAPP3//work/
> povline_food_flex.dta saved

. /*
> * To be used in 140_iterate.do;
> gen cutoff = 1.5 * povline_f_flex;
> keep spdomain cutoff;
> save "$path/work/povlines_first_iterate.dta", replace;
> */
> 
> **********************************************************
> ****************
> * 120_povline_food_flex.do      (end)
> **********************************************************
> ****************;
. log close;
      name:  <unnamed>
       log:  /home/bjvca/data/data/GAP/Haruna/UNPS_2011/GAPP
> 3//rep/120_povline_food_flex.log
  log type:  text
 closed on:  23 Oct 2013, 16:01:36
------------------------------------------------------------
