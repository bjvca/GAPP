----------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /home/bjvca/data/data/GAP/Haruna/UNPS_2005_06//rep/110_price_unit_flex.log
  log type:  text
 opened on:  10 Mar 2014, 14:47:25

. clear

. set more off

. #delimit ;
delimiter now ;
. ****************************************************************************************
> * 110_price_unit_flex.do                (start)
> *
> * Purpose: This do file creates a price_unit_flex database with the unit prices of the
> * goods of the flexible food basket in order to determine the poverty lines per spatial
> * domain. It uses the files work/daily.dta and work/own.dta file and draw unit prices
> * by: sum of values and quantity
> ****************************************************************************************;
. *CA modified to bring in work/hhdata.dta for bootstrap
> *CA check for price calcs conditional on number of observations;
. /*
> This file uses:
>         work/daily.dta
>         work/own.dta
>         work/hhdata.dta
>         work/consump_nom.dta
>         work/codes_food_basket_flex.dta
>         work/temp_index_reg_tpi.dta
>           new/conversions.do
> 
> This file creates:
>         work/price_unit_flex.dta
>         work/bottom_basket.dta
> */
> 
> 
> 
> 
> *do "$path/new/010_initial.do";
. **************************************************************************************
> * Create sorted data set with daily and own and the matched codes
> **************************************************************************************;
. use "$path/work/cons_cod_trans.dta", clear;

. *use "$path/in/cons_cod_trans.dta", clear;
. *save "$path/work/cons_cod_trans.dta", replace;
. *drop if quantityd==0 ;
. keep hhid product food_cat valuez quantity unit;

. rename valuez    value;

. *rename quantityz quantity;
. drop if quantity==0 ;
(3 observations deleted)

. *drop count;
.         sort product;

.         gen count=1;

.                 tempfile dd_acsort;

. save `dd_acsort', replace;
(note: file /tmp/St02564.000001 not found)
file /tmp/St02564.000001 saved

. /*
> use "$path/work/daily.dta";
> tempfile dd_acsort;
>         drop days;
>         sort product;
>         tempfile dd_acsort;
> save `dd_acsort', replace;
> 
> use "$path/work/own.dta";
>         keep hhid product valued quantityd unit;
>         rename valued value;
>         rename quantityd quantity;
> 
>         *CHECK THE ZEROS IN quantity FOR NOW DELETE;
>         drop if quantity==0;
> 
>         append using `dd_acsort';
> 
> *CA modified to merge in work/hhdata.dta for bootstrap;
>         sort hhid;
>       merge hhid using "$path/work/hhdata.dta";
>       tab _m;
> 
> * Drop observations if non existent in HH data set;
> drop if _m!=3;
> drop _m;
> 
> 
>         sort product;
>         gen count=1;
> 
> 
> save `dd_acsort', replace;
> */
> 
> 
> **************************************************************************************;
. * Merge the flexible food basket codes with the daily and own data sets
> * Drop all codes not a part of the flexible food basket
> **************************************************************************************;
.         merge product using "$path/work/codes_food_basket_flex.dta";
variable product does not uniquely identify observations in the master data
product was int now float

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |      3,634        9.12        9.12
          3 |     36,216       90.88      100.00
------------+-----------------------------------
      Total |     39,850      100.00

.         drop if _merge~=3;
(3634 observations deleted)

.         drop _merge;

. **************************************************************************************;
. * Drop observations where product code or quantity or value information is unavailable
> **************************************************************************************;
.                                 codebook hhid;

----------------------------------------------------------------------------------------------
hhid                                                                              household id
----------------------------------------------------------------------------------------------

                  type:  numeric (double)

                 range:  [1.013e+09,4.193e+09]        units:  1
         unique values:  3118                     missing .:  505/36216

                  mean:   2.4e+09
              std. dev:   1.2e+09

           percentiles:        10%       25%       50%       75%       90%
                           1.0e+09   1.1e+09   2.1e+09   3.2e+09   4.1e+09

. *        drop if product==. | value==. | quantity==.  ;
.                                 codebook hhid;

----------------------------------------------------------------------------------------------
hhid                                                                              household id
----------------------------------------------------------------------------------------------

                  type:  numeric (double)

                 range:  [1.013e+09,4.193e+09]        units:  1
         unique values:  3118                     missing .:  505/36216

                  mean:   2.4e+09
              std. dev:   1.2e+09

           percentiles:        10%       25%       50%       75%       90%
                           1.0e+09   1.1e+09   2.1e+09   3.2e+09   4.1e+09

. **************************************************************************************;
. * Convert non-KG quantities (units and liters) to kilograms;
. **************************************************************************************;
. *do "$path/new/110a_conversions.do"
> 
> ********************************************************************
> * There remain a few difficult to interpret observations such as liters
> * of fish and liters of pasta. These are dropped
> ********************************************************************;
. *        drop if unit~=2;
. ********************************************************************
> * Merge in labels for the 13 spatial domains
> ********************************************************************;
.         preserve;

.                 use "$path/work/hhdata.dta", clear;

.                                                                         keep hhid spdomain r
> eg_tpi survquar;

.                         sort hhid;

.                         tempfile spdomainreg_tpi;

.                 save `spdomainreg_tpi', replace;
(note: file /tmp/St02564.000003 not found)
file /tmp/St02564.000003 saved

.                                 codebook hhid;

----------------------------------------------------------------------------------------------
hhid                                                                              Household ID
----------------------------------------------------------------------------------------------

                  type:  numeric (double)

                 range:  [1.013e+09,4.193e+09]        units:  1
         unique values:  3123                     missing .:  0/3123

                  mean:   2.4e+09
              std. dev:   1.2e+09

           percentiles:        10%       25%       50%       75%       90%
                           1.0e+09   1.1e+09   2.2e+09   3.2e+09   4.1e+09

.         restore;

.                 sort hhid;

.         merge hhid using `spdomainreg_tpi';
variable hhid does not uniquely identify observations in the master data

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |        505        1.39        1.39
          2 |          5        0.01        1.41
          3 |     35,711       98.59      100.00
------------+-----------------------------------
      Total |     36,221      100.00

.         drop _merge;

.         drop if product==.;
(5 observations deleted)

. codebook hhid;

----------------------------------------------------------------------------------------------
hhid                                                                              household id
----------------------------------------------------------------------------------------------

                  type:  numeric (double)

                 range:  [1.013e+09,4.193e+09]        units:  1
         unique values:  3118                     missing .:  505/36216

                  mean:   2.4e+09
              std. dev:   1.2e+09

           percentiles:        10%       25%       50%       75%       90%
                           1.0e+09   1.1e+09   2.1e+09   3.2e+09   4.1e+09

. tab spd;

      Spatial |
domains: each |
     with own |
 poverty line |
 (they are 5) |      Freq.     Percent        Cum.
--------------+-----------------------------------
Central Urban |      5,906       16.56       16.56
Central Rural |      6,566       18.41       34.97
      Eastern |      8,446       23.68       58.66
     Northern |      7,117       19.96       78.61
      Western |      7,627       21.39      100.00
--------------+-----------------------------------
        Total |     35,662      100.00

. sum if spd>=3;

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        hhid |     23239    3.06e+09    8.30e+08   2.01e+09   4.19e+09
     product |     23744    129.8697    16.25222        100        161
       value |     23239    241.6601    391.0277   1.428571   19285.71
        unit |     23239           1           0          1          1
    food_cat |     23239           1           0          1          1
-------------+--------------------------------------------------------
    quantity |     21501     1.13447    3.211978   .0014286      135.2
       count |     23744           1           0          1          1
      numreg |     23744    3.880686    1.395461          1          5
    survquar |     23190    2.326693    1.361816          1          5
     reg_tpi |     23190    2.964683    .8317951          2          4
-------------+--------------------------------------------------------
    spdomain |     23190    3.964683    .8317951          3          5

. table spdomain, content(mean quantity count quantity count hhid) row missing;

--------------------------------------------------------------
Spatial       |
domains: each |
with own      |
poverty line  |
(they are 5)  | mean(quantity)     N(quantity)         N(hhid)
--------------+-----------------------------------------------
Central Urban |       .6272362           5,578           5,906
Central Rural |       1.137202           6,316           6,566
      Eastern |        .932739           8,185           8,446
     Northern |       1.077276           5,808           7,117
      Western |       1.401658           7,462           7,627
              | 
        Total |       1.050459          33,349          35,662
--------------------------------------------------------------

.         drop if product==. | value==. | quantity==.  ;
(2821 observations deleted)

. codebook hhid;

----------------------------------------------------------------------------------------------
hhid                                                                              household id
----------------------------------------------------------------------------------------------

                  type:  numeric (double)

                 range:  [1.013e+09,4.193e+09]        units:  1
         unique values:  3021                     missing .:  0/33395

                  mean:   2.4e+09
              std. dev:   1.2e+09

           percentiles:        10%       25%       50%       75%       90%
                           1.0e+09   1.1e+09   2.1e+09   3.2e+09   4.1e+09

. tab spd;

      Spatial |
domains: each |
     with own |
 poverty line |
 (they are 5) |      Freq.     Percent        Cum.
--------------+-----------------------------------
Central Urban |      5,578       16.73       16.73
Central Rural |      6,316       18.94       35.67
      Eastern |      8,185       24.54       60.21
     Northern |      5,808       17.42       77.62
      Western |      7,462       22.38      100.00
--------------+-----------------------------------
        Total |     33,349      100.00

. ********************************************************************
> * Merge in temporal price index to convert nominal value to real
> ********************************************************************;
.         sort reg_tpi survquar;

.         merge reg_tpi survquar using "$path/work/temp_index_reg_tpi.dta";
variables reg_tpi survquar do not uniquely identify observations in the master data
(label lsurvquar already defined)
(label lregion already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |        162        0.49        0.49
          3 |     33,233       99.51      100.00
------------+-----------------------------------
      Total |     33,395      100.00

.         drop if _merge ~= 3;
(162 observations deleted)

.         drop _merge;

.         gen value_r=value/tpi_trim;

. **************************************************************************;
. * Identify relatively poor households, based on nominal temporally adjusted
> * consumption per capita. Only work with these households for the price
> * calculations.
> **************************************************************************;
.                 preserve;

.                         use "$path/work/conpc.dta", clear;

. *                       use "$path/work/consump_nom.dta", clear;
. *CA modified to merge in work/hhdata.dta for bootstrap;
.         sort hhid;

.       merge hhid using "$path/work/hhdata.dta";

.       tab _m;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          1        0.03        0.03
          3 |      3,123       99.97      100.00
------------+-----------------------------------
      Total |      3,124      100.00

.       drop _m;

. *CA modified to keep bswt;
.                                 keep hhid hhweight hhsize cons_pc_nom bswt ;

.                                 sort hhid;

.                                 merge hhid using `spdomainreg_tpi';
(label lsurvquar already defined)
(label lregion already defined)
(label lspdomain already defined)

.                                 tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          1        0.03        0.03
          3 |      3,123       99.97      100.00
------------+-----------------------------------
      Total |      3,124      100.00

.                                 drop _merge;

.                                 sort reg_tpi survquar;

.                                 cap drop _merge;

.                                 merge reg_tpi survquar using "$path/work/temp_index_reg_tpi.
> dta";
variables reg_tpi survquar do not uniquely identify observations in the master data
(label lsurvquar already defined)
(label lregion already defined)

.                                 tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |         15        0.48        0.48
          3 |      3,109       99.52      100.00
------------+-----------------------------------
      Total |      3,124      100.00

.                                 drop _merge;

.                                 sort hhid;

.                                 merge hhid using "$path/work/conpc.dta";

.                                 tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      3,124      100.00      100.00
------------+-----------------------------------
      Total |      3,124      100.00

.                                 drop _merge;

.                                 gen food_pc_tpi  = food_pc_nom /tpi_trim;
(15 missing values generated)

.                                 lab var food_pc_tpi "Temp-adjusted per capita food consumpti
> on/day";

.                                                                 * Non-food not TPI adjusted 
> ;
.                                 gen cons_pc_tpi = food_pc_tpi + nf_pc_nom;
(16 missing values generated)

.                                 lab var cons_pc_tpi "Temp adjusted total consumption/day";

.                                 gen one=1;

.                                 tempfile contpi;

.                                 save `contpi', replace;
(note: file /tmp/St02564.000005 not found)
file /tmp/St02564.000005 saved

.                                 collapse (p$bottom) one cons_pc_tpi [aw=hhsize*hhweight], by
> (spdomain) ;

.                                 rename cons_pc_tpi pctile_60;

.                                 tempfile 60pct;

.                                 sort spdomain;

.                                 save `60pct', replace;
(note: file /tmp/St02564.000006 not found)
file /tmp/St02564.000006 saved

.                                 use `contpi';

.                                         sort spdomain;

.                                         merge spdomain using `60pct';
variable spdomain does not uniquely identify observations in the master data
(label lspdomain already defined)

.                                         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          5        0.16        0.16
          3 |      3,119       99.84      100.00
------------+-----------------------------------
      Total |      3,124      100.00

.                                         drop _merge;

.                                         drop one;

.                                         sort spdomain;

.                                         gen bottom_basket=cons_pc_tpi< pctile_60;

.                                         by spdomain: tab bottom_basket [aw=hhsize*hhweight];

----------------------------------------------------------------------------------------------
-> spdomain = Central Urban

bottom_bask |
         et |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 233.467673       50.75       50.75
          1 | 226.532327       49.25      100.00
------------+-----------------------------------
      Total |        460      100.00

----------------------------------------------------------------------------------------------
-> spdomain = Central Rural

bottom_bask |
         et |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 285.075201       50.55       50.55
          1 | 278.924799       49.45      100.00
------------+-----------------------------------
      Total |        564      100.00

----------------------------------------------------------------------------------------------
-> spdomain = Eastern

bottom_bask |
         et |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 348.971102       50.07       50.07
          1 | 348.028898       49.93      100.00
------------+-----------------------------------
      Total |        697      100.00

----------------------------------------------------------------------------------------------
-> spdomain = Northern

bottom_bask |
         et |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 347.620933       50.02       50.02
          1 | 347.379067       49.98      100.00
------------+-----------------------------------
      Total |        695      100.00

----------------------------------------------------------------------------------------------
-> spdomain = Western

bottom_bask |
         et |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 351.585126       50.01       50.01
          1 | 351.414874       49.99      100.00
------------+-----------------------------------
      Total |        703      100.00

----------------------------------------------------------------------------------------------
-> spdomain = .
no observations


.                                         lab var bottom_basket "=1 if in bottom (60%) of PCE"
> ;

.                                         sort hhid;

.                                                                 save "$path/work/bottom_bask
> et.dta", replace;
file /home/bjvca/data/data/GAP/Haruna/UNPS_2005_06//work/bottom_basket.dta saved

.         restore;

.         sort hhid;

.         merge hhid using "$path/work/bottom_basket.dta";
variable hhid does not uniquely identify observations in the master data
(label lspdomain already defined)
(label lregion already defined)
(label lsurvquar already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |        115        0.34        0.34
          3 |     33,233       99.66      100.00
------------+-----------------------------------
      Total |     33,348      100.00

.         drop _merge;

.                         * Only keep price observations for the poor ;
.         keep if bottom_basket==1;
(20996 observations deleted)

.         **************************************************************************;
. * Toss out the bottom 5% and top 5% of the HH-LEVEL prices per kg in
> * for each spdomain & product combination. This should eliminate outliers
> * that may have an undue influence on the price calculation. 
> **************************************************************************;
.                 gen hhppkg=value_r/quantity;
(17 missing values generated)

.                 egen lower5=pctile(hhppkg), p(5) by(spdomain product);
(17 missing values generated)

.                 egen upper5=pctile(hhppkg), p(95) by(spdomain product);
(17 missing values generated)

. sum;

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
        hhid |     12352    2.31e+09    1.18e+09   1.02e+09   4.19e+09
     product |     12335    129.2812    16.03414        100        154
       value |     12335    207.2503    291.3657   2.857143       4200
        unit |     12335           1           0          1          1
    food_cat |     12335           1           0          1          1
-------------+--------------------------------------------------------
    quantity |     12335    1.069382    3.051545   .0002857      135.2
       count |     12335           1           0          1          1
      numreg |     12335    4.007296    1.348036          1          5
    survquar |     12352    2.455149    1.429734          1          5
     reg_tpi |     12352    2.217212    1.170655          1          4
-------------+--------------------------------------------------------
    spdomain |     12352    3.038941    1.396767          1          5
    tpi_trim |     12352    .9958938    .0821045   .8591004   1.223628
     value_r |     12335    207.9584    289.5788    2.75269       4200
 cons_pc_nom |     12352    635.1346    344.6575   103.3254   1949.757
    hhweight |     12352    1769.408     712.246   140.8407   5553.862
-------------+--------------------------------------------------------
        bswt |     12352           1           0          1          1
      hhsize |     12352    6.443491    2.985493          1         29
 cons_hh_nom |     12352    3940.417    2690.047        150   27429.27
 food_pc_nom |     12352     398.762    189.5894          0   1347.619
   nf_pc_nom |     12352    236.3726    201.0937          0   1344.332
-------------+--------------------------------------------------------
 food_pc_tpi |     12352    397.2113    176.2312          0   1298.352
 cons_pc_tpi |     12352    633.5839     328.135   106.8324   1747.104
   pctile_60 |     12352     904.575    414.6753   501.5237   1751.113
bottom_bas~t |     12352           1           0          1          1
      hhppkg |     12335    795.7898    1088.115   6.223299   48172.07
-------------+--------------------------------------------------------
      lower5 |     12335    347.6065    406.6277   14.10155   2832.963
      upper5 |     12335    1608.903    1555.171   47.68716   10201.06

. describe;

Contains data from /tmp/St02564.000001
  obs:        12,352                          
 vars:            27                          10 Mar 2014 14:47
 size:     1,445,184                          (_dta has notes)
----------------------------------------------------------------------------------------------
              storage  display     value
variable name   type   format      label      variable label
----------------------------------------------------------------------------------------------
hhid            double %10.0g                 household id
product         float  %34.0g      H14AQ2     Food product code: numerical
value           float  %9.0g                  daily value of consumption in UGX per per
                                                household
unit            float  %9.0g                  set equal to one since all observations are
                                                converted into kg
food_cat        float  %9.0g                  food category equals 1, if product is food and 0
                                                if non food
quantity        float  %9.0g                  daily quantity consumed in Kgs per household
count           float  %9.0g                  
numreg          double %9.0g                  number of goods in the basket
survquar        float  %20.0g      lsurvquar
                                              Sequential Survey Quarter (May-Nov'05 & May-Nov
                                                '06)
reg_tpi         byte   %9.0g       lregion    Regions used for temporal price index
                                                calculations
spdomain        float  %13.0g      lspdomain
                                              Spatial domains: each with own poverty line
                                                (they are 5)
tpi_trim        float  %9.0g                  TRIMMED Temporal price index (Q4=1)
value_r         float  %9.0g                  
cons_pc_nom     float  %9.0g                  
hhweight        float  %9.0g                  Household sample weight
bswt            float  %9.0g                  bootstrap weights; and all equal to 1 for all
                                                households, as a toolkit requireme
hhsize          long   %9.0g                  number of household menbers
cons_hh_nom     double %9.0g                  (sum) cod_hh_nom
food_pc_nom     float  %9.0g                  nominal food consumption per capita
nf_pc_nom       float  %9.0g                  nominal non-food consumption per capita
food_pc_tpi     float  %9.0g                  Temp-adjusted per capita food consumption/day
cons_pc_tpi     float  %9.0g                  Temp adjusted total consumption/day
pctile_60       float  %9.0g                  (p 50) cons_pc_tpi
bottom_basket   float  %9.0g                  =1 if in bottom (60%) of PCE
hhppkg          float  %9.0g                  
lower5          float  %9.0g                  
upper5          float  %9.0g                  
----------------------------------------------------------------------------------------------
Sorted by:  
     Note:  dataset has changed since last saved

. keep if hhppkg-lower5>=0 & hhppkg-upper5<=0;
(882 observations deleted)

. *********************************************************************
> * Note that we do prices in three ways. First, by summing quantity and value 
> * This average price price_unitw is thus quantity/value weighted. Second, we
> * calculate the price and take simple means for a transaction weighted
> * price, price_unitt. Last we take the median, price_unitm. But in the end
> * we only use price_unitw
> *********************************************************************;
.         gen price_unitt=value_r/(quantity*1000);

.         gen price_unitm=price_unitt;

.                 *CA modified to count the boot sample weight bswt;
.         collapse (sum) quantity value_r count bswt 
>                  (mean) price_unitt 
>                  (median) price_unitm [aw=hhweight], by(spdomain product);

.         *Generate weighted price per gram ;
.         gen price_unitw=value_r/(quantity*1000);

.         drop value_r quantity;

.         sort spdomain product;

.         lab var price_unitt "simple average of calculated prices - transaction weighted";

.         lab var price_unitm "median of prices";

.         lab var price_unitw "value share weighted mean prices";

. * Get an idea of the difference between the price measures;
.         gen ratiotw=price_unitt/price_unitw;

.         gen ratiomw=price_unitm/price_unitw;

.         sum ratiotw ratiomw;

    Variable |       Obs        Mean    Std. Dev.       Min        Max
-------------+--------------------------------------------------------
     ratiotw |       184    1.219561    .3580905   .9057599   3.137953
     ratiomw |       184    1.054696    .2695414   .4358797   2.686314

.         sort product;

.         merge product using "$path/work/codes_food_basket_flex.dta";
variable product does not uniquely identify observations in the master data

.         tab _m;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |          2        1.08        1.08
          3 |        184       98.92      100.00
------------+-----------------------------------
      Total |        186      100.00

.         count if _merge~=3;
    2

.         drop if _merge~=3;
(2 observations deleted)

.         drop _merge;

.         sort product spdomain;

. save "$path/work/price_unit_flex.dta", replace;
file /home/bjvca/data/data/GAP/Haruna/UNPS_2005_06//work/price_unit_flex.dta saved

. ****************************************************************************************
> * 110_price_unit_flex.do                (end)
> ****************************************************************************************;
. cap log close;
