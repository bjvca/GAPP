----------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /home/bjvca/data/data/GAP/Haruna/UNPS_2005_06//rep/130_povmeas_flex.log
  log type:  text
 opened on:  10 Mar 2014, 14:47:27

. clear

. set more off

. #delimit ;
delimiter now ;
. **************************************************************************
> * 130_povmeas_flex.do           (start)
> *
> * Purpose:
> * Initial poverty measures calculation for flexible basket. (Before any iteration)
> **************************************************************************;
. *CA modified to add work/hhdata.dta for bootstrap;
. /*
> This file uses:
>         in/foodshr96.dta
>         work/povline_f_flex.dta
>         work/consump_nom.dta
>         work/hhdata.dta
>         work/temp_index_reg_tpi.dta
> 
> This file creates:
>         work/foodshr96.dta
>         work/povmeas.dta
>         work/povlines.dta
>         work/cons_real.dta
> */
> 
> 
> 
> **************************************************************************;
. * Bring in data file with nominal consumption per capita, and deflate it
> * by temporal price index.
> **************************************************************************;
. use "$path/work/hhdata.dta", clear;

.         keep hhid strata reg_tpi spdomain news rural survmon survquar;

.         tab reg_tpi, miss;

    Regions |
   used for |
   temporal |
price index |
calculation |
          s |      Freq.     Percent        Cum.
------------+-----------------------------------
    Central |      1,024       32.79       32.79
    Eastern |        697       22.32       55.11
   Northern |        695       22.25       77.36
    Western |        703       22.51       99.87
          . |          4        0.13      100.00
------------+-----------------------------------
      Total |      3,123      100.00

.         tab survquar, miss;

   Sequential Survey |
 Quarter (May-Nov'05 |
      & May-Nov '06) |      Freq.     Percent        Cum.
---------------------+-----------------------------------
   May '05 - Jul-'05 |      1,057       33.85       33.85
          Aug-Oct 05 |        941       30.13       63.98
Nov '05 & May-Jun 06 |         60        1.92       65.90
       Jul-Sept 2006 |        818       26.19       92.09
         Oct-Nov '06 |        243        7.78       99.87
                   . |          4        0.13      100.00
---------------------+-----------------------------------
               Total |      3,123      100.00

.         keep hhid spdomain reg_tpi survquar;

.         sort hhid;

.         tempfile spdomainreg_tpi;

. save `spdomainreg_tpi', replace;
(note: file /tmp/St02564.000001 not found)
file /tmp/St02564.000001 saved

. use "$path/work/conpc.dta", clear;

. *use "$path/work/consump_nom.dta", clear;
. *CA modified to merge in work/hhdata.dta for bootstrap;
.     sort hhid;

.     merge hhid using "$path/work/hhdata.dta";

.     tab _m;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          1        0.03        0.03
          3 |      3,123       99.97      100.00
------------+-----------------------------------
      Total |      3,124      100.00

.     drop _m;

.         keep hhid hhweight hhsize cons_pc_nom ;

.         sort hhid;

.         merge hhid using `spdomainreg_tpi';
(label lsurvquar already defined)
(label lregion already defined)
(label lspdomain already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          1        0.03        0.03
          3 |      3,123       99.97      100.00
------------+-----------------------------------
      Total |      3,124      100.00

.         drop _merge;

.         sort reg_tpi survquar;

.         merge reg_tpi survquar using "$path/work/temp_index_reg_tpi.dta";
variables reg_tpi survquar do not uniquely identify observations in the master data
(label lsurvquar already defined)
(label lregion already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |         15        0.48        0.48
          3 |      3,109       99.52      100.00
------------+-----------------------------------
      Total |      3,124      100.00

.         drop _merge;

.         sort hhid;

.         merge hhid using "$path/work/conpc.dta";

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      3,124      100.00      100.00
------------+-----------------------------------
      Total |      3,124      100.00

.         drop _merge;

.         gen food_pc_tpi  = food_pc_nom /tpi_trim;
(15 missing values generated)

.         lab var food_pc_tpi "Temp-adjusted per capita food consumption/day";

.                 gen cons_pc_tpi = food_pc_tpi + nf_pc_nom;
(16 missing values generated)

.         lab var cons_pc_tpi "Temp adjusted total consumption/day";

.         gen one=1;

. * TPI deflated per capita consumption ;
.         tempfile contpi;

. save `contpi', replace;
(note: file /tmp/St02564.000002 not found)
file /tmp/St02564.000002 saved

. **************************************************************************
> * Calculate non-food expenditure for HH around the food poverty line
> *
> * Develop a discrete triangular weighted distribution. This gives a
> * weight of  1 to HH at +/- 18-20% from food poverty line, and
> * weight of  2 to HH at +/- 16-18% from food poverty line, and ...
> * weight of 10 to HH at +/-  0- 2% from food poverty line.
> * This weight is called triwt below.
> **************************************************************************;
. use `contpi';

.         sort spdomain;

.         merge spdomain using "$path/work/povline_food_flex.dta";
variable spdomain does not uniquely identify observations in the master data
(label lspdomain already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          5        0.16        0.16
          3 |      3,119       99.84      100.00
------------+-----------------------------------
      Total |      3,124      100.00

.         drop _merge;

. gen     triwt = 0 ;

. replace triwt = 11 - round(50*abs(cons_pc_tpi/povline_f_flex-1)+0.5)
>                 if abs(cons_pc_tpi/povline_f_flex-1)<=0.2;
(225 real changes made)

.                                         * Nearness to poverty line and population weights ;
.         gen tripopwt=triwt*hhweight*hhsize;
(5 missing values generated)

.         preserve;

.                 collapse (mean) nf_pc_nom [aw=tripopwt] ,
>                         by(spdomain);

.                                         rename nf_pc_nom povline_na_flex;

.                 lab var povline_na_flex "Nonfood poverty line. Flexible bundle";

.                                 tempfile znf;

.                 sort spdomain;

.                 save `znf', replace;
(note: file /tmp/St02564.000004 not found)
file /tmp/St02564.000004 saved

.                 tab spdomain;

      Spatial |
domains: each |
     with own |
 poverty line |
 (they are 5) |      Freq.     Percent        Cum.
--------------+-----------------------------------
Central Urban |          1       20.00       20.00
Central Rural |          1       20.00       40.00
      Eastern |          1       20.00       60.00
     Northern |          1       20.00       80.00
      Western |          1       20.00      100.00
--------------+-----------------------------------
        Total |          5      100.00

.         restore;

.         sort spdomain;

.         merge spdomain using `znf';
variable spdomain does not uniquely identify observations in the master data
(label lspdomain already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          5        0.16        0.16
          3 |      3,119       99.84      100.00
------------+-----------------------------------
      Total |      3,124      100.00

.         drop _merge;

. **************************************************************************;
. * Poverty line is the sum of the food and non-food poverty lines
> **************************************************************************;
.         gen povline_flex=povline_f_flex + povline_na_flex;
(5 missing values generated)

.         lab var povline_flex "Poverty line. Flexible bundle";

.         sort spdomain;

. save "$path/work/povlines.dta", replace;
file /home/bjvca/data/data/GAP/Haruna/UNPS_2005_06//work/povlines.dta saved

. **************************************************************************;
. * Create spatial price index, based on the total poverty line, with
> * adjustment so that mean (and total) nominal consumption equals
> * mean (and total) spatially deflated consumption.
> *
> * Choose arbitrary strata to be the base at first: we just use the first stratum.
> **************************************************************************;
. use `contpi';

.         sort spdomain;

.         merge spdomain using "$path/work/povlines.dta";
variable spdomain does not uniquely identify observations in the master data
variable spdomain does not uniquely identify observations in
    /home/bjvca/data/data/GAP/Haruna/UNPS_2005_06//work/povlines.dta
(label lsurvquar already defined)
(label lregion already defined)
(label lspdomain already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      3,124      100.00      100.00
------------+-----------------------------------
      Total |      3,124      100.00

.         drop _merge;

.         * Real consumption pc, temporally deflated ;
.         gen cr= cons_pc_tpi ;
(16 missing values generated)

.         * Poverty line;
.         gen linpob=povline_flex;
(5 missing values generated)

.         *qui sum linpob if spdomain==1, meanonly;
.         sum linpob if spdomain==3, meanonly;

.         global spi_base=r(mean);

.         * Spatial price index ;
.         gen spi=linpob/$spi_base;
(5 missing values generated)

.         * Real consumption pc, temporally and spatially deflated ;
.         gen cr2=cr/spi;
(16 missing values generated)

.         qui sum cr [aw=hhweight*hhsize];

.         global sumcr=r(sum);

.         qui sum cr2 [aw=hhweight*hhsize];

.         global sumcr2=r(sum);

.         replace spi=spi*$sumcr2/$sumcr;
(3119 real changes made)

.         gen linpobr=linpob/spi;
(5 missing values generated)

.         replace cr2=cr/spi;
(3108 real changes made)

.         sum cr cr2 linpob linpobr [aw=hhweight*hhsize];

    Variable |     Obs      Weight        Mean   Std. Dev.       Min        Max
-------------+-----------------------------------------------------------------
          cr |    3108  28069559.9    1060.929    1055.93   106.8324   23434.67
         cr2 |    3108  28069559.9    1060.929   964.5924   121.2709   20278.26
      linpob |    3119  28164219.1    439.7007   65.93853   314.1105   553.3799
     linpobr |    3119  28164219.1    450.0774   .0000115   450.0774   450.0775

.         lab var cr      "Temporally-adjusted cons pc";

.         lab var cr2     "Spatially & temporally adjusted cons pc";

.         lab var linpob  "Poverty line";

.         lab var linpobr "Real poverty line";

.         lab var spi     "Spatial price index";

. **************************************************************************
> * calculate poverty measures with the flexible food bundle
> **************************************************************************;
.         gen h = 100     if cr <=(linpob);
(2728 missing values generated)

.         replace  h = 0 if cr > (linpob);
(2728 real changes made)

.                         gen             pg      = ((linpob - cr )/linpob) *100;
(16 missing values generated)

.         replace         pg      = 0             if h==0;
(2728 real changes made)

.         gen             spg     = ((( linpob - cr )/ linpob )^2)*100;
(16 missing values generated)

.         replace         spg     = 0             if h==0;
(2728 real changes made)

.         gen h_flex=h;

.         gen pg_flex=pg;
(5 missing values generated)

.         gen spg_flex=spg;
(5 missing values generated)

.         lab var h_flex   "Poverty headcount. Flex bundle";

.         lab var pg_flex  "Poverty gap. Flex bundle";

.         lab var spg_flex "Squared poverty gap. Flex bundle";

.         sort hhid;

.         merge hhid using "$path/work/hhdata.dta";
(label lspdomain already defined)
(label lregion already defined)
(label lsurvquar already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          1        0.03        0.03
          3 |      3,123       99.97      100.00
------------+-----------------------------------
      Total |      3,124      100.00

.         drop if _merge~=3;
(1 observation deleted)

.         drop _merge;

.         gen popwt=hhsize*hhweight;
(4 missing values generated)

.                 * Stata 10.1 syntax ;
.         svyset , clear;

.         svyset [pweight=popwt] , str(strata) psu(psu);

      pweight: popwt
          VCE: linearized
  Single unit: missing
     Strata 1: strata
         SU 1: psu
        FPC 1: <zero>

.         svy: mean h_flex pg_flex spg_flex;
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =       8        Number of obs    =      3119
Number of PSUs   =     321        Population size  =  28164219
                                  Design df        =       313

--------------------------------------------------------------
             |             Linearized
             |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
      h_flex |    15.2935   .9731112      13.37884    17.20817
     pg_flex |   3.344332    .267422       2.81816    3.870504
    spg_flex |   1.133443    .114167      .9088111    1.358075
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(rural);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =       8        Number of obs    =      3119
Number of PSUs   =     321        Population size  =  28164219
                                  Design df        =       313

        Urban: rural = Urban
        Rural: rural = Rural

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
       Urban |    3.49787   .9220902      1.683591    5.312149
       Rural |   17.75513       1.15      15.49242    20.01783
-------------+------------------------------------------------
pg_flex      |
       Urban |   .6972157    .221734      .2609381    1.133493
       Rural |   3.896757   .3170604      3.272918    4.520597
-------------+------------------------------------------------
spg_flex     |
       Urban |   .2591101   .1154087       .032035    .4861851
       Rural |   1.315907    .134715      1.050845    1.580968
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(news);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =       8        Number of obs    =      3119
Number of PSUs   =     321        Population size  =  28164219
                                  Design df        =       313

      Central: news = Central
      Eastern: news = Eastern
     Northern: news = Northern
      Western: news = Western

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
     Central |   8.300454   1.307511      5.727831    10.87308
     Eastern |   19.46877   1.956764      15.61869    23.31884
    Northern |   20.48259   2.725485         15.12    25.84518
     Western |   16.40297   1.984944      12.49745    20.30849
-------------+------------------------------------------------
pg_flex      |
     Central |   1.718851   .3296987      1.070145    2.367557
     Eastern |     4.0511    .522677      3.022696    5.079505
    Northern |   5.077992   .8763631      3.353685      6.8023
     Western |   3.508019   .5252969      2.474459    4.541578
-------------+------------------------------------------------
spg_flex     |
     Central |    .544989   .1404603      .2686232    .8213547
     Eastern |   1.349988   .2284443      .9005072    1.799468
    Northern |   1.749897   .3554885      1.050448    2.449346
     Western |    1.23619   .2350781      .7736573    1.698724
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(reg_tpi);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =       8        Number of obs    =      3119
Number of PSUs   =     321        Population size  =  28164219
                                  Design df        =       313

      Central: reg_tpi = Central
      Eastern: reg_tpi = Eastern
     Northern: reg_tpi = Northern
      Western: reg_tpi = Western

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
     Central |   8.300454   1.307511      5.727831    10.87308
     Eastern |   19.46877   1.956764      15.61869    23.31884
    Northern |   20.48259   2.725485         15.12    25.84518
     Western |   16.40297   1.984944      12.49745    20.30849
-------------+------------------------------------------------
pg_flex      |
     Central |   1.718851   .3296987      1.070145    2.367557
     Eastern |     4.0511    .522677      3.022696    5.079505
    Northern |   5.077992   .8763631      3.353685      6.8023
     Western |   3.508019   .5252969      2.474459    4.541578
-------------+------------------------------------------------
spg_flex     |
     Central |    .544989   .1404603      .2686232    .8213547
     Eastern |   1.349988   .2284443      .9005072    1.799468
    Northern |   1.749897   .3554885      1.050448    2.449346
     Western |    1.23619   .2350781      .7736573    1.698724
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(strata);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =       8        Number of obs    =      3119
Number of PSUs   =     321        Population size  =  28164219
                                  Design df        =       313

    _subpop_1: strata = central urban
    _subpop_2: strata = central rural
    _subpop_3: strata = Eastern urban
    _subpop_4: strata = Eastern rural
    _subpop_5: strata = Northern urban
    _subpop_6: strata = Northern rural
    _subpop_7: strata = Western Urban
    _subpop_8: strata = Western rural

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
   _subpop_1 |   2.067417   1.009692      .0807763    4.054058
   _subpop_2 |   11.83287   2.005974      7.885974    15.77977
   _subpop_3 |   4.500134   1.885657      .7899681      8.2103
   _subpop_4 |   20.65156   2.096198      16.52714    24.77598
   _subpop_5 |   9.623426   4.111047      1.534644    17.71221
   _subpop_6 |   22.25124   3.087229      16.17689    28.32558
   _subpop_7 |    3.43429   1.887055     -.2786256    7.147206
   _subpop_8 |   17.24875   2.104325      13.10834    21.38916
-------------+------------------------------------------------
pg_flex      |
   _subpop_1 |   .4322447   .2277505     -.0158709    .8803603
   _subpop_2 |   2.448003    .504024        1.4563    3.439707
   _subpop_3 |   .6200867   .3669826      -.101978    1.342151
   _subpop_4 |   4.322212   .5621175      3.216205    5.428218
   _subpop_5 |   2.161993   1.117685      -.037132    4.361118
   _subpop_6 |   5.552926   1.000756      3.583867    7.521986
   _subpop_7 |   .4921216   .3535844     -.2035812    1.187824
   _subpop_8 |   3.704706   .5561841      2.610374    4.799038
-------------+------------------------------------------------
spg_flex     |
   _subpop_1 |   .1836988   .1344806     -.0809014     .448299
   _subpop_2 |   .7497412    .206323      .3437857    1.155697
   _subpop_3 |   .1175462   .0900193     -.0595733    .2946657
   _subpop_4 |   1.447373    .246093      .9631672    1.931578
   _subpop_5 |   .7994442   .5211737     -.2260026    1.824891
   _subpop_6 |   1.904699   .4036793      1.110431    2.698967
   _subpop_7 |    .152026   .1384592     -.1204025    .4244545
   _subpop_8 |   1.306896   .2489831       .817004    1.796788
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(spdomain);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =       8        Number of obs    =      3119
Number of PSUs   =     321        Population size  =  28164219
                                  Design df        =       313

    _subpop_1: spdomain = Central Urban
    _subpop_2: spdomain = Central Rural
      Eastern: spdomain = Eastern
     Northern: spdomain = Northern
      Western: spdomain = Western

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
   _subpop_1 |   2.067417   1.009692      .0807763    4.054058
   _subpop_2 |   11.83287   2.005974      7.885974    15.77977
     Eastern |   19.46877   1.956764      15.61869    23.31884
    Northern |   20.48259   2.725485         15.12    25.84518
     Western |   16.40297   1.984944      12.49745    20.30849
-------------+------------------------------------------------
pg_flex      |
   _subpop_1 |   .4322447   .2277505     -.0158709    .8803603
   _subpop_2 |   2.448003    .504024        1.4563    3.439707
     Eastern |     4.0511    .522677      3.022696    5.079505
    Northern |   5.077992   .8763631      3.353685      6.8023
     Western |   3.508019   .5252969      2.474459    4.541578
-------------+------------------------------------------------
spg_flex     |
   _subpop_1 |   .1836988   .1344806     -.0809014     .448299
   _subpop_2 |   .7497412    .206323      .3437857    1.155697
     Eastern |   1.349988   .2284443      .9005072    1.799468
    Northern |   1.749897   .3554885      1.050448    2.449346
     Western |    1.23619   .2350781      .7736573    1.698724
--------------------------------------------------------------

.         compress;
hhsize was long now byte
survquar was float now byte
spdomain was float now byte
one was float now byte
triwt was float now byte
h was float now byte
h_flex was float now byte
survmon was float now byte
strata was float now byte
rural was float now byte
news was float now byte
bswt was float now byte

.         sort hhid;

. save "$path/work/cons_real.dta" , replace;
file /home/bjvca/data/data/GAP/Haruna/UNPS_2005_06//work/cons_real.dta saved

.         collapse  (mean) h_flex pg_flex spg_flex [aw=hhweight*hhsize];

. save "$path/work/povmeas.dta", replace;
file /home/bjvca/data/data/GAP/Haruna/UNPS_2005_06//work/povmeas.dta saved

. *** HARUNA, the file Povmeas.dta gives the headcount poverty rates using flexible food bundl
> e without inflicting reveales preferences
> *** therefore specifications in line 226 of this do file have been changed repeatedly to gen
> erate these counts for particular
> *** classifications of interest including strata spdomain region urban/rural (urban) and nat
> ional (done by removing the by command 
> **************************************************************************
> * 130_povmeas_flex.do           (end)
> **************************************************************************;
. log close;
      name:  <unnamed>
       log:  /home/bjvca/data/data/GAP/Haruna/UNPS_2005_06//rep/130_povmeas_flex.log
  log type:  text
 closed on:  10 Mar 2014, 14:47:27
----------------------------------------------------------------------------------------------
