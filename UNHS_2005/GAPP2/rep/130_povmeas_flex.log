--------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /home/bjvca/data/data/GAP/Haruna/UNHS_2005/GAPP2//rep/130_povmeas_flex.log
  log type:  text
 opened on:   2 Jul 2013, 11:24:46

. clear

. set more off

. #delimit ;
delimiter now ;
. **************************************************************************
> * 130_povmeas_flex.do           (start)
> *
> * Purpose:
> * Initial poverty measures calculation for flexible basket. (Before any iteration)
> **************************************************************************;
. *CA modified to add work/hhdata.dta for bootstrap;
. /*
> This file uses:
>         in/foodshr96.dta
>         work/povline_f_flex.dta
>         work/consump_nom.dta
>         work/hhdata.dta
>         work/temp_index_reg_tpi.dta
> 
> This file creates:
>         work/foodshr96.dta
>         work/povmeas.dta
>         work/povlines.dta
>         work/cons_real.dta
> */
> 
> 
> 
> **************************************************************************;
. * Bring in data file with nominal consumption per capita, and deflate it
> * by temporal price index.
> **************************************************************************;
. use "$path/work/hhdata.dta", clear;

.         keep hhid strata reg_tpi spdomain news rural survmon survquar;

.         tab reg_tpi, miss;

    Regions |
   used for |
   temporal |
price index |
calculation |
          s |      Freq.     Percent        Cum.
------------+-----------------------------------
    Central |      2,100       28.28       28.28
    Eastern |      1,932       26.02       54.30
   Northern |      1,624       21.87       76.16
    Western |      1,770       23.84      100.00
------------+-----------------------------------
      Total |      7,426      100.00

.         tab survquar, miss;

  Sequential |
      Survey |
     Quarter |
    (May-Jul |
       05=1) |      Freq.     Percent        Cum.
-------------+-----------------------------------
  May-Jul 05 |      1,573       21.18       21.18
 Sept-Oct 05 |      2,280       30.70       51.89
 Nov05-Jan06 |      1,787       24.06       75.95
Feb-Apr 2006 |      1,786       24.05      100.00
-------------+-----------------------------------
       Total |      7,426      100.00

.         keep hhid spdomain reg_tpi survquar;

.         sort hhid;

.         tempfile spdomainreg_tpi;

. save `spdomainreg_tpi', replace;
(note: file /tmp/St03872.000001 not found)
file /tmp/St03872.000001 saved

. use "$path/work/conpc.dta", clear;

. *use "$path/work/consump_nom.dta", clear;
. *CA modified to merge in work/hhdata.dta for bootstrap;
.     sort hhid;

.     merge hhid using "$path/work/hhdata.dta";

.     tab _m;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          1        0.01        0.01
          3 |      7,426       99.99      100.00
------------+-----------------------------------
      Total |      7,427      100.00

.     drop _m;

.         keep hhid hhweight hhsize cons_pc_nom ;

.         sort hhid;

.         merge hhid using `spdomainreg_tpi';
(label region already defined)
(label lsurvquar already defined)
(label lspdomain already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          1        0.01        0.01
          3 |      7,426       99.99      100.00
------------+-----------------------------------
      Total |      7,427      100.00

.         drop _merge;

.         sort reg_tpi survquar;

.         merge reg_tpi survquar using "$path/work/temp_index_reg_tpi.dta";
variables reg_tpi survquar do not uniquely identify observations in the master data
(label lsurvquar already defined)
(label region already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          1        0.01        0.01
          3 |      7,426       99.99      100.00
------------+-----------------------------------
      Total |      7,427      100.00

.         drop _merge;

.         sort hhid;

.         merge hhid using "$path/work/conpc.dta";

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      7,427      100.00      100.00
------------+-----------------------------------
      Total |      7,427      100.00

.         drop _merge;

.         gen food_pc_tpi  = food_pc_nom /tpi_trim;
(12 missing values generated)

.         lab var food_pc_tpi "Temp-adjusted per capita food consumption/day";

.                 gen cons_pc_tpi = food_pc_tpi + nf_pc_nom;
(13 missing values generated)

.         lab var cons_pc_tpi "Temp adjusted total consumption/day";

.         gen one=1;

. * TPI deflated per capita consumption ;
.         tempfile contpi;

. save `contpi', replace;
(note: file /tmp/St03872.000002 not found)
file /tmp/St03872.000002 saved

. **************************************************************************
> * Calculate non-food expenditure for HH around the food poverty line
> *
> * Develop a discrete triangular weighted distribution. This gives a
> * weight of  1 to HH at +/- 18-20% from food poverty line, and
> * weight of  2 to HH at +/- 16-18% from food poverty line, and ...
> * weight of 10 to HH at +/-  0- 2% from food poverty line.
> * This weight is called triwt below.
> **************************************************************************;
. use `contpi';

.         sort spdomain;

.         merge spdomain using "$path/work/povline_food_flex.dta";
variable spdomain does not uniquely identify observations in the master data
(label lspdomain already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          1        0.01        0.01
          3 |      7,426       99.99      100.00
------------+-----------------------------------
      Total |      7,427      100.00

.         drop _merge;

. gen     triwt = 0 ;

. replace triwt = 10 - round(abs(cons_pc_tpi/povline_f_flex-1))
>                 if abs(cons_pc_tpi/povline_f_flex-1)<=10;
(6346 real changes made)

.                                         * Nearness to poverty line and population weights 
> ;
.         gen tripopwt=triwt*hhweight*hhsize;
(12 missing values generated)

.         preserve;

.                 collapse (mean) nf_pc_nom [aw=tripopwt] ,
>                         by(spdomain);

.                                         rename nf_pc_nom povline_na_flex;

.                 lab var povline_na_flex "Nonfood poverty line. Flexible bundle";

.                                 tempfile znf;

.                 sort spdomain;

.                 save `znf', replace;
(note: file /tmp/St03872.000004 not found)
file /tmp/St03872.000004 saved

.                 tab spdomain;

       Spatial |
 domains: each |
      with own |
  poverty line |
  (they are 9) |      Freq.     Percent        Cum.
---------------+-----------------------------------
       Kampala |          1       11.11       11.11
 Central urban |          1       11.11       22.22
 Central rural |          1       11.11       33.33
 Eastern urban |          1       11.11       44.44
 Eastern rural |          1       11.11       55.56
Northern urban |          1       11.11       66.67
Northern rural |          1       11.11       77.78
 Western urban |          1       11.11       88.89
 Western rural |          1       11.11      100.00
---------------+-----------------------------------
         Total |          9      100.00

.         restore;

.         sort spdomain;

.         merge spdomain using `znf';
variable spdomain does not uniquely identify observations in the master data
(label lspdomain already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          1        0.01        0.01
          3 |      7,426       99.99      100.00
------------+-----------------------------------
      Total |      7,427      100.00

.         drop _merge;

. **************************************************************************;
. * Poverty line is the sum of the food and non-food poverty lines
> **************************************************************************;
.         gen povline_flex= povline_f_flex+ povline_na_flex;
(1 missing value generated)

.         lab var povline_flex "Poverty line. Flexible bundle";

.         sort spdomain;

. save "$path/work/povlines.dta", replace;
file /home/bjvca/data/data/GAP/Haruna/UNHS_2005/GAPP2//work/povlines.dta saved

. **************************************************************************;
. * Create spatial price index, based on the total poverty line, with
> * adjustment so that mean (and total) nominal consumption equals
> * mean (and total) spatially deflated consumption.
> *
> * Choose arbitrary strata to be the base at first: we just use the first stratum.
> **************************************************************************;
. use `contpi';

.         sort spdomain;

.         merge spdomain using "$path/work/povlines.dta";
variable spdomain does not uniquely identify observations in the master data
variable spdomain does not uniquely identify observations in
    /home/bjvca/data/data/GAP/Haruna/UNHS_2005/GAPP2//work/povlines.dta
(label region already defined)
(label lsurvquar already defined)
(label lspdomain already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |      7,427      100.00      100.00
------------+-----------------------------------
      Total |      7,427      100.00

.         drop _merge;

.         * Real consumption pc, temporally deflated ;
.         gen cr= cons_pc_tpi ;
(13 missing values generated)

.         * Poverty line;
.         gen linpob=povline_flex;
(1 missing value generated)

.         *qui sum linpob if spdomain==1, meanonly;
.         sum linpob if spdomain==3, meanonly;

.         global spi_base=r(mean);

.         * Spatial price index ;
.         gen spi=linpob/$spi_base;
(1 missing value generated)

.         * Real consumption pc, temporally and spatially deflated ;
.         gen cr2=cr/spi;
(13 missing values generated)

.         qui sum cr [aw=hhweight*hhsize];

.         global sumcr=r(sum);

.         qui sum cr2 [aw=hhweight*hhsize];

.         global sumcr2=r(sum);

.         replace spi=spi*$sumcr2/$sumcr;
(7426 real changes made)

.         gen linpobr=linpob/spi;
(1 missing value generated)

.         replace cr2=cr/spi;
(7414 real changes made)

.         sum cr cr2 linpob linpobr [aw=hhweight*hhsize];

    Variable |     Obs      Weight        Mean   Std. Dev.       Min        Max
-------------+-----------------------------------------------------------------
          cr |    7414  30109848.2    1106.447   1372.576   61.85136   113681.6
         cr2 |    7414  30109848.2    1106.447   1060.586   65.04339   62542.01
      linpob |    7415  30112959.1    525.3756   192.8018   211.2966   939.6726
     linpobr |    7415  30112959.1    516.9616   .0000172   516.9616   516.9617

.         lab var cr      "Temporally-adjusted cons pc";

.         lab var cr2     "Spatially & temporally adjusted cons pc";

.         lab var linpob  "Poverty line";

.         lab var linpobr "Real poverty line";

.         lab var spi     "Spatial price index";

. **************************************************************************
> * calculate poverty measures with the flexible food bundle
> **************************************************************************;
.         gen h = 100     if cr <=(linpob);
(6213 missing values generated)

.         replace  h = 0 if cr > (linpob);
(6213 real changes made)

.                         gen             pg      = ((linpob - cr )/linpob) *100;
(13 missing values generated)

.         replace         pg      = 0             if h==0;
(6213 real changes made)

.         gen             spg     = ((( linpob - cr )/ linpob )^2)*100;
(13 missing values generated)

.         replace         spg     = 0             if h==0;
(6213 real changes made)

.         gen h_flex=h;

.         gen pg_flex=pg;
(1 missing value generated)

.         gen spg_flex=spg;
(1 missing value generated)

.         lab var h_flex   "Poverty headcount. Flex bundle";

.         lab var pg_flex  "Poverty gap. Flex bundle";

.         lab var spg_flex "Squared poverty gap. Flex bundle";

.         sort hhid;

.         merge hhid using "$path/work/hhdata.dta";
(label lspdomain already defined)
(label lsurvquar already defined)
(label region already defined)

.         tab _merge;

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |          1        0.01        0.01
          3 |      7,426       99.99      100.00
------------+-----------------------------------
      Total |      7,427      100.00

.         drop if _merge~=3;
(1 observation deleted)

.         drop _merge;

.         gen popwt=hhsize*hhweight;
(11 missing values generated)

.                 * Stata 10.1 syntax ;
.         svyset , clear;

.         svyset [pweight=popwt] , str(strata) psu(psu);

      pweight: popwt
          VCE: linearized
  Single unit: missing
     Strata 1: strata
         SU 1: psu
        FPC 1: <zero>

.         svy: mean h_flex pg_flex spg_flex;
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10        Number of obs    =      7415
Number of PSUs   =     305        Population size  =  30112959
                                  Design df        =       295

--------------------------------------------------------------
             |             Linearized
             |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
      h_flex |   19.15985   .8137009      17.55846    20.76124
     pg_flex |   5.083103   .2744359      4.543003    5.623203
    spg_flex |   1.961858   .1359295      1.694344    2.229373
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(rural);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10        Number of obs    =      7415
Number of PSUs   =     305        Population size  =  30112959
                                  Design df        =       295

        Urban: rural = Urban
        Rural: rural = Rural

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
       Urban |   10.77073   1.700542      7.423996    14.11746
       Rural |   20.73667   .9599145      18.84752    22.62582
-------------+------------------------------------------------
pg_flex      |
       Urban |    2.45784   .4625084      1.547605    3.368074
       Rural |   5.576546   .3207487      4.945301    6.207792
-------------+------------------------------------------------
spg_flex     |
       Urban |   .9432136   .2094607       .530987     1.35544
       Rural |   2.153322    .158126      1.842124     2.46452
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(news);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10        Number of obs    =      7415
Number of PSUs   =     305        Population size  =  30112959
                                  Design df        =       295

      Central: news = Central
      Eastern: news = Eastern
     Northern: news = Northern
      Western: news = Western

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
     Central |   19.56005    1.33434      16.93402    22.18609
     Eastern |   12.75834    1.02332      10.74441    14.77228
    Northern |   6.810286   1.021149      4.800626    8.819946
     Western |   34.31341   1.917125      30.54044    38.08639
-------------+------------------------------------------------
pg_flex      |
     Central |   5.045907   .3932164      4.272042    5.819772
     Eastern |   2.936532   .2831757      2.379231    3.493832
    Northern |   1.205418   .2666613      .6806179    1.730217
     Western |   10.16501     .75308      8.682918     11.6471
-------------+------------------------------------------------
spg_flex     |
     Central |   1.882923   .1887241      1.511507     2.25434
     Eastern |   .9994006   .1306685      .7422399    1.256561
    Northern |   .3466925   .0896767      .1702054    .5231795
     Western |   4.219604   .4069678      3.418676    5.020532
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(reg_tpi);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10        Number of obs    =      7415
Number of PSUs   =     305        Population size  =  30112959
                                  Design df        =       295

      Central: reg_tpi = Central
      Eastern: reg_tpi = Eastern
     Northern: reg_tpi = Northern
      Western: reg_tpi = Western

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
     Central |   19.56005    1.33434      16.93402    22.18609
     Eastern |   12.75834    1.02332      10.74441    14.77228
    Northern |   6.810286   1.021149      4.800626    8.819946
     Western |   34.31341   1.917125      30.54044    38.08639
-------------+------------------------------------------------
pg_flex      |
     Central |   5.045907   .3932164      4.272042    5.819772
     Eastern |   2.936532   .2831757      2.379231    3.493832
    Northern |   1.205418   .2666613      .6806179    1.730217
     Western |   10.16501     .75308      8.682918     11.6471
-------------+------------------------------------------------
spg_flex     |
     Central |   1.882923   .1887241      1.511507     2.25434
     Eastern |   .9994006   .1306685      .7422399    1.256561
    Northern |   .3466925   .0896767      .1702054    .5231795
     Western |   4.219604   .4069678      3.418676    5.020532
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(strata);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10        Number of obs    =      7415
Number of PSUs   =     305        Population size  =  30112959
                                  Design df        =       295

      Kampala: strata = Kampala
    _subpop_2: strata = Central 1
    _subpop_3: strata = Central 2
    _subpop_4: strata = East Central
      Eastern: strata = Eastern
    _subpop_6: strata = Mid Northern
    _subpop_7: strata = North East
    _subpop_8: strata = West Nile
    _subpop_9: strata = Mid Western
   _subpop_10: strata = South Western

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
     Kampala |   6.755677   2.283721      2.261227    11.25013
   _subpop_2 |     21.389   2.081124      17.29327    25.48473
   _subpop_3 |   23.86218    2.12623      19.67767    28.04668
   _subpop_4 |   9.712066   1.024256      7.696291    11.72784
     Eastern |   14.81371   1.933077      11.00934    18.61808
   _subpop_6 |   6.095805   1.357324       3.42454    8.767069
   _subpop_7 |   22.64042   3.896613      14.97173     30.3091
   _subpop_8 |   3.388888   .9286716      1.561227    5.216549
   _subpop_9 |   33.85809   2.075258       29.7739    37.94227
  _subpop_10 |   34.60163   2.833145      29.02589    40.17736
-------------+------------------------------------------------
pg_flex      |
     Kampala |   1.398105    .559341      .2973002    2.498909
   _subpop_2 |    5.38012   .5683856      4.261516    6.498725
   _subpop_3 |    6.44948   .6938391      5.083978    7.814982
   _subpop_4 |   2.514863   .2920984      1.940002    3.089724
     Eastern |   3.054056   .5800399      1.912516    4.195597
   _subpop_6 |   1.026244   .3633758      .3111064    1.741381
   _subpop_7 |   4.856248   .8063281      3.269364    6.443133
   _subpop_8 |   .5968763   .2434057      .1178446    1.075908
   _subpop_9 |   10.11747   1.078984       7.99399    12.24095
  _subpop_10 |    10.1951   1.021933      8.183894     12.2063
-------------+------------------------------------------------
spg_flex     |
     Kampala |   .5695804   .3208634      -.061891    1.201052
   _subpop_2 |   1.915518   .2770826      1.370209    2.460827
   _subpop_3 |   2.471827   .3198159      1.842418    3.101237
   _subpop_4 |    .911258   .1593991      .5975546    1.224961
     Eastern |   .9856796   .2616396       .470763    1.500596
   _subpop_6 |   .2867959   .1198723      .0508826    .5227093
   _subpop_7 |   1.461253   .2296092      1.009373    1.913133
   _subpop_8 |   .2308888   .1201629     -.0055965     .467374
   _subpop_9 |   4.278137   .6990729      2.902335    5.653939
  _subpop_10 |   4.182553   .4967102      3.205008    5.160097
--------------------------------------------------------------

.         svy: mean h_flex pg_flex spg_flex , over(spdomain);
(running mean on estimation sample)

Survey: Mean estimation

Number of strata =      10        Number of obs    =      7415
Number of PSUs   =     305        Population size  =  30112959
                                  Design df        =       295

      Kampala: spdomain = Kampala
    _subpop_2: spdomain = Central urban
    _subpop_3: spdomain = Central rural
    _subpop_4: spdomain = Eastern urban
    _subpop_5: spdomain = Eastern rural
    _subpop_6: spdomain = Northern urban
    _subpop_7: spdomain = Northern rural
    _subpop_8: spdomain = Western urban
    _subpop_9: spdomain = Western rural

--------------------------------------------------------------
             |             Linearized
        Over |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
h_flex       |
     Kampala |   6.755677   2.283721      2.261227    11.25013
   _subpop_2 |   12.99763   5.455453      2.261093    23.73417
   _subpop_3 |   24.06187   1.834473      20.45155    27.67218
   _subpop_4 |   6.868955   2.214819      2.510107     11.2278
   _subpop_5 |     13.269    1.09823      11.10764    15.43036
   _subpop_6 |   6.822285   2.329473      2.237793    11.40678
   _subpop_7 |   6.808166   1.185262      4.475526    9.140806
   _subpop_8 |   28.42744   2.473663      23.55918    33.29571
   _subpop_9 |   34.82019   2.058382      30.76922    38.87117
-------------+------------------------------------------------
pg_flex      |
     Kampala |   1.398105    .559341      .2973002    2.498909
   _subpop_2 |   2.647459   1.517204     -.3384571    5.633375
   _subpop_3 |   6.405422   .5130507      5.395718    7.415125
   _subpop_4 |    1.19704   .4386848      .3336917    2.060388
   _subpop_5 |   3.087359   .3026596      2.491713    3.683004
   _subpop_6 |    1.22466   .5634538       .115761    2.333558
   _subpop_7 |   1.202018    .305846       .600102    1.803935
   _subpop_8 |   8.219413   .9186631      6.411448    10.02738
   _subpop_9 |   10.33252   .8087562       8.74086    11.92419
-------------+------------------------------------------------
spg_flex     |
     Kampala |   .5695804   .3208634      -.061891    1.201052
   _subpop_2 |    .978903   .6300503     -.2610601    2.218866
   _subpop_3 |   2.378294   .2380008      1.909899    2.846689
   _subpop_4 |   .3354237   .1437849      .0524495    .6183979
   _subpop_5 |   1.056972    .140228      .7809985    1.332946
   _subpop_6 |   .3815092   .2119409     -.0355986     .798617
   _subpop_7 |   .3405422   .1002873      .1431729    .5379114
   _subpop_8 |   3.364479   .4693561      2.440768     4.28819
   _subpop_9 |    4.29323   .4373673      3.432474    5.153986
--------------------------------------------------------------

.         compress;
survquar was float now byte
reg_tpi was float now byte
spdomain was float now byte
one was float now byte
triwt was float now byte
h was float now byte
h_flex was float now byte
region was float now byte
psu was int now byte
survmon was float now byte
strata was float now byte
rural was float now byte
news was float now byte
bswt was float now byte

.         sort hhid;

. save "$path/work/cons_real.dta" , replace;
file /home/bjvca/data/data/GAP/Haruna/UNHS_2005/GAPP2//work/cons_real.dta saved

.         collapse  (mean) h_flex pg_flex spg_flex [aw=hhweight*hhsize];

. save "$path/work/povmeas.dta", replace;
file /home/bjvca/data/data/GAP/Haruna/UNHS_2005/GAPP2//work/povmeas.dta saved

. *** HARUNA, the file Povmeas.dta gives the headcount poverty rates using flexible food bun
> dle without inflicting reveales preferences
> *** therefore specifications in line 226 of this do file have been changed repeatedly to g
> enerate these counts for particular
> *** classifications of interest including strata spdomain region urban/rural (urban) and n
> ational (done by removing the by command 
> **************************************************************************
> * 130_povmeas_flex.do           (end)
> **************************************************************************;
. log close;
      name:  <unnamed>
       log:  /home/bjvca/data/data/GAP/Haruna/UNHS_2005/GAPP2//rep/130_povmeas_flex.log
  log type:  text
 closed on:   2 Jul 2013, 11:24:46
--------------------------------------------------------------------------------------------
